<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Habit (v3.7)</title>

    <!-- PWA 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3f4f6">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/task.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/32/task.png">

    <style>
        /* ================== CSS 变量定义 ================== */
        :root {
            /* ☀️ 日间模式 */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --header-bg: rgba(255, 255, 255, 0.95);

            /* 功能色 */
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --info: #3b82f6;

            /* 时间银行色 (Indigo/Purple) */
            --time: #6366f1;
            --time-bg: #e0e7ff;

            /* 阴影与边距 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* 🌙 夜间模式 */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --input-bg: #111827;
            --header-bg: rgba(17, 24, 39, 0.95);

            --success: #34d399;
            --success-bg: rgba(6, 78, 59, 0.4);
            --warning: #fbbf24;
            --warning-bg: rgba(69, 26, 3, 0.4);
            --danger: #f87171;
            --danger-bg: rgba(69, 10, 10, 0.4);

            --time: #818cf8;
            --time-bg: rgba(67, 56, 202, 0.4);

            --shadow: none;
        }

        /* ================== 基础样式 ================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: calc(90px + var(--safe-area-bottom));
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header-bg); backdrop-filter: blur(10px);
            padding: 12px 16px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            height: 60px;
        }

        /* Sticky Notification Bar */
        .sticky-notif-bar {
            position: sticky;
            top: 60px;
            z-index: 999;
            background: var(--header-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 4px;
            padding: 8px 16px;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .notif-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 8px;
        }
        .notif-timer { background: var(--success-bg); color: var(--success); border: 1px solid rgba(52, 211, 153, 0.2); }
        .notif-pinned { background: var(--time-bg); color: var(--time); border: 1px solid rgba(129, 140, 248, 0.2); }
        .notif-btn { font-size: 12px; cursor: pointer; opacity: 0.8; }
        .notif-btn:hover { opacity: 1; }

        .header-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0;}
        .header-title h1 {
            margin: 0; font-size: 18px; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, #a855f7 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .sync-badge {
            font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px;
            opacity: 0.9; color: var(--text-sub); background: var(--input-bg);
            padding: 4px 8px; border-radius: 12px; border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s;
        }
        .sync-badge:active { transform: scale(0.95); background: var(--border); }
        .sync-icon { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; }
        .status-idle .sync-icon { background: var(--success); }
        .status-syncing .sync-icon { background: transparent; border: 2px solid var(--info); border-top-color: transparent; width: 10px; height: 10px; animation: spin 0.8s linear infinite; }
        .status-error .sync-icon { background: var(--danger); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
        }
        .theme-btn {
            background: none; border: 1px solid var(--border); font-size: 14px;
            cursor: pointer; padding: 0; width: 28px; height: 28px;
            border-radius: 50%; transition: all 0.3s; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .fund-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 4px;
            white-space: nowrap; flex-shrink: 0; height: 28px; cursor: pointer;
        }
        .badge-wallet { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--border); }
        .badge-debt { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--border); }
        .badge-time { background: var(--time-bg); color: var(--time); border: 1px solid var(--border); }

        .container { max-width: 500px; margin: 20px auto; padding: 0 16px; position: relative; z-index: 1; }
        .card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .card-title { font-size: 16px; font-weight: 800; margin-bottom: 20px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }

        .toggle-container { display: flex; background: var(--border); padding: 4px; border-radius: 14px; margin-bottom: 20px; }
        .toggle-btn { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 700; color: var(--text-sub); border-radius: 12px; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .week-btn {
            padding: 10px 16px; border-radius: 10px; background: var(--input-bg);
            border: 1px solid var(--border); color: var(--text-sub);
            font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .week-btn.active {
            background: var(--info); color: #fff; border-color: var(--info);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .input-group { margin-bottom: 16px; }
        .input-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-sub); margin-bottom: 8px; font-weight: 600;}
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        input, select, textarea {
            width: 100%; padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-main);
            font-weight: 600;
            outline: none; -webkit-appearance: none;
            font-family: inherit;
        }
        textarea { resize: vertical; min-height: 40px; }
        input:focus, textarea:focus { border-color: var(--primary); }

        button { user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-calc {
            width: 100%; padding: 16px; border: none;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; font-size: 16px; font-weight: 700;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            margin-top: 12px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        [data-theme="dark"] .btn-calc { box-shadow: none; }

        .btn-secondary { background: var(--border); color: var(--text-sub); box-shadow: none; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3); }
        .btn-mini { width: auto; padding: 8px 16px; font-size: 13px; margin-top: 0; border-radius: 10px;}
        .btn-prevent { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; box-shadow:none;}
        [data-theme="dark"] .btn-prevent { background: rgba(55, 48, 163, 0.4); color: #818cf8; border-color: #4338ca; }

        .list-item {
            padding: 16px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
            background: var(--input-bg);
            border-radius: 12px;
            margin-bottom: 12px;
        }
        .list-item:last-child { margin-bottom: 0; }
        
        /* Inline Editor Styles */
        .inline-editor {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .inline-editor .input-group { margin-bottom: 12px; }
        .inline-editor .input-label { font-size: 11px; margin-bottom: 4px; }
        .inline-editor input, .inline-editor textarea { 
            padding: 10px; border-radius: 8px; font-size: 14px; 
            border-width: 1px;
        }

        .btn-action {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sub); margin-left: 4px;
            background: var(--input-bg); transition: all 0.2s;
            font-size: 14px; font-weight: bold; border: 1px solid transparent; flex-shrink: 0;
        }
        .btn-action:hover { background: var(--border); }
        .btn-edit:hover { background: var(--info); color: #fff; }
        .btn-del:hover { background: var(--danger-bg); color: var(--danger); border-color: var(--danger); }

        .btn-nuke {
            font-size: 11px;
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
        }

        .privacy-check-label {
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--text-sub); margin-top: 12px;
            cursor: pointer; padding: 12px; background: var(--input-bg);
            border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.2s; user-select: none;
        }
        .privacy-check-label:active { transform: scale(0.98); }
        .privacy-check-label.checked { border-color: var(--warning); background: var(--warning-bg); color: var(--warning); font-weight: bold; }
        .privacy-check-label input { display: none; }
        .privacy-check-label::before { content: '🔓'; margin-right: 8px; font-size: 14px; }
        .privacy-check-label.checked::before { content: '🔒'; }

        .todo-section-title { font-size: 12px; font-weight: 800; color: var(--text-sub); margin: 25px 0 10px 4px; text-transform: uppercase; letter-spacing: 0.5px; display: none; align-items: center;}
        .todo-section-title.show { display: flex; }

        .todo-item {
            padding: 12px; border: 1px solid var(--border);
            border-radius: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); transition: all 0.3s ease; position: relative;
        }
        .todo-do { border-left: 4px solid var(--success); }
        .todo-dont { border-left: 4px solid var(--danger); }
        .todo-other { border-left: 4px solid var(--info); }

        .todo-expired-item { opacity: 0.6; background: var(--border); filter: grayscale(1); }

        .todo-check { width: 32px; height: 32px; border-radius: 50%; border: 2px solid #d1d5db; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--success); font-weight:bold;}
        .click-anim { animation: press 0.3s ease-out; }
        @keyframes press { 0% { transform: scale(1); } 50% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* 悬浮菜单 */
        .action-menu {
            position: absolute;
            right: 46px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 4px 8px;
            display: none;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 20;
            animation: fadeIn 0.2s ease;
        }
        .action-menu.show { display: flex; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(10px, -50%); } to { opacity: 1; transform: translate(0, -50%); } }

        .action-menu-dropdown {
            flex-direction: column !important;
            border-radius: 12px !important;
            padding: 8px !important;
            min-width: 140px;
            gap: 4px !important;
            right: 0 !important;
            top: 40px !important;
            transform: none !important;
            align-items: stretch !important;
        }

        .review-history-item {
            border-bottom: 1px dashed var(--border);
            padding: 12px 0;
        }
        .review-history-item:last-child { border-bottom: none; }
        .review-history-date { font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 4px; }
        .review-history-content { font-size: 13px; color: var(--text-main); line-height: 1.4; }
        .review-history-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        .tab-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 460px; background: var(--header-bg); backdrop-filter: blur(20px);
            border-radius: 24px; display: flex; padding: 12px 20px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15); z-index: 1000;
            border: 1px solid var(--border); justify-content: space-between;
            padding-bottom: calc(12px + var(--safe-area-bottom));
        }
        .tab { text-align: center; color: var(--text-sub); cursor: pointer; font-size: 10px; flex: 1; padding: 4px 0; }
        .tab.active { color: var(--primary); transform: translateY(-2px); }
        .tab-icon { font-size: 22px; display: block; margin-bottom: 2px; }

        .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        .heatmap-container { display: flex; gap: 6px; justify-content: space-between; margin-bottom: 20px; }
        .heatmap-day { flex: 1; text-align: center; }
        .heatmap-box { height: 36px; border-radius: 8px; background: var(--border); margin-bottom: 6px; }
        .hm-success { background: var(--success); } .hm-fix { background: var(--warning); } .hm-repair { background: var(--danger); }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { font-size: 12px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; color: var(--text-sub); }
        .chip-removable { padding-right: 8px; display:inline-flex; align-items:center; }
        .chip-removable::after { content:'×'; font-weight:bold; margin-left:6px; font-size:14px; opacity:0.5; }

        .record-img {
            width: 40px; height: 40px;
            border-radius: 6px; border: 1px solid var(--border);
            margin-left: 10px; object-fit: cover; cursor: zoom-in; background: #eee;
        }

        .close-pending { position: absolute; top: 12px; right: 12px; color: var(--text-sub); opacity: 0.5; cursor: pointer; font-weight: bold; }
        .close-pending:hover { opacity: 1; }
        
        /* 待办选择弹窗样式 */
        #todoSelectModal > div {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .todo-date-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 6px;
            background: var(--border); color: var(--text-main); margin-left: 6px;
            font-weight: 600;
        }

        .backup-file-item {
            padding: 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; cursor: pointer;
        }
        .backup-file-item:hover { background: var(--input-bg); }

        /* Time Bank Exchange Card */
        .exchange-card {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--time);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body onclick="if(event.target.id === 'todoSelectModal') closeTodoSelectModal(); else closeAllMenus(event);">

    <div class="header">
        <div class="header-left">
            <div class="header-title">
                <h1>Habit</h1>
                <div id="syncBadge" class="sync-badge status-idle" onclick="syncGitHub('pull', false)">
                    <span class="sync-icon"></span><span id="syncText">本地模式</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <button id="themeToggle" class="theme-btn" onclick="toggleTheme()">☀️</button>
            <div class="fund-badge badge-time" onclick="toggleExchangeCard()">⏳ <span id="timeBankDisplay">0</span>h</div>
            <div class="fund-badge badge-wallet" onclick="switchPage('shop')">💰 <span id="walletDisplay">0</span></div>
            <div class="fund-badge badge-debt" onclick="switchPage('stats')">💸 <span id="debtDisplay">0</span></div>
        </div>
    </div>

    <div id="stickyNotifBar" class="sticky-notif-bar">
        <!-- 计时状态 -->
        <div id="notifTimer" class="notif-item notif-timer" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span>⏱️ 正在计时: <span id="notifTimerName">任务</span></span>
                <span id="notifTimerClock" style="font-family: monospace; font-size:14px;">00:00:00</span>
            </div>
            <div class="notif-btn" onclick="switchPage('timer')">去查看 ➔</div>
        </div>
        <!-- 置顶任务 -->
        <div id="notifPinned" class="notif-item notif-pinned" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span>📌 置顶计划: <span id="notifPinnedName">计划名</span></span>
                <span id="notifPinnedTime" style="font-size:11px; opacity:0.8;"></span>
            </div>
            <div style="display:flex; gap:12px;">
                <div class="notif-btn" onclick="startPinnedTask()">▶️ 开始</div>
                <div class="notif-btn" onclick="unpinTask()">✕</div>
            </div>
        </div>
    </div>

    <!-- 1. 首页 -->
    <div id="page-checkin" class="container page active">

        <div class="toggle-container">
            <div id="btn-view-checkin" class="toggle-btn active" onclick="toggleHomeView('checkin')">☀️ 晨间打卡</div>
            <div id="btn-view-todo" class="toggle-btn" onclick="toggleHomeView('todo')">📝 今日待办</div>
        </div>

        <!-- A. 打卡视图 -->
        <div id="view-checkin">
            <!-- 补救提示卡片 -->
            <div id="pendingCard" class="card" style="background:var(--warning-bg); border-color:var(--warning); display:none; position:relative;">
                <div class="close-pending" onclick="closePendingCard()">✕</div>
                <div style="font-size:13px; font-weight:800; color:var(--warning); margin-bottom:8px;">🔥 待执行补救措施</div>
                <div id="pendingText" style="font-weight:600; color:var(--text-main); font-size:15px; line-height:1.4;"></div>
            </div>

            <!-- 时间兑换卡片 -->
            <div id="exchangeCard" class="exchange-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-weight:800; color:var(--time);">⏳ 时间银行兑换</div>
                    <div class="btn-action" onclick="toggleExchangeCard()">✕</div>
                </div>
                <div style="font-size:13px; color:var(--text-sub); margin-bottom:12px;">当前汇率: 1小时 = <span id="rateDisplay">5</span> 元</div>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="exchangeHours" placeholder="兑换小时数" style="flex:1;">
                    <button class="btn-mini" style="background:var(--time); color:#fff; width:auto;" onclick="executeExchange()">💰 兑换</button>
                </div>
            </div>

            <div class="card" id="inputCard">
                <div class="card-title">📝 晨间打卡 <span id="dayTypeBadge" style="display:none;background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:10px;">🏖️ 周末</span></div>
                <div class="input-group">
                    <label class="input-label">日期</label>
                    <input type="date" id="dateInput" onchange="checkDateChange()">
                    <div class="chips-container" style="margin-top:8px;">
                        <div class="chip" onclick="quickSetDate('today')">今日</div>
                        <div class="chip" onclick="quickSetDate('yesterday')">昨日</div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-group"><label class="input-label">昨晚入睡 <span id="targetSleep" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="sleepInput" value="00:00"></div>
                    <div class="input-group"><label class="input-label">今早起床 <span id="targetWake" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="wakeInput" value="08:30"></div>
                </div>
                <div class="input-group"><label class="input-label">昨日专注时长 (h)</label><input type="number" step="0.1" id="studyInput" placeholder="输入昨日学习/专注总时长"></div>
                
                <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>

                <div id="manualInputs" style="display:none; margin-top:15px; border-top:1px dashed var(--border); padding-top:15px;">
                    <div class="input-group"><label class="input-label">补偿/补救金额 (元)</label><input type="number" id="manualPenalty" placeholder="0"></div>
                    <div class="input-group"><label class="input-label">补偿原因</label><textarea id="manualReason" placeholder="例如：晚起补救"></textarea></div>
                </div>

                <button class="btn-calc" onclick="calculateCheckin()">⚡ 智能诊断</button>
                <div class="row" style="margin-top: 12px;">
                    <button class="btn-calc btn-secondary" style="margin-top:0" onclick="applyRest()">☕ 申请休息</button>
                    <button class="btn-calc btn-prevent" style="margin-top:0" onclick="applyPrevent()">🛡️ 主动干预</button>
                </div>
            </div>

            <div id="analysisCard" class="card" style="display:none; text-align:center;"></div>
            <div id="formContainer"></div>
        </div>

        <!-- B. 待办视图 -->
        <div id="view-todo" style="display:none;">
            <div class="card" style="padding:16px; border-color:var(--primary);">
                <input type="hidden" id="editingId">
                <div style="margin-bottom:8px;">
                    <div style="font-size:11px;color:var(--text-sub);margin-bottom:4px;font-weight:600;">截止时间</div>
                    <div style="display:flex;gap:8px;">
                        <input type="date" id="todoDate" style="flex:3">
                        <input type="time" id="todoTime" style="flex:2">
                    </div>
                </div>
                <input type="text" id="todoTitle" placeholder="事项名称" style="margin-bottom:8px;">
                <textarea id="todoNote" placeholder="详细备注" rows="2" style="margin-bottom:8px; font-weight:normal; font-size:14px;"></textarea>

                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <select id="todoType" style="flex:1.2; padding:10px;" onchange="checkTodoTypeChange()">
                        <option value="do">🟢 去做</option>
                        <option value="dont">🔴 不做</option>
                        <option value="other">🔵 其它</option>
                    </select>
                    <select id="todoImportance" style="flex:1; padding:10px; border-color:var(--primary);">
                        <option value="1">🟢 普通</option>
                        <option value="2">🟡 中等</option>
                        <option value="3">🔴 重要</option>
                    </select>
                </div>

                <div style="display:flex; gap:8px; align-items:center;">
                    <div style="display:flex; flex:2; gap:4px;">
                        <input type="number" id="todoReward" placeholder="愿望金" value="1" style="border-color:var(--success);">
                        <input type="number" id="todoPenalty" placeholder="惩罚金" value="1" style="border-color:var(--danger);">
                    </div>

                    <!-- 统一的操作按钮 -->
                    <button id="todoSubmitBtn" class="btn-mini" style="background:var(--primary); color:#fff; height:46px; width:46px; font-size:20px;" onclick="saveTodo()">+</button>
                </div>

                <div style="margin-top:10px; text-align:right;">
                </div>
            </div>

            <div id="todoContainer">
                <div id="head-do" class="todo-section-title">🟢 必须完成 (Do)</div>
                <div id="list-do"></div>
                <div id="head-dont" class="todo-section-title">🔴 禁止行为 (Don't)</div>
                <div id="list-dont"></div>
                <div id="head-other" class="todo-section-title">🔵 其它杂项 (Other)</div>
                <div id="list-other"></div>
                <div id="head-expired" class="todo-section-title">
                    ⏰ 已结束 / 历史归档
                    <button class="btn-nuke" onclick="nukeExpiredTodos()">🗑️ 清空</button>
                </div>
                <div id="list-expired"></div>
                <div id="empty-todo-hint" style="text-align:center;color:var(--text-sub);padding:30px;display:none;">今日及未来暂无待办</div>
            </div>
        </div>
    </div>

    <!-- 2. 统计 -->
    <div id="page-stats" class="container page">
        <div class="card">
            <div class="card-title">
                <span>📊 数据概览</span>
                <select id="statPeriod" onchange="renderStats()" style="width:auto; padding:4px 8px; font-size:12px; height:32px;">
                    <option value="7">最近7天</option>
                    <option value="30">最近30天</option>
                    <option value="today">今天</option>
                    <option value="yesterday">昨天</option>
                    <option value="all">全部历史</option>
                </select>
            </div>
            
            <div class="chips-container" style="margin-bottom: 15px;">
                <div class="chip" onclick="setStatPeriod('today')">今日</div>
                <div class="chip" onclick="setStatPeriod('yesterday')">昨日</div>
                <div class="chip" onclick="setStatPeriod('7')">近7日</div>
            </div>

            <div class="heatmap-container" id="heatmap"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;text-align:center;">
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statStudy" style="font-weight:bold;font-size:20px;">0h</div><div style="font-size:12px;color:var(--text-sub)">阶段专注</div></div>
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statRate" style="font-weight:bold;font-size:20px;">0%</div><div style="font-size:12px;color:var(--text-sub)">完美率</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">⏱️ 专注统计</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:15px;">
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--primary);" id="statTimerTotal">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">总计时时长</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--success);" id="statTimerToday">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">今日时长</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--warning);" id="statTimerCount">0</div>
                    <div style="font-size:11px; color:var(--text-sub);">计时次数</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--time);" id="statTimerAvg">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">单次平均</div>
                </div>
            </div>
            <div id="statTimerTopTasks" style="font-size:12px; color:var(--text-main);"></div>
        </div>

        <div id="paySection" class="card" style="background:var(--danger-bg); border-color:var(--danger); text-align:center; display:none;">
            <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtAmount">0</div>
            <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">待罚公益金 (To-Do失败/打卡惩罚)</div>
            <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('fileInput').click()">📸 上传凭证并清零</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handlePaymentWithCompress(this)">
        </div>

        <div class="card">
            <div class="card-title">📜 历史档案 <button class="btn-mini btn-secondary" onclick="exportCSV()">导出CSV</button></div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- 3. 商店 -->
    <div id="page-shop" class="container page">
        <div class="card" style="background: var(--bg-card); border: 1px solid var(--warning);">
            <div class="card-title" style="color:var(--warning)">
                <span>🎁 愿望商店</span>
                <div style="display:flex; gap:6px; align-items:center;">
                     <button class="btn-mini" style="background:transparent; border:1px solid var(--warning); color:var(--warning);" onclick="sortShopByPrice()">💰 按价格排序</button>
                     <span id="shopPrivacyBtn" style="cursor:pointer; font-size:20px; padding:4px;" onclick="toggleShopPrivacy()">🔒</span>
                </div>
            </div>
            <div style="text-align:center; margin-bottom:15px; font-size:14px; color:var(--text-sub);">
                可用愿望金: <span id="shopWalletDisplay" style="font-weight:bold; font-size:18px; color:var(--warning);">0</span> 元
            </div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
                <input type="text" id="wishName" placeholder="商品名称">
                <input type="number" id="wishCost" placeholder="价格">
            </div>
            <label id="wishHiddenLabel" class="privacy-check-label" onclick="togglePrivacyCheck()">
                <input type="checkbox" id="wishHidden"> 设为私密商品
            </label>
            <button id="btnShopAdd" class="btn-calc" style="background:var(--warning);" onclick="addWish()">➕ 上架新愿望</button>
            <button id="btnShopCancel" class="btn-calc btn-secondary" style="display:none; margin-top:8px;" onclick="cancelShopEdit()">取消编辑</button>
        </div>

        <div class="card">
            <div id="shopList"></div>
        </div>
    </div>

    <!-- 4. 设置 -->
    <div id="page-settings" class="container page">
        <div class="card">
            <div class="card-title">⚙️ 基础目标</div>
             <div class="row"><div class="input-group"><label class="input-label">平日起床</label><input type="time" id="setWake"></div><div class="input-group"><label class="input-label">平日入睡</label><input type="time" id="setSleep"></div></div>
            <div class="row"><div class="input-group"><label class="input-label">周末起床</label><input type="time" id="setWakeW"></div><div class="input-group"><label class="input-label">周末入睡</label><input type="time" id="setSleepW"></div></div>
            
            <div class="row">
                <div class="input-group">
                    <label class="input-label">每日专注 (h)</label>
                    <input type="number" id="setStudy">
                </div>
                <div class="input-group">
                    <label class="input-label">⏰ 归档显示数</label>
                    <input type="number" id="setExpiredLimit" min="1" max="50">
                </div>
            </div>
            <div class="row">
                <div class="input-group">
                    <label class="input-label">🕒 计时历史数</label>
                    <input type="number" id="setTimerLimit" min="1" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">📜 历史档案数</label>
                    <input type="number" id="setHistoryLimit" min="1" max="50">
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">🏠 起始页</label>
                <select id="setInitialPage" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main);">
                    <option value="checkin">✨ 主页 (打卡)</option>
                    <option value="timer">⏱️ 计时页</option>
                </select>
            </div>

            <div class="input-group" style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px;">
                <label class="input-label">📅 周末定义</label>
                <div style="display:flex; gap:12px;">
                    <div id="btn_week_6" class="week-btn" onclick="toggleWeek(6)">周六</div>
                    <div id="btn_week_0" class="week-btn" onclick="toggleWeek(0)">周日</div>
                </div>
            </div>
             <button class="btn-calc" style="background:var(--text-main); margin-top:20px;" onclick="saveSettings()">💾 保存所有配置</button>
        </div>

        <div class="card">
            <div class="card-title">💰 奖惩体系 (元)</div>
            <div class="row" style="margin-bottom:12px;">
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--warning); margin-bottom:0;">
                    <label class="input-label" style="color:var(--warning); margin-bottom:4px;">🏆 晨间达标奖励</label>
                    <input type="number" id="rewardAmount" value="5">
                </div>
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--time); margin-bottom:0;">
                    <label class="input-label" style="color:var(--time); margin-bottom:4px;">⏳ 时间兑换汇率 (元/h)</label>
                    <input type="number" id="exchangeRate" value="5">
                </div>
            </div>

            <div style="font-size:12px; font-weight:700; color:var(--danger); margin:15px 0 8px 0; text-transform:uppercase;">惩罚阶梯 (左轻微 / 右严重)</div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">起床&lt;30m</span><input type="number" id="pWakeS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">起床≥30m</span><input type="number" id="pWakeL"></div>
            </div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">入睡&lt;1h</span><input type="number" id="pSleepS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">入睡≥1h</span><input type="number" id="pSleepL"></div>
            </div>
            <div class="row">
                <div><span style="font-size:11px;color:var(--text-sub)">学习&lt;1h</span><input type="number" id="pStudyS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">学习≥1h</span><input type="number" id="pStudyL"></div>
            </div>

             <div class="input-group" style="margin-top:10px;">
                <label class="input-label">🛡️ 预防模式扣费</label>
                <input type="number" id="preventCost" value="10">
            </div>
        </div>

        <div class="card">
            <div class="card-title">⏱️ 计时快捷项</div>
            <div class="input-group">
                <label class="input-label">自定义快捷任务</label>
                <div class="chips-container" id="setQuickTasksList"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_quicktask" placeholder="例如: 📚 深度阅读">
                    <button class="btn-mini" onclick="addQuickTask()">➕</button>
                </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--border);">
                <div style="font-size:11px;color:var(--text-sub);margin-bottom:8px;">💡 提示：快选项会按使用频次自动排序，常用的排在前面</div>
                <button class="btn-mini btn-secondary" style="width:100%;" onclick="resetTaskUsage()">🔄 重置所有使用频次</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">🛡️ 补救策略库 (自定义)</div>
            <div class="input-group">
                <label class="input-label">⏰ 早起失败补救</label>
                <div class="chips-container" id="list_wake"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_wake" placeholder="例如: 罚站10分钟">
                    <button class="btn-mini" onclick="addStrat('wake')">➕</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">🛌 晚睡补救措施</label>
                <div class="chips-container" id="list_sleep"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_sleep" placeholder="例如: 没收手机">
                    <button class="btn-mini" onclick="addStrat('sleep')">➕</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">⚡ 专注不足补救</label>
                <div class="chips-container" id="list_study"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_study" placeholder="例如: 周末补回">
                    <button class="btn-mini" onclick="addStrat('study')">➕</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">⚙️ GitHub 自动同步</div>
            <div class="input-group"><input type="password" id="ghToken" placeholder="Token"></div>
            <div class="input-group"><input type="text" id="ghRepo" placeholder="用户名/仓库名"></div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="saveSettings()">💾 保存并同步</button>
                <button class="btn-calc btn-secondary" style="background:var(--info); color:#fff; border:none;" onclick="archiveToGitHub()">☁️ 创建永久存档</button>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--info);">
            <div class="card-title" style="color:var(--info)">☁️ 云端时光机</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">从 GitHub 的 backups 文件夹恢复历史存档。</div>
            <button class="btn-calc btn-secondary" style="margin-top:0;" onclick="listCloudBackups()">📂 查看云端存档列表</button>
            <div id="cloudBackupList" style="margin-top:12px; display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:12px;"></div>
        </div>

        <div class="card">
            <div class="card-title">🔧 数据手动调节</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">直接修改当前数值以修正错误。修改将被记录至历史档案。</div>
            <div class="row">
                <div class="input-group"><label class="input-label">⏳ 时间银行 (h)</label><input type="number" step="0.1" id="adjTimeBank"></div>
                <div class="input-group"><label class="input-label">💰 愿望金 (元)</label><input type="number" id="adjWallet"></div>
            </div>
            <div class="input-group"><label class="input-label">💸 待罚公益金 (元)</label><input type="number" id="adjDebt"></div>
            <div class="input-group">
                <label class="input-label">📝 修改原因</label>
                <input type="text" id="adjReason" placeholder="例如: 记录录入错误">
            </div>
            <button class="btn-calc" style="background:var(--primary);" onclick="applyManualAdjustment()">💾 应用调整</button>
        </div>

        <div class="card">
            <div class="card-title">💾 数据安全 (JSON)</div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="exportJSON()">📤 本地备份</button>
                <button class="btn-calc btn-secondary" style="color:var(--success); border-color:var(--success);" onclick="document.getElementById('importFile').click()">📥 恢复数据</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importJSON(this)">
            </div>
        </div>
    </div>

    <!-- 计时页面 (新增加) -->
    <div id="page-timer" class="container page">
        <div class="card">
            <div class="card-title">⏱️ 专注计时</div>
            <div class="input-group">
                <label class="input-label">任务名称</label>
                <input type="text" id="timerTaskName" placeholder="现在想专注做什么？">
                <!-- 快选胶囊 -->
                <div id="quickTasksContainer" class="chips-container" style="margin-top: 8px;"></div>
            </div>
            
            <!-- 待办选择弹窗 -->
            <div id="todoSelectModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div style="background:var(--bg-card); border-radius:20px; padding:24px; max-width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:800; font-size:18px; color:var(--text-main);">📋 选择待办事项</div>
                        <div class="btn-action" onclick="closeTodoSelectModal()" style="width:32px; height:32px; font-size:18px;">✕</div>
                    </div>
                    <div id="todoSelectList" style="max-height:60vh; overflow-y:auto;"></div>
                </div>
            </div>

            <div class="row">
                <div class="input-group">
                    <label class="input-label">起始时间</label>
                    <input type="time" id="timerPlannedTime">
                </div>
                <div class="input-group">
                    <label class="input-label">结束时间</label>
                    <input type="time" id="timerPlannedEndTime">
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">备注</label>
                <textarea id="timerNote" placeholder="记下点什么..." rows="1" style="min-height: 46px;"></textarea>
            </div>

            <div id="activeTimerDisplay" style="text-align: center; margin: 20px 0;">
                <div id="timerClock" style="font-size: 48px; font-weight: 800; font-family: monospace; color: var(--primary);">00:00:00</div>
            </div>

            <div id="timerControls">
                <div id="timerIdleBtns" style="display: flex; gap: 12px; align-items: stretch;">
                    <button class="btn-calc" style="flex: 2; margin-top: 0;" id="btnTimerStart" onclick="startTimer()">🚀 开始计时</button>
                    <button class="btn-calc btn-secondary" style="flex: 1; margin-top: 0;" onclick="addPlannedTask()">📅 加入计划</button>
                </div>
                <div id="timerActiveBtns" style="display: none; gap: 12px; align-items: stretch;">
                    <button class="btn-calc btn-secondary" id="btnTimerPause" style="flex: 1; margin-top: 0;" onclick="toggleTimerPause()">⏸️ 暂停</button>
                    <button class="btn-calc btn-danger" style="flex: 1; margin-top: 0;" onclick="stopTimer()">⏹️ 结束并保存</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>📝 今日复盘</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-mini" style="background:var(--info); color:#fff;" onclick="toggleHistoryReview()">📜 历史</button>
                    <button id="btnSaveReview" class="btn-mini" style="background:var(--success); color:#fff;" onclick="saveDailyReview(true)">💾 保存</button>
                </div>
            </div>
            
            <div id="reviewInputArea">
                <div class="input-group">
                    <label class="input-label">🌟 真棒 (今天做得好的)</label>
                    <textarea id="reviewGreat" placeholder="记录下今天的成就感..." rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">🚀 加油 (以后需要改进的)</label>
                    <textarea id="reviewImprove" placeholder="明天哪里可以做得更好？" rows="2"></textarea>
                </div>
            </div>

            <!-- 历史复盘容器 -->
            <div id="reviewHistoryArea" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; max-height:300px; overflow-y:auto;">
                <div id="reviewHistoryList"></div>
            </div>
        </div>

        <!-- 计划清单 -->
        <div class="card" id="card-planned-tasks">
            <div class="card-title">📅 计划清单</div>
            <div id="plannedTasksList"></div>
        </div>

        <div class="card">
            <div class="card-title">🕒 计时历史</div>
            <div id="timerHistoryList"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchPage('checkin')"><span class="tab-icon">✨</span>主页</div>
        <div class="tab" onclick="switchPage('timer')"><span class="tab-icon">⏱️</span>计时</div>
        <div class="tab" onclick="switchPage('stats')"><span class="tab-icon">📊</span>统计</div>
        <div class="tab" onclick="switchPage('shop')"><span class="tab-icon">🎁</span>商店</div>
        <div class="tab" onclick="switchPage('settings')"><span class="tab-icon">⚙️</span>设置</div>
    </div>

<script>
    const DEFAULT_CONFIG = { 
        wake: "08:30", 
        sleep: "01:00", 
        study: 4.0, 
        wakeW: "10:00", 
        sleepW: "02:00", 
        reward: 5, 
        preventCost: 10, 
        exchangeRate: 5, 
        initialPage: "checkin",
        expiredLimit: 5,
        timerLimit: 5,
        historyLimit: 5,
        quickTasks: ['📚 阅读', '💻 编程', '✍️ 写作', '🏃 运动', '🎸 练习', '🧹 家务'],
        penalties: { wakeS: 2, wakeL: 5, sleepS: 2, sleepL: 5, studyS: 5, studyL: 10 }, 
        weekend: [0, 6] 
    };
    
    function safeParse(key, defaultVal) {
        try {
            const val = localStorage.getItem(key);
            if (!val || val === 'undefined') return defaultVal;
            return JSON.parse(val);
        } catch (e) {
            console.error("Error parsing " + key, e);
            return defaultVal;
        }
    }

    let historyData = safeParse('habit_data_v15', []);
    let config = safeParse('habit_config_v7', DEFAULT_CONFIG);
    
    // 确保配置中包含快捷任务（向后兼容）
    if (!config.quickTasks || config.quickTasks.length === 0) {
        config.quickTasks = DEFAULT_CONFIG.quickTasks;
    }
    
    let wishList = safeParse('habit_wishes_v1', []);
    let todoList = safeParse('habit_todos_v1', []);
    let userStrategies = safeParse('habit_strategies_v1', { study: ["⚡ 番茄钟"], sleep: ["📵 远离屏幕"], wake: ["⏰ 闹钟放远"] });
    let timeBank = parseFloat(localStorage.getItem('habit_time_bank_v1'));
    if (isNaN(timeBank) || timeBank < 0) timeBank = 0;
    let timerRecords = safeParse('habit_timer_records_v1', []);
    let plannedTasks = safeParse('habit_planned_tasks_v1', []);
    let ghConfig = safeParse('habit_gh_v1', { token: '', repo: '', path: 'habit_backup.json' });
    let currentTheme = localStorage.getItem('habit_theme') || 'auto';
    let todayIsWeekend = false;
    let isDeleting = false;
    let isShopPrivacyOn = true;
    let openMenuId = null;
    let editingPlannedId = null;
    let editingTimerRecordId = null;
    let editingHistoryItemId = null;
    let pinnedTaskId = localStorage.getItem('habit_pinned_task_id') || null;
    let globalWallet = 0, globalDebt = 0;
    let dailyReviews = safeParse('habit_daily_reviews_v1', {});
    let taskUsageCount = safeParse('habit_task_usage_v1', {}); // 任务使用频次统计
    let expiredFullView = false;
    let timerFullView = false;
    let historyFullView = false;
    let isReviewHistoryOpen = false;

    function switchPage(id){
        if (typeof closeAllMenus === 'function') closeAllMenus();

        const exchangeCard = document.getElementById('exchangeCard');
        if (exchangeCard) exchangeCard.style.display = 'none';

        if (id !== 'shop') {
            isShopPrivacyOn = true;
            const shopBtn = document.getElementById('shopPrivacyBtn');
            if (shopBtn) shopBtn.innerText = '🔒';
        }

        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        
        const targetPage = document.getElementById('page-'+id);
        if (targetPage) targetPage.classList.add('active');

        const maps={checkin:0, timer:1, stats:2, shop:3, settings:4};
        const tabs = document.querySelectorAll('.tab');
        if (tabs[maps[id]]) tabs[maps[id]].classList.add('active');

        if(id==='stats' && typeof renderStats === 'function') renderStats();
        if(id==='shop' && typeof renderShop === 'function') renderShop();
        if(id==='settings') { 
            if (typeof applySettingsToUI === 'function') applySettingsToUI();
            if (typeof renderQuickTaskSettings === 'function') renderQuickTaskSettings();
        }
        if(id==='timer') { 
            if (typeof renderPlannedTasks === 'function') renderPlannedTasks(); 
            if (typeof renderTimerHistory === 'function') renderTimerHistory(); 
            if (typeof loadDailyReview === 'function') loadDailyReview();
            if (typeof renderQuickTasks === 'function') renderQuickTasks();
            if (!timerRunning) initTimerTime();
        }
        
        // 记录最后一次访问的习惯页面 (用于从财富模式切回)
        if (id !== 'wealth') {
            localStorage.setItem('habit_last_page', id);
        }
    }

    let tempTimeDiff = 0;
    let useTimeBank = false;
    let defaultFund = 0;
    let calcReason = "";
    let failedTypes = [];
    let editingWishIndex = -1; // 记录正在编辑的商品索引

    // 计时器变量
    let timerRunning = false;
    let timerPaused = false;
    let timerSeconds = 0;
    let timerInterval = null;
    let timerSyncInterval = null; // 用于定期同步计时器状态
    let isTimerFromPlan = false; // 记录当前计时是否来自计划清单
    
    // 保存当前计时器状态到localStorage
    function saveTimerState() {
        if (!timerRunning) {
            localStorage.removeItem('habit_timer_state_v1');
            return;
        }
        
        // 尝试获取已存在的startTimestamp，如果没有则计算新的
        let startTimestamp;
        const existingState = localStorage.getItem('habit_timer_state_v1');
        if (existingState) {
            try {
                const parsed = JSON.parse(existingState);
                startTimestamp = parsed.startTimestamp || (Date.now() - (timerSeconds * 1000));
            } catch (e) {
                startTimestamp = Date.now() - (timerSeconds * 1000);
            }
        } else {
            startTimestamp = Date.now() - (timerSeconds * 1000);
        }
        
        const timerState = {
            running: timerRunning,
            paused: timerPaused,
            seconds: timerSeconds,
            taskName: document.getElementById('timerTaskName').value || '',
            note: document.getElementById('timerNote').value || '',
            todoId: document.getElementById('timerTaskName').getAttribute('data-todo-id') || null,
            fromPlan: isTimerFromPlan,
            lastUpdate: Date.now(),
            startTimestamp: startTimestamp // 保持原有的开始时间戳
        };
        localStorage.setItem('habit_timer_state_v1', JSON.stringify(timerState));
    }
    
    // 从localStorage恢复计时器状态
    function restoreTimerState() {
        // 先清理现有的计时器
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (timerSyncInterval) {
            clearInterval(timerSyncInterval);
            timerSyncInterval = null;
        }
        
        const saved = localStorage.getItem('habit_timer_state_v1');
        if (!saved) {
            // 如果没有保存的状态，确保UI处于空闲状态
            timerRunning = false;
            timerPaused = false;
            timerSeconds = 0;
            const idleBtns = document.getElementById('timerIdleBtns');
            const activeBtns = document.getElementById('timerActiveBtns');
            if (idleBtns) idleBtns.style.display = 'flex';
            if (activeBtns) activeBtns.style.display = 'none';
            return;
        }
        
        try {
            const state = JSON.parse(saved);
            const now = Date.now();
            
            // 只恢复24小时内的计时状态，避免恢复过旧的状态
            if (!state.running || now - state.lastUpdate > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('habit_timer_state_v1');
                return;
            }
            
            // 如果计时器没有暂停，根据开始时间戳计算实际已经过去的秒数
            if (!state.paused && state.startTimestamp) {
                const elapsedMs = now - state.startTimestamp;
                timerSeconds = Math.floor(elapsedMs / 1000);
            } else {
                // 如果暂停了，就使用保存的秒数
                timerSeconds = state.seconds || 0;
            }
            
            timerRunning = state.running;
            timerPaused = state.paused || false;
            isTimerFromPlan = state.fromPlan || false;
            
            // 恢复UI
            const taskNameInput = document.getElementById('timerTaskName');
            const noteInput = document.getElementById('timerNote');
            
            if (taskNameInput) taskNameInput.value = state.taskName || '';
            if (noteInput) noteInput.value = state.note || '';
            if (state.todoId && taskNameInput) taskNameInput.setAttribute('data-todo-id', state.todoId);
            
            // 重新启动计时器
            if (timerRunning) {
                const idleBtns = document.getElementById('timerIdleBtns');
                const activeBtns = document.getElementById('timerActiveBtns');
                if (idleBtns) idleBtns.style.display = 'none';
                if (activeBtns) activeBtns.style.display = 'flex';
                
                const pauseBtn = document.getElementById('btnTimerPause');
                if (pauseBtn) {
                    pauseBtn.innerText = timerPaused ? '▶️ 继续' : '⏸️ 暂停';
                }
                
                updateTimerUI();
                updateStickyNotif();
                
                timerInterval = setInterval(() => {
                    if (!timerPaused) {
                        timerSeconds++;
                        updateTimerUI();
                        saveTimerState(); // 每秒保存一次状态到本地
                    }
                }, 1000);
                
                // 恢复后也启动定期同步
                timerSyncInterval = setInterval(() => {
                    if (timerRunning) {
                        console.log('🔄 定期同步计时器状态到云端...');
                        triggerAutoSave();
                    }
                }, 30000); // 30秒
                
                console.log('✅ 已恢复计时器状态:', state.taskName, '已计时', Math.floor(timerSeconds / 60), '分钟');
            }
        } catch (e) {
            console.error('恢复计时器状态失败:', e);
            localStorage.removeItem('habit_timer_state_v1');
        }
    }

    /* ================== ✅ 同步修复：剥离图片字段（仅用于云端/拉取写入） ================== */
    function stripImagesFromHistory(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(r => {
            if (!r || typeof r !== 'object') return r;
            const nr = { ...r };
            if (nr.details && typeof nr.details === 'object') {
                const nd = { ...nr.details };
                if (nd.image) delete nd.image; // 不同步/不落盘图片
                nr.details = nd;
            }
            return nr;
        });
    }

    function persistAllLocal() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
    }

    function setSyncBadgeStatus(status, text) {
        const badge = document.getElementById('syncBadge');
        const badgeText = document.getElementById('syncText');
        badge.className = `sync-badge ${status}`;
        if (typeof text === 'string') badgeText.innerText = text;
    }

    function initTodoTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        const todoTimeInput = document.getElementById('todoTime');
        if (todoTimeInput) todoTimeInput.value = timeStr;
    }

    function initTimerTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        const timerPlannedTimeInput = document.getElementById('timerPlannedTime');
        if (timerPlannedTimeInput) timerPlannedTimeInput.value = timeStr;
    }

    function init() {
        fixCorruptData();
        initTheme();
        const today = getLocalTodayStr();
        document.getElementById('dateInput').value = today;
        document.getElementById('todoDate').value = today;
        initTodoTime();
        initTimerTime();
        checkWeekend(); applySettingsToUI();
        renderStrategySettings();
        renderQuickTaskSettings(); // 初始化快捷任务设置显示
        if(ghConfig.token && ghConfig.repo) { document.getElementById('ghToken').value = ghConfig.token; document.getElementById('ghRepo').value = ghConfig.repo; }
        checkDateChange();
        restoreTimerState(); // 恢复正在进行的计时器状态
        updateUI();
        updateStickyNotif(); // 加载时显示可能的置顶任务

        // 默认进入起始页
        switchPage(config.initialPage || 'checkin');

        setInterval(() => {
            if(!isDeleting) {
                autoCheckTodos();
                updateStickyNotif(); // 周期性更新置顶通知（确保"下一计划"随时间自动切换）
            }
        }, 2000);

        if(ghConfig.token && ghConfig.repo) syncGitHub('pull', true);
    }

    function toggleWeek(day) {
        if(!config.weekend) config.weekend = [0, 6];
        const idx = config.weekend.indexOf(day);
        if(idx > -1) config.weekend.splice(idx, 1);
        else config.weekend.push(day);

        applySettingsToUI();
        checkWeekend();

        config.weekend = config.weekend || [0, 6];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
    }

    function toggleExchangeCard() {
        const card = document.getElementById('exchangeCard');
        if(card.style.display === 'block') {
            card.style.display = 'none';
        } else {
            switchPage('checkin');
            toggleHomeView('checkin');
            card.style.display = 'block';
            document.getElementById('rateDisplay').innerText = config.exchangeRate || 5;
            document.getElementById('exchangeHours').value = '';
        }
    }

    function executeExchange() {
        const hours = parseFloat(document.getElementById('exchangeHours').value);
        if(!hours || hours <= 0) return alert("请输入有效小时数");
        if(hours > timeBank) return alert(`余额不足，当前仅有 ${timeBank.toFixed(1)} 小时`);

        const rate = config.exchangeRate || 5;
        const money = hours * rate;

        if(!confirm(`确认消耗 ${hours} 小时兑换 ${money} 元愿望金？`)) return;

        timeBank -= hours;
        saveRecord({
            fund: money,
            title: '⏳ 时间兑换',
            theme: 'theme-success',
            details: { note: `消耗 ${hours}h, 汇率 ${rate}`, time_bank_change: `-${hours}h` }
        });

        toggleExchangeCard();
        alert("💰 兑换成功！");
    }

    function toggleTheme() {
        currentTheme = (currentTheme === 'light' ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('habit_theme', currentTheme);
        document.getElementById('themeToggle').innerText = (currentTheme === 'light' ? '☀️' : '🌙');
    }

    function initTheme() {
        const saved = localStorage.getItem('habit_theme') || 'light';
        currentTheme = saved;
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('themeToggle').innerText = (saved === 'light' ? '☀️' : '🌙');
    }

    function toggleHomeView(view) {
        document.getElementById('view-checkin').style.display = (view === 'checkin' ? 'block' : 'none');
        document.getElementById('view-todo').style.display = (view === 'todo' ? 'block' : 'none');
        document.getElementById('btn-view-checkin').classList.toggle('active', view === 'checkin');
        document.getElementById('btn-view-todo').classList.toggle('active', view === 'todo');
        if (view === 'todo') renderTodos();
    }

    function getLocalTodayStr() {
        const d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function checkDateChange() {
        checkWeekend();
        const dateStr = document.getElementById('dateInput').value;
        document.getElementById('todoDate').value = dateStr;
        const todayStr = getLocalTodayStr();
        if (dateStr === todayStr) {
            const hasCheckin = historyData.some(r => r.date === dateStr && ['theme-success','theme-fix','theme-repair','theme-prevent','theme-skip'].includes(r.theme));
            if (hasCheckin) {
                document.getElementById('inputCard').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-sub);">今日已完成打卡 ✨</div>';
            }
        }
        renderTodos();
        renderStrategies();
    }

    function calculateCheckin() {
        autoCalculate();
    }

    function applyRest() {
        const leaveCount = historyData.filter(r => r.date.startsWith(document.getElementById('dateInput').value.slice(0, 7)) && r.theme === 'theme-skip').length;
        renderForm('skip', leaveCount);
    }

    function applyPrevent() {
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">🛡️ 诊断中...</div>`;
        renderForm('prevent');
    }

    function renderStrategySettings() {
        ['wake','sleep','study'].forEach(type => {
            const container = document.getElementById('list_' + type);
            if (!container) return;
            container.innerHTML = (userStrategies[type]||[]).map((s, idx) => `
                <div class="chip chip-removable" onclick="removeStrat('${type}', ${idx})">${s}</div>
            `).join('');
        });
    }

    function addStrat(type) {
        const input = document.getElementById(`input_${type}`);
        const val = input.value.trim();
        if(!val) return;
        if(!userStrategies[type]) userStrategies[type] = [];
        userStrategies[type].push(val);
        input.value = '';
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }
    function removeStrat(type, idx) {
        if(!confirm(`删除此策略?`)) return;
        userStrategies[type].splice(idx, 1);
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }

    function getTimestampStr() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + "_" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
    }

    function fixCorruptData() {
        let originalLen = todoList.length;
        todoList = todoList.filter(t => t);
        todoList.forEach(t => { if(!t.id) t.id = 'fixed_' + Math.random(); if(!t.title) t.title = "修复的数据"; });
        const seen = new Set();
        todoList = todoList.filter(t => { if(seen.has(t.id)) return false; seen.add(t.id); return true; });
        if(todoList.length !== originalLen) localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
    }

    function nukeExpiredTodos() {
        if(!confirm("⚠️ 确认清空列表中的所有【已结束/已过期】项目？此操作不可撤销。")) return;
        isDeleting = true;
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        const todayStr = getLocalTodayStr();
        todoList = todoList.filter(t => {
            if(t.archived) return false; // 移除已归档
            if(t.date > todayStr) return true;
            if(t.date === todayStr && t.time >= currentHm) return true;
            let isExpired = (t.date < todayStr) ||
                            (t.date === todayStr && currentHm > t.time && (t.status === 'pending' || t.status.startsWith('expired_')));
            return !isExpired;
        });
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
        triggerAutoSave();
        setTimeout(() => isDeleting = false, 500);
    }

    function checkTodoTypeChange() {
        const type = document.getElementById('todoType').value;
        if(type === 'other') {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            document.getElementById('todoDate').value = d.toISOString().split('T')[0];
            document.getElementById('todoReward').value = 0;
            document.getElementById('todoPenalty').value = 0;
        } else {
            if(document.getElementById('todoReward').value == 0) document.getElementById('todoReward').value = config.reward || 5;
            if(document.getElementById('todoPenalty').value == 0) document.getElementById('todoPenalty').value = 1;
            document.getElementById('todoDate').value = getLocalTodayStr();
        }
    }

    function renderTodos() {
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);

        ['list-do','list-dont','list-other','list-expired'].forEach(id=>document.getElementById(id).innerHTML='');
        ['head-do','head-dont','head-other','head-expired'].forEach(id=>document.getElementById(id).classList.remove('show'));

        // 1. 分离 Active 和 Expired
        let activeItems = [];
        let expiredItems = [];

        todoList.forEach(t => {
            let isExpired = (t.date < todayStr) || t.archived; // 增加手动归档判断
            if (!isExpired && t.date === todayStr && currentHm >= t.time) {
                 if (currentHm > t.time) {
                     if (t.status === 'pending' || t.status.startsWith('expired_')) {
                         isExpired = true;
                     }
                 }
            }
            if(isExpired) expiredItems.push(t);
            else activeItems.push(t);
        });

        // 2. 渲染 Active (重要等级优先，其次按时间排序)
        activeItems.sort((a, b) => {
            const impA = a.importance || 1;
            const impB = b.importance || 1;
            if (impA !== impB) return impB - impA; // 按重要等级降序
            return (a.date + a.time).localeCompare(b.date + b.time); // 同级按时间升序
        });
        
        let activeCount = 0;
        activeItems.forEach(t => {
            const html = generateTodoHtml(t, false);
            activeCount++;
            if(t.type === 'do') { document.getElementById('list-do').insertAdjacentHTML('beforeend', html); document.getElementById('head-do').classList.add('show'); }
            else if(t.type === 'dont') { document.getElementById('list-dont').insertAdjacentHTML('beforeend', html); document.getElementById('head-dont').classList.add('show'); }
            else { document.getElementById('list-other').insertAdjacentHTML('beforeend', html); document.getElementById('head-other').classList.add('show'); }
        });

        // 3. 渲染 Expired (强制倒序 + 数量限制)
        if(expiredItems.length > 0) {
            expiredItems.sort((a, b) => {
                const dtA = a.date + a.time;
                const dtB = b.date + b.time;
                return dtB.localeCompare(dtA); // Descending
            });

            const limit = expiredFullView ? expiredItems.length : (config.expiredLimit || 5);
            const displayedExpired = expiredItems.slice(0, limit);

            const expiredHtml = displayedExpired.map(t => generateTodoHtml(t, true)).join('');
            document.getElementById('list-expired').innerHTML = expiredHtml;
            document.getElementById('head-expired').classList.add('show');
            
            // 如果有更多，显示一个提示
            if (!expiredFullView && expiredItems.length > limit) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleExpiredFullView()">
                        👇 仅显示最近 ${limit} 条归档，点击展开全部 (${expiredItems.length})
                    </div>`
                );
            } else if (expiredFullView && expiredItems.length > (config.expiredLimit || 5)) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleExpiredFullView()">
                        👆 点击收起长列表
                    </div>`
                );
            }
        }

        document.getElementById('empty-todo-hint').style.display = activeCount === 0 ? 'block' : 'none';

        if(openMenuId) {
             const menu = document.getElementById(`menu-${openMenuId}`);
             if(menu && menu.classList.contains('show')) {
                 clearTimeout(menuTimer);
                 menuTimer = setTimeout(() => {
                    menu.classList.remove('show');
                    openMenuId = null;
                 }, 8000);
             }
        }
    }

    function generateTodoHtml(t, isExpired) {
        let statusIcon = '', actionBtn = '';
        const reward = t.reward || 0;
        const penalty = t.penalty || 0;

        const importance = t.importance || 1;
        const importanceColors = { 3: 'var(--danger)', 2: 'var(--warning)', 1: 'var(--success)' };
        const importanceDot = `<span style="width:10px; height:10px; border-radius:50%; background:${importanceColors[importance]}; display:inline-block; margin-right:4px;"></span>`;

        const noteContent = t.hideNote ? '******' : t.note;
        const note = t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:2px;background:var(--input-bg);padding:4px;border-radius:6px;word-break:break-all;">${noteContent}</div>` : '';
        const safeId = String(t.id);
        const todayStr = getLocalTodayStr();
        const isFuture = t.date > todayStr;
        const dateBadge = (isFuture || isExpired) ? `<span class="todo-date-badge">📅 ${t.date.slice(5)}</span>` : '';

        if (t.status === 'success') {
            statusIcon = `<span style="color:var(--success)">✔</span>`;
            actionBtn = `<span style="font-size:12px;color:var(--success);font-weight:bold;">+${reward}</span>`;
        } else if (t.status === 'fail') {
            statusIcon = `<span style="color:var(--danger)">✕</span>`;
            actionBtn = `<span style="font-size:12px;color:var(--danger);font-weight:bold;">-${penalty}</span>`;
        } else {
            statusIcon = `<span style="background:var(--border);width:8px;height:8px;border-radius:50%;display:inline-block;"></span>`;
            if (isExpired) {
                statusIcon = `<span style="color:var(--text-sub)">✕</span>`;
                if(t.status === 'expired_fail') actionBtn = `<span style="font-size:11px;color:var(--danger);">已超时(罚)</span>`;
                else if(t.status === 'expired_success') actionBtn = `<span style="font-size:11px;color:var(--success);">已达成(奖)</span>`;
                else actionBtn = `<span style="font-size:11px;color:var(--text-sub);">已过期</span>`;
            } else {
                if (t.type === 'do' || t.type==='other') {
                    actionBtn = `<div id="btn-${safeId}" class="todo-check" onclick="finishTodoWithAnim('${safeId}', 'success')">✔</div>`;
                } else {
                    actionBtn = `<button class="btn-mini" style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger);" onclick="finishTodoWithAnim('${safeId}', 'fail')">破戒</button>`;
                }
            }
        }
        const wrapperClass = isExpired ? 'todo-item todo-expired-item' : `todo-item todo-${t.type}`;

        let menuHtml = '';
        const showClass = (safeId === openMenuId) ? 'show' : '';

        let customActions = '';
        if (!isExpired && (t.status === 'success' || t.status === 'fail')) {
            customActions += `<div class="btn-action" style="background:var(--input-bg);color:var(--text-sub);font-size:12px;" onclick="archiveTodo('${safeId}')">📥 归档</div>`;
        }
        if (t.note) {
            customActions += `<div class="btn-action" style="font-size:12px;" onclick="toggleTodoNote('${safeId}')">${t.hideNote ? '👁️' : '🔒'} 备注</div>`;
        }

        if(t.status === 'pending' || t.status.startsWith('expired_')) {
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">⋮</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-edit" onclick="editTodo('${safeId}')">✏️</div>
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">🗑️</div>
                </div>
            `;
        } else {
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">⋮</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">✕</div>
                </div>
            `;
        }

        return `
        <div class="${wrapperClass}" id="todo-row-${safeId}">
            <div style="flex:1; display:flex; align-items:flex-start; gap:8px;">
                <div style="margin-top:4px;">${statusIcon}</div>
                <div style="width:100%;">
                    <div style="font-weight:700; color:var(--text-main);">${importanceDot}${t.title} <span style="font-size:12px;color:var(--text-sub);background:var(--border);padding:2px 4px;border-radius:4px;">${t.time}</span> ${dateBadge}</div>
                    <div style="font-size:11px; color:var(--text-sub); margin-top:2px;">奖${reward} / 罚${penalty}</div>
                    ${note}
                </div>
            </div>
            <div style="display:flex;align-items:center; gap:4px;">
                ${actionBtn} ${menuHtml}
            </div>
        </div>`;
    }

    let menuTimer = null;
    function toggleMenu(e, id) {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${id}`);
        const isShown = menu.classList.contains('show');

        closeAllMenus();

        if(!isShown) {
            menu.classList.add('show');
            openMenuId = id;

            clearTimeout(menuTimer);
            menuTimer = setTimeout(() => {
                menu.classList.remove('show');
                openMenuId = null;
            }, 8000);
        }
    }

    function closeAllMenus(e) {
        clearTimeout(menuTimer);
        document.querySelectorAll('.action-menu.show').forEach(el => el.classList.remove('show'));
        openMenuId = null;
    }

    function saveTodo() {
        const id = document.getElementById('editingId').value;
        const title = document.getElementById('todoTitle').value;
        const note = document.getElementById('todoNote').value;
        const time = document.getElementById('todoTime').value;
        const date = document.getElementById('todoDate').value;
        const type = document.getElementById('todoType').value;
        const importance = parseInt(document.getElementById('todoImportance').value) || 1;
        const reward = parseFloat(document.getElementById('todoReward').value) || 0;
        const penalty = parseFloat(document.getElementById('todoPenalty').value) || 0;

        if(!title || !time || !date) return alert("请填写完整信息");

        if (id) {
            const t = todoList.find(x => String(x.id) === id);
            if (t) {
                t.title = title;
                t.note = note;
                t.time = time;
                t.date = date;
                t.type = type;
                t.importance = importance;
                t.reward = reward;
                t.penalty = penalty;
                t.status = 'pending';
                delete t.archived; // 编辑后取消归档状态
            }
        } else {
            const newId = 't_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            todoList.push({ id: newId, date, title, note, time, type, importance, reward, penalty, status: 'pending' });
        }

        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // 更新计时页面的快选胶囊
        triggerAutoSave();
        cancelEdit();
    }

    function editTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t) return;

        document.getElementById('editingId').value = t.id;
        document.getElementById('todoTitle').value = t.title;
        document.getElementById('todoNote').value = t.note || '';
        document.getElementById('todoTime').value = t.time;
        document.getElementById('todoDate').value = t.date;
        document.getElementById('todoType').value = t.type;
        document.getElementById('todoImportance').value = t.importance || 1;
        document.getElementById('todoReward').value = t.reward;
        document.getElementById('todoPenalty').value = t.penalty;

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = '💾';
        submitBtn.style.fontSize = '16px';

        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('editingId').value = '';
        document.getElementById('todoTitle').value = '';
        document.getElementById('todoNote').value = '';
        document.getElementById('todoType').value = 'do';
        document.getElementById('todoImportance').value = '1';

        document.getElementById('todoReward').value = config.reward || 5;
        document.getElementById('todoPenalty').value = '1';

        initTodoTime();
        document.getElementById('todoDate').value = getLocalTodayStr();

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = '+';
        submitBtn.style.fontSize = '20px';
    }

    function toggleTodoNote(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.hideNote = !t.hideNote;
            renderTodos();
            triggerAutoSave();
        }
    }

    function archiveTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.archived = true;
            renderTodos();
            triggerAutoSave();
        }
    }

    function addTodo() { saveTodo(); }

    function deleteTodo(id) {
        if(!confirm("删除此待办？")) return;
        isDeleting = true;
        todoList = todoList.filter(t => String(t.id) !== String(id));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        const el = document.getElementById(`todo-row-${id}`);
        if(el) el.remove();
        setTimeout(() => { 
            renderTodos(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // 更新计时页面的快选胶囊
            triggerAutoSave(); 
            isDeleting = false; 
        }, 300);
    }

    function finishTodoWithAnim(id, result) {
        const btn = document.getElementById(`btn-${id}`);
        if(btn) btn.classList.add('click-anim');
        setTimeout(() => { finishTodo(id, result); }, 300);
    }

    function finishTodo(id, result) {
        const t = todoList.find(x => String(x.id) === String(id));
        if(!t) return;
        t.status = result;

        let fund, theme, displayTitle, recordType;
        if (t.type === 'do' || t.type === 'other') {
            if (result === 'success') { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
            else { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
        } else if (t.type === 'dont') {
            if (result === 'fail') { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
            else { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
        }

        displayTitle = (t.type==='do'?'🟢':(t.type==='dont'?'🔴':'🔵')) + ' ' + t.title;
        saveRecord({ fund, title: displayTitle, theme, details:{type:'Todo结算', result, recordType} }, false);
        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // 更新计时页面的快选胶囊
    }

    function autoCheckTodos() {
        if(isDeleting) return;
        const now = new Date(), currentHm = now.toTimeString().slice(0, 5), todayStr = getLocalTodayStr();
        let changed = false;

        todoList.forEach(t => {
            if (t.date === todayStr && t.status === 'pending' && currentHm > t.time) {
                if (t.type === 'dont') {
                    t.status = 'expired_success';
                    saveRecord({ fund: t.reward, title: '🔴 ' + t.title, theme: 'theme-success', details: { note: '坚持达成', recordType: 'todo-success' } }, false);
                    changed = true;
                } else {
                    t.status = 'expired_fail';
                    saveRecord({ fund: -t.penalty, title: (t.type==='do'?'🟢':'🔵') + ' ' + t.title, theme: 'theme-pay', details: { note: '超时未完成', recordType: 'todo-fail' } }, false);
                    changed = true;
                }
            }
        });
        if (changed) { 
            renderTodos(); 
            updateUI(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // 更新计时页面的快选胶囊
            triggerAutoSave(); 
        }
    }

    function toggleShopPrivacy() {
        isShopPrivacyOn = !isShopPrivacyOn;
        document.getElementById('shopPrivacyBtn').innerText = isShopPrivacyOn ? '🔒' : '👁️';
        renderShop();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        if (wishList.length === 0) { list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">愿望清单空空如也</div>'; return; }

        list.innerHTML = wishList.map((item, idx) => {
            const isHidden = item.hidden && isShopPrivacyOn;
            const nameDisplay = isHidden ? '🔒 ******' : item.name;
            const btnState = isHidden ? 'disabled style="background:var(--border);cursor:not-allowed;"' : 'style="background:var(--warning);color:#fff;" onclick="buyItem(' + idx + ')"';

            const idSuffix = `shop-${idx}`;
            const showClass = (openMenuId === idSuffix) ? 'show' : '';

            const moveUp = idx > 0 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, -1)">⬆️</div>` : '';
            const moveDown = idx < wishList.length - 1 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, 1)">⬇️</div>` : '';

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold;color:var(--text-main);">${nameDisplay}</div>
                    <div style="font-size:12px;color:var(--warning);">💰 ${item.cost} ${item.hidden ? '(私密)' : ''}</div>
                </div>
                <div style="display:flex;gap:4px; align-items:center;">
                    <button class="btn-mini" ${btnState}>兑换</button>
                    <div class="btn-action" onclick="toggleMenu(event, '${idSuffix}')">⋮</div>

                    <div id="menu-${idSuffix}" class="action-menu ${showClass}">
                        ${moveUp} ${moveDown}
                        <div class="btn-action btn-edit" onclick="editWish(${idx})">✏️</div>
                        <div class="btn-del btn-action" onclick="deleteWish(${idx})">🗑️</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function moveWish(index, direction) {
        if (direction === -1 && index > 0) { [wishList[index], wishList[index-1]] = [wishList[index-1], wishList[index]]; }
        else if (direction === 1 && index < wishList.length - 1) { [wishList[index], wishList[index+1]] = [wishList[index+1], wishList[index]]; }
        else return;
        renderShop(); triggerAutoSave();
    }

    function editWish(index) {
        const item = wishList[index];
        document.getElementById('wishName').value = item.name;
        document.getElementById('wishCost').value = item.cost;

        const checkbox = document.getElementById('wishHidden');
        checkbox.checked = item.hidden || false;
        if(checkbox.checked) { document.getElementById('wishHiddenLabel').classList.add('checked'); }
        else { document.getElementById('wishHiddenLabel').classList.remove('checked'); }

        editingWishIndex = index;
        document.getElementById('btnShopAdd').innerText = "💾 保存商品";
        document.getElementById('btnShopCancel').style.display = "inline-block";
        document.querySelector('#page-shop .card').scrollIntoView({behavior:'smooth'});
    }

    function cancelShopEdit() {
        document.getElementById('wishName').value = '';
        document.getElementById('wishCost').value = '';
        document.getElementById('wishHidden').checked = false;
        document.getElementById('wishHiddenLabel').classList.remove('checked');

        editingWishIndex = -1;
        document.getElementById('btnShopAdd').innerText = "➕ 上架新愿望";
        document.getElementById('btnShopCancel').style.display = "none";
    }

    function togglePrivacyCheck() {
        const checkbox = document.getElementById('wishHidden');
        const label = document.getElementById('wishHiddenLabel');
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) { label.classList.add('checked'); } else { label.classList.remove('checked'); }
    }

    function addWish() {
        const n = document.getElementById('wishName').value.trim();
        const c = parseFloat(document.getElementById('wishCost').value);
        const checkbox = document.getElementById('wishHidden');
        const h = checkbox.checked;
        if(!n || !c || c <= 0) return alert("请输入正确的名称和价格");

        if (editingWishIndex > -1) {
            wishList[editingWishIndex] = {name:n, cost:c, hidden:h};
            cancelShopEdit();
        } else {
            wishList.push({name:n, cost:c, hidden:h});
            document.getElementById('wishName').value = ''; document.getElementById('wishCost').value = '';
            checkbox.checked = false; document.getElementById('wishHiddenLabel').classList.remove('checked');
        }
        renderShop(); triggerAutoSave();
    }
    function deleteWish(idx) { if(!confirm("确认删除此商品？")) return; wishList.splice(idx, 1); if(idx === editingWishIndex) cancelShopEdit(); renderShop(); triggerAutoSave(); }
    function buyItem(idx){
        const item = wishList[idx];
        if(globalWallet < item.cost) return alert(`❌ 余额不足！还差 ${item.cost - globalWallet} 元`);
        if(!confirm(`确认消耗 ${item.cost} 元兑换【${item.name}】?`)) return;
        saveRecord({fund: -item.cost, title:'🎁 商店兑换', theme:'theme-shop', details:{item: item.name}});
    }

    function handlePaymentWithCompress(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if(width > 800) { height *= 800 / width; width = 800; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const payAmount = globalDebt;
                saveRecord({ fund: -payAmount, title: '💸 支付清零', theme: 'theme-pay', details: { image: dataUrl, note: '上传凭证清零' } });
                alert("✅ 支付凭证已上传，债务已清零！");
                
                // 清理内存
                reader.onload = null;
                img.onload = null;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function updateUI() {
        calculateFunds();
        document.getElementById('timeBankDisplay').innerText = (Number(timeBank) || 0).toFixed(1); // 更新时间银行显示

        const list = document.getElementById('historyList');
        if (historyData.length === 0) {
            list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">暂无记录</div>';
        } else {
            const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
            const displayedHistory = historyData.slice(0, limit);

            list.innerHTML = displayedHistory.map(i => {
                if (editingHistoryItemId === i.id) {
                    return `
                    <div class="inline-editor">
                        <div class="input-group"><label class="input-label">记录标题</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                        <div class="input-group"><label class="input-label">金额 (元)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryItem(${i.id})">💾 保存</button>
                            <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">✕ 取消</button>
                        </div>
                    </div>`;
                }

                let imgHtml = '';
                if(i.details && i.details.image) {
                    imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                }
                return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `📝改:${v}`; if(k==='penalty_rule') return `⚖️${v}`; if(k==='image') return ''; return v; }).join(' · ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">✏️</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">✕</div> </div> </div>`;
            }).join('');

            // 如果有更多，显示一个提示
            if (!historyFullView && historyData.length > limit) {
                list.insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleHistoryFullView()">
                        👇 仅显示最近 ${limit} 条记录，点击展开全部 (${historyData.length})
                    </div>`
                );
            } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                list.insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleHistoryFullView()">
                        👆 点击收起长列表
                    </div>`
                );
            }
        }

        const pendingCard = document.getElementById('pendingCard');
        const lastRecord = historyData[0];
        if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) {
            const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan;
            if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) {
                pendingCard.style.display = 'block';
                pendingCard.dataset.id = lastRecord.id;
                document.getElementById('pendingText').innerHTML = `📅 ${lastRecord.date}: ${fixPlan}`;
            } else { pendingCard.style.display = 'none'; }
        } else { pendingCard.style.display = 'none'; }

        const paySection = document.getElementById('paySection');
        if (globalDebt > 0) { paySection.style.display = 'block'; document.getElementById('debtAmount').innerText = globalDebt; }
        else { paySection.style.display = 'none'; }
        renderStats(); renderShop();
    }

    function editItem(id) {
        editingHistoryItemId = id;
        updateUI();
    }

    function saveInlineHistoryItem(id) {
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        
        const newTitle = document.getElementById(`editItemTitle-${id}`).value.trim();
        const newFund = parseFloat(document.getElementById(`editItemFund-${id}`).value);
        
        if (!newTitle) return alert("请输入标题");
        if (newFund === undefined || newFund === null) return alert("请输入有效金额");

        record.title = newTitle;
        record.fund = newFund;
        
        editingHistoryItemId = null;
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        updateUI();
        triggerAutoSave();
    }

    function closePendingCard() {
        const card = document.getElementById('pendingCard');
        const id = card.dataset.id;
        if(id) { pendingHiddenId = id.toString(); localStorage.setItem('habit_pending_hide', pendingHiddenId); card.style.display = 'none'; }
    }

    function calculateFunds() {
        let wallet = 0, debt = 0;
        historyData.forEach(i => {
            if(['theme-success'].includes(i.theme) || (i.details && i.details.recordType === 'todo-success')) { wallet += Math.abs(i.fund); }
            else if(i.theme === 'theme-shop') { wallet += i.fund; }
            else if(['theme-fix', 'theme-repair', 'theme-prevent'].includes(i.theme) || (i.details && i.details.recordType === 'todo-fail')) { debt += Math.abs(i.fund); }
            else if(i.theme === 'theme-pay') { debt -= Math.abs(i.fund); }
        });
        globalWallet = Math.max(0, wallet); globalDebt = Math.max(0, debt);
        document.getElementById('walletDisplay').innerText = globalWallet;
        document.getElementById('shopWalletDisplay').innerText = globalWallet;
        document.getElementById('debtDisplay').innerText = globalDebt;
    }

    function saveRecord(data, reload = true) { historyData.unshift({ id: Date.now(), date: document.getElementById('dateInput').value, ...data }); updateUI(); triggerAutoSave(); if(reload) setTimeout(() => location.reload(), 500); }

    function deleteItem(id){
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        if(confirm("删除此记录？\n(注意：关联的时间银行变动将自动回滚)")){
            if (record.details && record.details.time_bank_change) {
                const amount = parseFloat(record.details.time_bank_change);
                if (!isNaN(amount)) {
                    timeBank -= amount;
                    localStorage.setItem('habit_time_bank_v1', timeBank);
                    alert(`🔄 时间银行资金已回滚: ${amount > 0 ? '-' : '+'}${Math.abs(amount)}h`);
                }
            }

            historyData = historyData.filter(i => i.id !== id);
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
        }
    }

    function autoCalculate() {
        tempTimeDiff = 0; useTimeBank = false;
        const studyVal = parseFloat(document.getElementById('studyInput').value);
        const sleepVal = document.getElementById('sleepInput').value;
        const wakeVal = document.getElementById('wakeInput').value;

        if (!studyVal || studyVal < 0 || !sleepVal || !wakeVal) { 
            const card = document.getElementById('analysisCard');
            card.style.display = 'block';
            card.style.textAlign = 'center';
            card.innerHTML = `<div style="color:var(--danger); font-weight:bold; padding:20px;">⚠️ 请填全打卡数据后再结算</div>`;
            return; 
        }

        const limitWake = todayIsWeekend ? config.wakeW : config.wake;
        const limitSleep = todayIsWeekend ? config.sleepW : config.sleep;
        const p = config.penalties;
        let penalty = 0, reasons = [], faults = [], types = [];

        const diff = studyVal - config.study;
        tempTimeDiff = diff;

        if (diff < 0) {
            if (timeBank >= Math.abs(diff)) {
                if(confirm(`⚠️ 专注时长不足 ${Math.abs(diff)}h。\n⏳ 余额: ${timeBank.toFixed(1)}h。\n\n是否消耗存款抵消惩罚？`)) {
                    useTimeBank = true;
                } else {
                    types.push('study');
                    const gap = Math.abs(diff);
                    if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`少学<1h`); faults.push("轻微少学"); }
                    else { penalty += parseFloat(p.studyL); reasons.push(`少学≥1h`); faults.push("严重少学"); }
                }
            } else {
                types.push('study');
                const gap = Math.abs(diff);
                if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`少学<1h`); faults.push("轻微少学"); }
                else { penalty += parseFloat(p.studyL); reasons.push(`少学≥1h`); faults.push("严重少学"); }
            }
        }

        if (wakeVal > limitWake) { types.push('wake'); const diffW = toMin(wakeVal) - toMin(limitWake); if (diffW < 30) { penalty += parseFloat(p.wakeS); reasons.push(`晚起<30m`); faults.push("轻微晚起"); } else { penalty += parseFloat(p.wakeL); reasons.push(`晚起≥30m`); faults.push("严重晚起"); } }
        const actSleep = toAdjMin(sleepVal); const limSleep = toAdjMin(limitSleep);
        if (actSleep > limSleep) { types.push('sleep'); const diffS = actSleep - limSleep; if (diffS < 60) { penalty += parseFloat(p.sleepS); reasons.push(`晚睡<1h`); faults.push("轻微晚睡"); } else { penalty += parseFloat(p.sleepL); reasons.push(`晚睡≥1h`); faults.push("严重晚睡"); } }

        defaultFund = penalty > 0 ? -penalty : parseFloat(config.reward || 5);
        calcReason = penalty > 0 ? reasons.join(' | ') : "🎉 完美达标奖励";
        if(useTimeBank && penalty === 0) calcReason = "✨ 完美达标 (时间银行抵用)";

        failedTypes = types;
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">📊 诊断完成，请在下方确认结果...</div>`;
        renderForm(penalty > 0 ? (faults.length >= 2 ? 'repair' : 'fix') : 'success', null, useTimeBank);
    }

    function renderForm(type, extraInfo = null, isUsingBank = false) {
        const con = document.getElementById('formContainer');
        con.style.display = 'block';
        document.getElementById('inputCard').style.opacity = '0.5';
        document.getElementById('inputCard').style.pointerEvents = 'none';
        
        let inputs = [], title = '', theme = '', extraHTML = '';
        if (type === 'skip') {
            title = '🛌 申请休息'; theme = 'theme-skip'; defaultFund = 0; 
            inputs = [{l:'申请原因', id:'s_reason', p:'必填'}]; 
            extraHTML = `<div style="font-size:12px;color:var(--text-sub);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">ℹ️ 本月已休息 ${extraInfo} 次</div>`;
        } else if (type === 'prevent') {
            title = '🛡️ 主动干预'; theme = 'theme-prevent';
            const cost = config.preventCost || 10;
            defaultFund = -cost;
            inputs = [{l:'干预说明', id:'p_fix', p:'说明接下来的行动计划'}];
            extraHTML = `<div style="font-size:12px;color:var(--info);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">🛡️ 风险对冲金: ${cost} 元</div>`;
        } else if (type === 'repair') {
            title = '⚠️ 深度修复'; theme = 'theme-repair'; 
            inputs = [{l:'失控复盘', id:'r_reason', p:'分析原因'}, {l:'补救措施', id:'r_fix', p:'明日展示'}];
        } else if (type === 'fix') {
            title = '🟡 一级修正'; theme = 'theme-fix'; 
            inputs = [{l:'偏差原因', id:'f_reason', p:'简单描述'}, {l:'补偿计划', id:'f_plan', p:'明日展示'}];
        } else {
            title = '🎉 完美达标'; theme = 'theme-success'; 
            inputs = [{l:'今日成就', id:'s_note', p:'记下一件开心的事'}];
        }

        let moneyTip = defaultFund >= 0 ? `💰 奖励: +${defaultFund}` : `💸 扣罚: ${defaultFund}`; 
        if (defaultFund === 0) moneyTip = "无资金变动";

        let timeTip = '';
        if (isUsingBank) {
            timeTip = `<div style="font-size:12px;color:var(--time);background:var(--time-bg);padding:10px;border-radius:10px;margin-bottom:10px;">⏳ 银行支出: -${Math.abs(tempTimeDiff).toFixed(1)}h</div>`;
        }

        extraHTML += timeTip + `
            <div style="font-size:13px; font-weight:bold; color:${defaultFund>=0?'var(--success)':'var(--danger)'}; background:var(--bg-card); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px; text-align:center;">
                ${moneyTip} 元愿望金<br>
                <span style="font-weight:normal; opacity:0.8; font-size:11px; color:var(--text-sub)">${calcReason}</span>
            </div>`;

        let html = `
            <div class="card" style="margin-top:0px; border-top: 4px solid ${theme==='theme-success'?'var(--success)':'var(--warning)'}; animation: slideDown 0.4s ease;">
                <div class="card-title">${title}</div>
                ${extraHTML}
                <div style="background:var(--input-bg); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <span style="font-size:13px; font-weight:bold;">最终金额:</span>
                        <div style="display:flex;align-items:center;"><span style="margin-right:4px;">¥</span><input type="number" id="fundInput" value="${defaultFund}" oninput="checkFundEdit()" style="width:80px; padding:8px; text-align:right;"></div>
                    </div>
                    <div id="fundReasonBox" style="display:none; margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                        <label style="font-size:11px; color:var(--danger); font-weight:bold;">⚠️ 金额已修改，请填写原因:</label>
                        <input type="text" id="fundReason" placeholder="必填..." style="margin-top:4px; font-size:13px;">
                    </div>
                </div>
                ${inputs.map(i => `<div class="input-group"><label class="input-label">${i.l}</label><textarea id="${i.id}" placeholder="${i.p||''}" rows="2"></textarea></div>`).join('')}
                <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>
                <button class="btn-calc" onclick="submitForm('${theme}', '${title}')" style="margin-top:10px;">💾 确认提交并保存</button>
                <button class="btn-calc btn-secondary" onclick="cancelForm()" style="margin-top:8px;">✕ 取消</button>
            </div>`;
        con.innerHTML = html;
        if (['theme-repair', 'theme-fix'].includes(theme)) renderStrategies();
    }

    function checkFundEdit() { 
        const val = parseFloat(document.getElementById('fundInput').value); 
        const box = document.getElementById('fundReasonBox'); 
        if (val !== defaultFund) { box.style.display = 'block'; } else { box.style.display = 'none'; } 
    }

    function cancelForm() {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('analysisCard').style.display = 'none';
        document.getElementById('inputCard').style.opacity = '1';
        document.getElementById('inputCard').style.pointerEvents = 'auto';
    }

    function submitForm(theme, title) {
        if (theme === 'theme-skip' && !document.getElementById('s_reason').value.trim()) return alert("请填写申请原因");
        if (theme === 'theme-repair' && !document.getElementById('r_fix').value.trim()) return alert("请填写补救措施");
        
        const fund = parseFloat(document.getElementById('fundInput').value);
        const fundReason = document.getElementById('fundReason') ? document.getElementById('fundReason').value : '';
        if (fund !== defaultFund && !fundReason.trim()) return alert("⚠️ 请填写手动修改金额的原因！");

        let details = {};
        document.getElementById('formContainer').querySelectorAll('textarea, input[type=text]').forEach(i => { 
            if(i.id !== 'fundReason' && i.id.indexOf('input_')!==0) details[i.id] = i.value;
        });

        // 统一处理打卡原始数据
        const studyVal = parseFloat(document.getElementById('studyInput').value);
        const sleepVal = document.getElementById('sleepInput').value;
        const wakeVal = document.getElementById('wakeInput').value;
        if (studyVal) details.study = studyVal;
        if (sleepVal) details.sleep = sleepVal;
        if (wakeVal) details.wake = wakeVal;

        if (useTimeBank) {
            timeBank -= Math.abs(tempTimeDiff);
            details['time_bank_change'] = `-${Math.abs(tempTimeDiff).toFixed(1)}h`;
            localStorage.setItem('habit_time_bank_v1', timeBank);
        }

        if (calcReason && fund < 0 && theme !== 'theme-prevent') details['penalty_rule'] = calcReason;
        if (fund !== defaultFund) details['manual_edit_reason'] = fundReason;

        saveRecord({ fund, title, theme, details });
    }

    function quickSelectTask(name) {
        document.getElementById('timerTaskName').value = name;
        
        // 统计使用频次
        if (!taskUsageCount[name]) taskUsageCount[name] = 0;
        taskUsageCount[name]++;
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        
        // 重新渲染以更新排序
        renderQuickTasks();
    }

    function selectTodoForTimer(todoId) {
        // 确保能处理字符串和数字类型的ID
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        const todo = todoList.find(t => String(t.id) === id);
        if (!todo) {
            console.warn('待办未找到:', todoId);
            return;
        }
        
        // 设置任务名称
        const taskNameInput = document.getElementById('timerTaskName');
        if (taskNameInput) {
            taskNameInput.value = todo.title;
            // 在任务名称输入框上存储todoId，方便结束时识别
            taskNameInput.setAttribute('data-todo-id', id);
        }
        
        // 设置结束时间（如果待办有截止时间）
        if (todo.time) {
            const endTimeInput = document.getElementById('timerPlannedEndTime');
            if (endTimeInput) endTimeInput.value = todo.time;
        }
        
        // 如果有备注，也可以填充到备注框
        if (todo.note) {
            const noteInput = document.getElementById('timerNote');
            if (noteInput) noteInput.value = todo.note;
        }
    }

    function addPlannedTask() {
        const name = document.getElementById('timerTaskName').value.trim();
        const note = document.getElementById('timerNote').value.trim();
        const plannedTime = document.getElementById('timerPlannedTime').value;
        const plannedEndTime = document.getElementById('timerPlannedEndTime').value;
        if (!name) return alert("请输入计划的任务名称");

        const plan = {
            id: Date.now(),
            name: name,
            note: note,
            plannedTime: plannedTime,
            plannedEndTime: plannedEndTime
        };

        plannedTasks.push(plan);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        // 清空输入框
        document.getElementById('timerTaskName').value = '';
        document.getElementById('timerNote').value = '';
        initTimerTime();
        document.getElementById('timerPlannedEndTime').value = '';
        
        renderPlannedTasks();
        triggerAutoSave();
    }

    function renderPlannedTasks() {
        const list = document.getElementById('plannedTasksList');
        if (plannedTasks.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;font-size:13px;">暂无计划，快去添加一个吧</div>';
            return;
        }

        // 按时间排序，早的时间排在前面
        plannedTasks.sort((a, b) => {
            const timeA = a.plannedTime || '99:99';
            const timeB = b.plannedTime || '99:99';
            return timeA.localeCompare(timeB);
        });

        list.innerHTML = plannedTasks.map(p => {
            if (editingPlannedId === p.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">任务名称</label><input type="text" id="editPlanName-${p.id}" value="${p.name}" style="font-weight:bold;"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">起始时间</label><input type="time" id="editPlanStart-${p.id}" value="${p.plannedTime || ''}"></div>
                        <div class="input-group"><label class="input-label">结束时间</label><input type="time" id="editPlanEnd-${p.id}" value="${p.plannedEndTime || ''}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">备注</label><textarea id="editPlanNote-${p.id}" style="min-height:60px;">${p.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlinePlannedTask(${p.id})">💾 保存</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">✕ 取消</button>
                    </div>
                </div>`;
            }

            const idSuffix = `plan-${p.id}`;
            const showClass = openMenuId === idSuffix ? 'show' : '';

            return `
            <div class="list-item" style="border-left: 4px solid var(--info); padding-right: 8px;">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${p.name} 
                        ${p.plannedTime || p.plannedEndTime ? `
                        <span style="font-size:11px; color:var(--info); background:var(--border); padding:2px 6px; border-radius:4px; margin-left:4px;">
                            🕒 ${p.plannedTime || '--:--'}${p.plannedEndTime ? ' - ' + p.plannedEndTime : ''}
                        </span>` : ''}
                    </div>
                    ${p.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px;">' + p.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:4px; align-items:center;">
                    <button class="btn-mini" style="background:var(--success); color:#fff; padding:6px 10px;" onclick="startFromPlan(${p.id})">▶️ 开始</button>
                    
                    <div style="position:relative;">
                        <div class="btn-action" onclick="togglePlanMenu(event, '${idSuffix}')">⋮</div>
                        <div id="menu-${idSuffix}" class="action-menu action-menu-dropdown ${showClass}">
                            <div class="btn-mini" style="background:var(--time); color:#fff; width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="completePlannedTask(${p.id})">✅ 完成任务</div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="togglePinTask(${p.id})">
                                ${pinnedTaskId == p.id ? '📍 取消置顶' : '📌 设为置顶'}
                            </div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="editPlannedTask(${p.id})">✏️ 编辑任务</div>
                            <div class="btn-mini" style="background:var(--danger-bg); color:var(--danger); border:1px solid var(--danger); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="deletePlannedTask(${p.id})">✕ 删除计划</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function togglePlanMenu(event, id) {
        event.stopPropagation();
        if (openMenuId === id) {
            openMenuId = null;
        } else {
            closeAllMenus();
            openMenuId = id;
        }
        renderPlannedTasks();
    }

    let currentReviewDate = getLocalTodayStr();

    function saveDailyReview(showMsg = false) {
        const date = currentReviewDate;
        const great = document.getElementById('reviewGreat').value.trim();
        const improve = document.getElementById('reviewImprove').value.trim();
        
        if (!dailyReviews[date]) dailyReviews[date] = {};
        dailyReviews[date].great = great;
        dailyReviews[date].improve = improve;
        
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        triggerAutoSave();
        
        if(showMsg) alert(`✅ ${date === getLocalTodayStr() ? '今日' : date} 复盘已保存`);
        
        // 保存后重置回今日，防止误操作覆盖历史
        currentReviewDate = getLocalTodayStr();
    }

    function loadDailyReview() {
        const date = getLocalTodayStr();
        const review = dailyReviews[date] || { great: '', improve: '' };
        document.getElementById('reviewGreat').value = review.great || '';
        document.getElementById('reviewImprove').value = review.improve || '';
    }

    function toggleHistoryReview() {
        const area = document.getElementById('reviewHistoryArea');
        const inputArea = document.getElementById('reviewInputArea');
        const saveBtn = document.getElementById('btnSaveReview');
        isReviewHistoryOpen = !isReviewHistoryOpen;
        
        if (isReviewHistoryOpen) {
            area.style.display = 'block';
            inputArea.style.display = 'none';
            saveBtn.style.display = 'none';
            renderHistoryReviews();
        } else {
            area.style.display = 'none';
            inputArea.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            // 切换回来时，确保加载的是今日内容，除非用户正在编辑历史
            if (currentReviewDate === getLocalTodayStr()) {
                loadDailyReview();
            }
        }
    }

    function renderHistoryReviews() {
        const list = document.getElementById('reviewHistoryList');
        const sortedDates = Object.keys(dailyReviews).sort((a,b) => b.localeCompare(a));
        
        if (sortedDates.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">暂无历史复盘记录</div>';
            return;
        }

        list.innerHTML = sortedDates.map(date => {
            const r = dailyReviews[date];
            if (!r || (!r.great && !r.improve)) return '';
            return `
                <div class="review-history-item">
                    <div class="review-history-date">${date}</div>
                    ${r.great ? `
                        <div class="review-history-label">🌟 真棒:</div>
                        <div class="review-history-content">${r.great}</div>
                    ` : ''}
                    ${r.improve ? `
                        <div class="review-history-label">🚀 加油:</div>
                        <div class="review-history-content">${r.improve}</div>
                    ` : ''}
                    <div style="text-align:right; margin-top:8px;">
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); font-size:10px;" onclick="editHistoricalReview('${date}')">✏️ 调出并编辑</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editHistoricalReview(date) {
        const r = dailyReviews[date];
        if (!r) return;
        
        document.getElementById('reviewGreat').value = r.great || '';
        document.getElementById('reviewImprove').value = r.improve || '';
        currentReviewDate = date; // 切换保存目标日期
        
        // 自动切回到输入模式
        isReviewHistoryOpen = false;
        document.getElementById('reviewHistoryArea').style.display = 'none';
        document.getElementById('reviewInputArea').style.display = 'block';
        document.getElementById('btnSaveReview').style.display = 'inline-block';
        alert(`已调出 ${date} 的复盘内容，修改后点击保存将更新该日记录。`);
    }

    function editPlannedTask(id) {
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function saveInlinePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;

        const name = document.getElementById(`editPlanName-${id}`).value.trim();
        const start = document.getElementById(`editPlanStart-${id}`).value;
        const end = document.getElementById(`editPlanEnd-${id}`).value;
        const note = document.getElementById(`editPlanNote-${id}`).value.trim();

        if (!name) return alert("请输入名称");

        p.name = name;
        p.plannedTime = start;
        p.plannedEndTime = end;
        p.note = note;

        editingPlannedId = null;
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        updateStickyNotif(); // 更新置顶通知
        triggerAutoSave();
    }

    function togglePinTask(id) {
        if (pinnedTaskId == id) {
            pinnedTaskId = null;
        } else {
            pinnedTaskId = id;
        }
        localStorage.setItem('habit_pinned_task_id', pinnedTaskId || '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function unpinTask() {
        pinnedTaskId = null;
        localStorage.setItem('habit_pinned_task_id', '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function startPinnedTask() {
        let taskId = pinnedTaskId;
        // 如果没有手动置顶，则寻找下一个最近的任务
        if (!taskId) {
            const next = getNextPlannedTask();
            if (next) taskId = next.id;
        }

        if (taskId) {
            startFromPlan(parseInt(taskId));
            if (pinnedTaskId == taskId) unpinTask();
        }
    }

    function getNextPlannedTask() {
        if (plannedTasks.length === 0) return null;
        const nowHm = new Date().toTimeString().slice(0, 5);
        // 查找第一个起始时间大于等于当前时间的任务
        // (plannedTasks 已经按时间排好序了)
        return plannedTasks.find(p => p.plannedTime && p.plannedTime >= nowHm) || null;
    }

    function updateStickyNotif() {
        const bar = document.getElementById('stickyNotifBar');
        const notifTimer = document.getElementById('notifTimer');
        const notifPinned = document.getElementById('notifPinned');
        
        let hasContent = false;

        // 1. 更新计时器通知
        if (timerRunning) {
            notifTimer.style.display = 'flex';
            document.getElementById('notifTimerName').innerText = document.getElementById('timerTaskName').value || '任务';
            hasContent = true;
        } else {
            notifTimer.style.display = 'none';
        }

        // 2. 更新置顶通知 (优先手动置顶，其次自动显示下一个最近任务)
        let displayTask = null;
        let isAutoPinned = false;

        if (pinnedTaskId) {
            displayTask = plannedTasks.find(x => x.id == pinnedTaskId);
            if (!displayTask) {
                pinnedTaskId = null;
                localStorage.setItem('habit_pinned_task_id', '');
            }
        }

        if (!displayTask) {
            displayTask = getNextPlannedTask();
            isAutoPinned = !!displayTask;
        }

        if (displayTask) {
            notifPinned.style.display = 'flex';
            const prefix = isAutoPinned ? '🕒 下一计划: ' : '📌 置顶计划: ';
            document.getElementById('notifPinnedName').innerText = displayTask.name;
            document.getElementById('notifPinnedTime').innerText = displayTask.plannedTime ? `${prefix}${displayTask.plannedTime}` : prefix;
            hasContent = true;
        } else {
            notifPinned.style.display = 'none';
        }

        bar.style.display = hasContent ? 'flex' : 'none';
    }

    function startFromPlan(id) {
        const plan = plannedTasks.find(x => x.id === id);
        if (!plan) return;

        if (timerRunning) return alert("已有计时在进行中，请先结束当前计时");

        document.getElementById('timerTaskName').value = plan.name;
        document.getElementById('timerNote').value = plan.note || '';
        document.getElementById('timerPlannedTime').value = plan.plannedTime || '';
        document.getElementById('timerPlannedEndTime').value = plan.plannedEndTime || '';
        
        isTimerFromPlan = true; // 标记来自计划

        // 从计划中移除
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        renderPlannedTasks();
        startTimer(true); // 传入 true 表示不重置 isTimerFromPlan
        triggerAutoSave(); // 确保从计划开始也同步
    }

    function completePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;
        
        // 如果已经有起止时间，直接完成
        if (p.plannedTime && p.plannedEndTime) {
            const hours = getTimeDiff(p.plannedTime, p.plannedEndTime);
            if (hours > 0) {
                const record = {
                    id: Date.now(),
                    name: p.name,
                    duration: hours.toFixed(2),
                    seconds: Math.floor(hours * 3600),
                    note: p.note,
                    date: getLocalTodayStr(),
                    startTime: p.plannedTime,
                    time: p.plannedEndTime,
                    isPlanned: true
                };
                timerRecords.unshift(record);
                if (pinnedTaskId == id) unpinTask(); // 如果完成的是置顶任务，取消置顶
                plannedTasks = plannedTasks.filter(x => x.id !== id);
                localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
                localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                renderTimerHistory();
                renderPlannedTasks();
                updateUI();
                triggerAutoSave();
                alert("已完成并记录（不计入时间银行）");
                return;
            }
        }
        
        // 否则进入编辑状态完善时间
        alert("请完善计划的起止时间再点击完成");
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function deletePlannedTask(id) {
        if (!confirm("确定取消此计划？")) return;
        if (pinnedTaskId == id) unpinTask(); // 如果取消的是置顶任务，移除通知
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        triggerAutoSave();
    }

    function startTimer(fromPlan = false) {
        if (!document.getElementById('timerTaskName').value.trim()) return alert("请输入任务名称");
        timerRunning = true;
        timerPaused = false;
        if (!fromPlan) isTimerFromPlan = false; // 如果不是从计划开始，重置标志
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'none';
        if (activeBtns) activeBtns.style.display = 'flex';
        
        updateStickyNotif(); // 开启时显示置顶通知
        saveTimerState(); // 保存计时器状态
        triggerAutoSave(); // 同步到云端

        timerInterval = setInterval(() => {
            if (!timerPaused) {
                timerSeconds++;
                updateTimerUI();
                saveTimerState(); // 每秒保存一次状态到本地
            }
        }, 1000);
        
        // 每30秒同步一次到云端，确保多设备能及时获取最新状态
        timerSyncInterval = setInterval(() => {
            if (timerRunning) {
                console.log('🔄 定期同步计时器状态到云端...');
                triggerAutoSave();
            }
        }, 30000); // 30秒
    }

    function toggleTimerPause() {
        timerPaused = !timerPaused;
        document.getElementById('btnTimerPause').innerText = timerPaused ? '▶️ 继续' : '⏸️ 暂停';
        saveTimerState(); // 保存暂停状态
        triggerAutoSave(); // 同步到云端
    }

    function updateTimerUI() {
        const h = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        const clockStr = `${h}:${m}:${s}`;
        document.getElementById('timerClock').innerText = clockStr;
        
        // 同步更新置顶通知栏的时钟
        const notifClock = document.getElementById('notifTimerClock');
        if (notifClock) notifClock.innerText = clockStr;
    }

    function stopTimer() {
        if (!confirm("确认结束本次计时并保存？")) return;
        
        clearInterval(timerInterval);
        clearInterval(timerSyncInterval); // 清除同步定时器
        const hours = timerSeconds / 3600;
        const taskName = document.getElementById('timerTaskName').value;
        const note = document.getElementById('timerNote').value;
        const endTime = new Date().toTimeString().slice(0, 5);
        const startTime = calculateStartTime(endTime, hours);
        const taskInput = document.getElementById('timerTaskName');
        const todoId = taskInput.getAttribute('data-todo-id');

        // 保存记录
        const record = {
            id: Date.now(),
            name: taskName,
            duration: hours.toFixed(2),
            seconds: timerSeconds,
            note: note,
            date: getLocalTodayStr(),
            startTime: startTime,
            time: endTime,
            isPlanned: isTimerFromPlan,
            todoId: todoId ? parseInt(todoId) : null // 记录关联的待办ID
        };
        
        timerRecords.unshift(record);
        
        // 持久化
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        // 检查是否有关联的待办事项，提醒用户完成
        if (todoId) {
            const id = String(todoId);
            const todo = todoList.find(t => String(t.id) === id && t.status === 'pending');
            if (todo) {
                const reward = todo.reward || 0;
                const penalty = todo.penalty || 0;
                const message = `✅ 计时已结束！\n\n是否同时完成待办事项「${todo.title}」？\n\n完成将获得 +${reward} 元愿望金`;
                if (confirm(message)) {
                    finishTodo(id, 'success');
                }
            }
        }
        
        // 重置UI
        timerSeconds = 0;
        timerRunning = false;
        isTimerFromPlan = false; // 重置标志
        updateTimerUI();
        document.getElementById('timerTaskName').value = '';
        document.getElementById('timerTaskName').removeAttribute('data-todo-id'); // 清除关联
        document.getElementById('timerNote').value = '';
        initTimerTime();
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'flex';
        if (activeBtns) activeBtns.style.display = 'none';
        
        updateStickyNotif(); // 结束时移除计时通知
        
        // 清除计时器状态
        localStorage.removeItem('habit_timer_state_v1');

        renderTimerHistory();
        renderQuickTasks(); // 刷新快选胶囊（因为待办可能已完成）
        updateUI();
        triggerAutoSave();
    }

    function renderTimerHistory() {
        const list = document.getElementById('timerHistoryList');
        if (timerRecords.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:20px;">暂无计时记录</div>';
            return;
        }

        const limit = timerFullView ? timerRecords.length : (config.timerLimit || 5);
        const displayedRecords = timerRecords.slice(0, limit);

        list.innerHTML = displayedRecords.map(r => {
            const startTime = r.startTime || calculateStartTime(r.time, r.duration);
            
            if (editingTimerRecordId === r.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">任务名称</label><input type="text" id="editHistoryName-${r.id}" value="${r.name}" style="font-weight:bold;"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">起始时间</label><input type="time" id="editHistoryStart-${r.id}" value="${startTime}"></div>
                        <div class="input-group"><label class="input-label">结束时间</label><input type="time" id="editHistoryEnd-${r.id}" value="${r.time}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">备注</label><textarea id="editHistoryNote-${r.id}" style="min-height:60px;">${r.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryRecord(${r.id})">💾 保存</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">✕ 取消</button>
                    </div>
                </div>`;
            }

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${r.name}</div>
                    <div style="font-size:12px; color:var(--primary);">⏱️ ${r.duration}h | ${r.date} ${startTime} - ${r.time}</div>
                    ${r.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px; background:var(--input-bg); padding:4px; border-radius:4px;">' + r.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:8px;">
                    <div class="btn-action" onclick="editTimerRecord(${r.id})">✏️</div>
                    <div class="btn-action btn-del" onclick="deleteTimerRecord(${r.id})">✕</div>
                </div>
            </div>
        `;}).join('');

        // 如果有更多，显示一个提示
        if (!timerFullView && timerRecords.length > limit) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleTimerFullView()">
                    👇 仅显示最近 ${limit} 条记录，点击展开全部 (${timerRecords.length})
                </div>`
            );
        } else if (timerFullView && timerRecords.length > (config.timerLimit || 5)) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleTimerFullView()">
                    👆 点击收起长列表
                </div>`
            );
        }
    }

    function editTimerRecord(id) {
        editingTimerRecordId = id;
        renderTimerHistory();
    }

    function saveInlineHistoryRecord(id) {
        const r = timerRecords.find(x => x.id === id);
        if (!r) return;
        
        const name = document.getElementById(`editHistoryName-${id}`).value.trim();
        const start = document.getElementById(`editHistoryStart-${id}`).value;
        const end = document.getElementById(`editHistoryEnd-${id}`).value;
        const note = document.getElementById(`editHistoryNote-${id}`).value.trim();

        if (!name) return alert("请输入名称");

        const newDuration = getTimeDiff(start, end);
        if (!newDuration || newDuration < 0) return alert("时间设置不合法");

        r.name = name;
        r.startTime = start;
        r.time = end;
        r.duration = newDuration.toFixed(2);
        r.seconds = Math.floor(newDuration * 3600);
        r.note = note;

        editingTimerRecordId = null;
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        renderTimerHistory();
        updateUI();
        triggerAutoSave();
    }

    function deleteTimerRecord(id) {
        if (!confirm("确定删除此记录？")) return;
        timerRecords = timerRecords.filter(r => r.id !== id);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        renderTimerHistory();
        triggerAutoSave();
    }

    function toMin(t){ const[h,m]=t.split(':').map(Number); return h*60+m; }
    function toAdjMin(t){ let[h,m]=t.split(':').map(Number); if(h<12)h+=24; return h*60+m; }

    function calculateStartTime(endTime, durationHours) {
        let [h, m] = endTime.split(':').map(Number);
        let totalMin = h * 60 + m - Math.round(parseFloat(durationHours) * 60);
        while (totalMin < 0) totalMin += 24 * 60;
        let sh = Math.floor(totalMin / 60 % 24).toString().padStart(2, '0');
        let sm = (totalMin % 60).toString().padStart(2, '0');
        return `${sh}:${sm}`;
    }

    function getTimeDiff(start, end) {
        let [sh, sm] = start.split(':').map(Number);
        let [eh, em] = end.split(':').map(Number);
        let startMin = sh * 60 + sm;
        let endMin = eh * 60 + em;
        if (endMin < startMin) endMin += 24 * 60; 
        return (endMin - startMin) / 60;
    }

    function checkWeekend() {
        const date = new Date(document.getElementById('dateInput').value);
        const day = date.getDay();
        const we = config.weekend || [0, 6];
        todayIsWeekend = we.includes(day);
        document.getElementById('dayTypeBadge').style.display = todayIsWeekend ? 'inline-block' : 'none';
        document.getElementById('targetWake').innerText = `≤ ${todayIsWeekend ? config.wakeW : config.wake}`;
        document.getElementById('targetSleep').innerText = `≤ ${todayIsWeekend ? config.sleepW : config.sleep}`;
    }

    function setStatPeriod(p) {
        document.getElementById('statPeriod').value = p;
        renderStats();
    }

    function renderStats() {
        const period = document.getElementById('statPeriod').value;
        const todayStr = getLocalTodayStr();
        
        let filterDates = [];

        if (period === 'today') {
            filterDates = [todayStr];
        } else if (period === 'yesterday') {
            const yest = new Date();
            yest.setDate(yest.getDate() - 1);
            filterDates = [yest.toISOString().split('T')[0]];
        } else if (period === 'all') {
            filterDates = historyData.map(r => r.date);
        } else {
            const days = parseInt(period);
            for(let i=days-1; i>=0; i--) { 
                const d=new Date(); 
                d.setDate(d.getDate()-i); 
                filterDates.push(d.toISOString().split('T')[0]); 
            }
        }

        // 热力图始终显示最近7天
        const heatmapDates = [];
        for(let i=6; i>=0; i--) { const d=new Date(); d.setDate(d.getDate()-i); heatmapDates.push(d.toISOString().split('T')[0]); }
        const hm = document.getElementById('heatmap');
        hm.innerHTML = heatmapDates.map(date => {
            const rec = historyData.find(r => r.date === date);
            let cls = 'hm-none';
            if (rec) { if (rec.theme.includes('success')) cls = 'hm-success'; else if (rec.theme.includes('fix')) cls = 'hm-fix'; else if (rec.theme.includes('repair')) cls = 'hm-repair'; }
            return `<div class="heatmap-day"><div class="heatmap-box ${cls}"></div><div style="font-size:9px;color:var(--text-sub)">${date.slice(5)}</div></div>`;
        }).join('');

        const filteredHistory = historyData.filter(r => filterDates.includes(r.date) && !['theme-skip','theme-shop','theme-pay'].includes(r.theme));
        const total = filteredHistory.reduce((a,c) => a + parseFloat(c.study||0), 0);
        const rate = filteredHistory.length ? Math.round((filteredHistory.filter(r => r.theme==='theme-success').length/filteredHistory.length)*100) : 0;
        
        document.getElementById('statStudy').innerText = total.toFixed(1) + 'h';
        document.getElementById('statRate').innerText = rate + '%';

        // 专注计时统计也受周期影响
        const filteredTimerRecords = timerRecords.filter(r => filterDates.includes(r.date));
        const timerTotal = filteredTimerRecords.reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerToday = timerRecords.filter(r => r.date === todayStr).reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerCount = filteredTimerRecords.length;
        const timerAvg = timerCount > 0 ? (timerTotal / timerCount) : 0;

        document.getElementById('statTimerTotal').innerText = timerTotal.toFixed(1) + 'h';
        document.getElementById('statTimerToday').innerText = timerToday.toFixed(1) + 'h';
        document.getElementById('statTimerCount').innerText = timerCount;
        document.getElementById('statTimerAvg').innerText = timerAvg.toFixed(1) + 'h';

        // 热门任务统计
        const taskMap = {};
        filteredTimerRecords.forEach(r => {
            taskMap[r.name] = (taskMap[r.name] || 0) + parseFloat(r.duration);
        });
        const topTasks = Object.entries(taskMap)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3);
        
        const topTasksHtml = topTasks.length > 0 
            ? '<div style="margin-top:10px; font-weight:bold; margin-bottom:5px;">🔥 热门任务:</div>' + 
              topTasks.map(([name, dur], i) => `
                <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid var(--border);">
                    <span>${i+1}. ${name}</span>
                    <span style="color:var(--primary); font-weight:bold;">${dur.toFixed(1)}h</span>
                </div>
              `).join('')
            : '<div style="text-align:center; color:var(--text-sub); margin-top:10px;">该周期内暂无计时数据</div>';
        
        document.getElementById('statTimerTopTasks').innerHTML = topTasksHtml;
    }

    function exportCSV(){
        let c="日期,类型,基金,详情\n";
        historyData.forEach(i=>c+=`${i.date},${i.title},${i.fund},"${Object.values(i.details||{}).join('|')}"\n`);
        const l=document.createElement("a");
        l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));
        l.download="data.csv";
        l.click();
    }

    function exportJSON() {
        const backup = { history: historyData, config: config, todos: todoList, wishes: wishList, strategies: userStrategies, gh: ghConfig, timeBank: timeBank, dailyReviews: dailyReviews, taskUsageCount: taskUsageCount };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "habit_backup_" + getTimestampStr() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importJSON(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { const data = JSON.parse(e.target.result); restoreData(data); }
            catch(err) { alert("❌ 文件格式错误，无法恢复"); }
        };
        reader.readAsText(file);
    }

    function restoreData(data) {
        if(confirm("⚠️ 警告：确定要覆盖当前所有数据吗？此操作不可撤销。")) {
            const historyToRestore = data.history || data.data;
            if(historyToRestore) localStorage.setItem('habit_data_v15', JSON.stringify(historyToRestore));

            if(data.config) localStorage.setItem('habit_config_v7', JSON.stringify(data.config));
            if(data.todos) localStorage.setItem('habit_todos_v1', JSON.stringify(data.todos));
            if(data.wishes) localStorage.setItem('habit_wishes_v1', JSON.stringify(data.wishes));
            if(data.strategies) localStorage.setItem('habit_strategies_v1', JSON.stringify(data.strategies));
            if(data.gh) localStorage.setItem('habit_gh_v1', JSON.stringify(data.gh));
            if(data.timeBank !== undefined) localStorage.setItem('habit_time_bank_v1', data.timeBank);
            if(data.dailyReviews) localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(data.dailyReviews));
            if(data.taskUsageCount) localStorage.setItem('habit_task_usage_v1', JSON.stringify(data.taskUsageCount));
            alert("✅ 数据恢复成功！页面即将刷新..."); location.reload();
        }
    }

    function triggerAutoSave() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        // 计时器状态已经由saveTimerState()单独保存
        syncGitHub('push', true);
    }

    function saveSettings(){
        ghConfig.token = document.getElementById('ghToken').value.trim();
        ghConfig.repo = document.getElementById('ghRepo').value.trim();
        localStorage.setItem('habit_gh_v1', JSON.stringify(ghConfig));

        config = {
            wake: document.getElementById('setWake').value,
            sleep: document.getElementById('setSleep').value,
            study: parseFloat(document.getElementById('setStudy').value),
            expiredLimit: parseInt(document.getElementById('setExpiredLimit').value) || 5,
            timerLimit: parseInt(document.getElementById('setTimerLimit').value) || 5,
            historyLimit: parseInt(document.getElementById('setHistoryLimit').value) || 5,
            quickTasks: config.quickTasks || [],
            wakeW: document.getElementById('setWakeW').value,
            sleepW: document.getElementById('setSleepW').value,
            initialPage: document.getElementById('setInitialPage').value,
            reward: parseFloat(document.getElementById('rewardAmount').value) || 0,
            preventCost: parseFloat(document.getElementById('preventCost').value) || 0,
            exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 5,
            penalties: {
                wakeS: parseFloat(document.getElementById('pWakeS').value) || 0,
                wakeL: parseFloat(document.getElementById('pWakeL').value) || 0,
                sleepS: parseFloat(document.getElementById('pSleepS').value) || 0,
                sleepL: parseFloat(document.getElementById('pSleepL').value) || 0,
                studyS: parseFloat(document.getElementById('pStudyS').value) || 0,
                studyL: parseFloat(document.getElementById('pStudyL').value) || 0
            },
            weekend: config.weekend || [0, 6]
        };
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
        alert("配置已保存");
    }

    function applySettingsToUI(){
        document.getElementById('setWake').value = config.wake;
        document.getElementById('setSleep').value = config.sleep;
        document.getElementById('setStudy').value = config.study;
        document.getElementById('setExpiredLimit').value = config.expiredLimit || 5;
        document.getElementById('setTimerLimit').value = config.timerLimit || 5;
        document.getElementById('setHistoryLimit').value = config.historyLimit || 5;
        document.getElementById('setWakeW').value = config.wakeW;
        document.getElementById('setSleepW').value = config.sleepW;
        document.getElementById('setInitialPage').value = config.initialPage || 'checkin';
        document.getElementById('rewardAmount').value = config.reward;
        document.getElementById('preventCost').value = config.preventCost || 10;
        document.getElementById('exchangeRate').value = config.exchangeRate || 5;

        if(config.penalties) {
            document.getElementById('pWakeS').value = config.penalties.wakeS;
            document.getElementById('pWakeL').value = config.penalties.wakeL;
            document.getElementById('pSleepS').value = config.penalties.sleepS;
            document.getElementById('pSleepL').value = config.penalties.sleepL;
            document.getElementById('pStudyS').value = config.penalties.studyS;
            document.getElementById('pStudyL').value = config.penalties.studyL;
        }

        const we = config.weekend || [0, 6];
        document.getElementById('btn_week_6').className = `week-btn ${we.includes(6)?'active':''}`;
        document.getElementById('btn_week_0').className = `week-btn ${we.includes(0)?'active':''}`;

        renderQuickTaskSettings();

        // 填充手动调节数值
        document.getElementById('adjTimeBank').value = Number(timeBank).toFixed(1);
        document.getElementById('adjWallet').value = globalWallet;
        document.getElementById('adjDebt').value = globalDebt;
    }

    function renderQuickTasks() {
        const container = document.getElementById('quickTasksContainer');
        if (!container) return;
        
        // 获取预设快捷任务
        let tasks = config.quickTasks || [];
        
        // 获取今日待办事项（仅"去做"类型，未完成的）
        const todayStr = getLocalTodayStr();
        const todayTodos = todoList.filter(t => 
            t.type === 'do' && 
            t.status === 'pending' && 
            t.date === todayStr &&
            !t.archived
        );
        
        // 合并任务列表（不再包含待办，待办通过固定按钮选择）
        const allTasks = tasks.map(t => ({ name: t, isTodo: false }));
        
        // 为非待办任务添加使用频次并排序
        allTasks.forEach(task => {
            if (!task.isTodo) {
                task.count = taskUsageCount[task.name] || 0;
            }
        });
        
        allTasks.sort((a, b) => b.count - a.count);
        
        container.style.display = 'flex';
        container.style.flexWrap = 'wrap';
        container.style.gap = '8px';
        
        // 首先添加固定的"待办"按钮
        let html = `<div class="chip" style="background:var(--success-bg);border-color:var(--success);color:var(--success);font-weight:700;cursor:pointer;" onclick="showTodoSelectModal()">📋 待办</div>`;
        
        // 然后添加其他快捷任务
        if (allTasks.length > 0) {
            html += allTasks.map(task => {
                return `<div class="chip" onclick="quickSelectTask('${task.name.replace(/'/g, "\\'")}')">${task.name}</div>`;
            }).join('');
        } else {
            html += '<div style="text-align:center;color:var(--text-sub);font-size:11px;padding:8px;width:100%;">暂无快选项，去设置中添加吧</div>';
        }
        
        container.innerHTML = html;
    }
    
    function showTodoSelectModal() {
        const modal = document.getElementById('todoSelectModal');
        const list = document.getElementById('todoSelectList');
        if (!modal || !list) return;
        
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        
        // 获取所有未完成的待办（包括今日和未来的）
        const availableTodos = todoList.filter(t => {
            if (t.archived) return false;
            if (t.status !== 'pending') return false;
            if (t.date < todayStr) return false;
            if (t.date === todayStr && t.time && currentHm > t.time) return false;
            return true;
        });
        
        if (availableTodos.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">暂无可用待办事项</div>';
        } else {
            // 按日期和时间排序
            availableTodos.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || '99:99').localeCompare(b.time || '99:99');
            });
            
            list.innerHTML = availableTodos.map(t => {
                const dateBadge = t.date > todayStr ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.date.slice(5)}</span>` : '';
                const timeBadge = t.time ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.time}</span>` : '';
                const importance = t.importance || 1;
                const importanceColors = { 3: 'var(--danger)', 2: 'var(--warning)', 1: 'var(--success)' };
                const importanceDot = `<span style="width:10px; height:10px; border-radius:50%; background:${importanceColors[importance]}; display:inline-block; margin-right:4px;"></span>`;
                
                return `
                    <div class="list-item" style="cursor:pointer; margin-bottom:8px;" onclick="selectTodoFromModal('${String(t.id)}')">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:var(--text-main); display:flex; align-items:center;">
                                ${importanceDot}${t.title} ${timeBadge} ${dateBadge}
                            </div>
                            ${t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:4px;">${t.note}</div>` : ''}
                            <div style="font-size:11px;color:var(--text-sub);margin-top:4px;">奖${t.reward || 0} / 罚${t.penalty || 0}</div>
                        </div>
                        <div style="color:var(--success); font-size:20px;">✓</div>
                    </div>
                `;
            }).join('');
        }
        
        modal.style.display = 'flex';
    }
    
    function closeTodoSelectModal() {
        const modal = document.getElementById('todoSelectModal');
        if (modal) modal.style.display = 'none';
    }
    
    function selectTodoFromModal(todoId) {
        // 确保todoId是字符串或数字都能处理
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        selectTodoForTimer(id);
        closeTodoSelectModal();
    }

    function renderQuickTaskSettings() {
        const list = document.getElementById('setQuickTasksList');
        if (!list) return;
        
        // 创建任务数组并附加使用频次信息
        let tasks = (config.quickTasks || []).map((t, idx) => ({
            name: t,
            index: idx,
            count: taskUsageCount[t] || 0
        }));
        
        // 按使用频次排序
        tasks.sort((a, b) => b.count - a.count);
        
        list.innerHTML = tasks.map(t => {
            return `<div class="chip chip-removable" onclick="removeQuickTask(${t.index})">${t.name}</div>`;
        }).join('');
    }

    function addQuickTask() {
        const input = document.getElementById('input_quicktask');
        const val = input.value.trim();
        if(!val) return;
        if(!config.quickTasks) config.quickTasks = [];
        config.quickTasks.push(val);
        input.value = '';
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        triggerAutoSave();
    }

    function removeQuickTask(idx) {
        if(!confirm(`删除此快捷项?`)) return;
        const removedTask = config.quickTasks[idx];
        config.quickTasks.splice(idx, 1);
        
        // 同时删除该任务的使用频次记录
        if (taskUsageCount[removedTask]) {
            delete taskUsageCount[removedTask];
            localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        }
        
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        renderQuickTasks();
        triggerAutoSave();
    }

    function resetTaskUsage() {
        if(!confirm('确定要重置所有任务的使用频次统计吗？')) return;
        taskUsageCount = {};
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        renderQuickTasks();
        renderQuickTaskSettings();
        alert('✅ 使用频次已重置');
        triggerAutoSave();
    }

    function applyManualAdjustment() {
        const newTimeBank = parseFloat(document.getElementById('adjTimeBank').value);
        const newWallet = parseFloat(document.getElementById('adjWallet').value);
        const newDebt = parseFloat(document.getElementById('adjDebt').value);
        const reason = document.getElementById('adjReason').value.trim();

        if (newTimeBank === undefined || newTimeBank === null || newWallet === undefined || newWallet === null || newDebt === undefined || newDebt === null) return alert("请输入有效数值");
        if (!reason) return alert("请输入修改原因");

        const today = getLocalTodayStr();
        let changed = false;

        // 1. 调整时间银行
        const diffTB = newTimeBank - timeBank;
        if (Math.abs(diffTB) > 0.01) {
            timeBank = newTimeBank;
            localStorage.setItem('habit_time_bank_v1', timeBank);
            // 记录时间银行变动
            historyData.unshift({
                id: Date.now() + 1,
                date: today,
                title: "⏳ 时间银行手动调节",
                fund: 0,
                theme: "theme-skip",
                details: { manual_edit_reason: reason, note: (diffTB > 0 ? "+" : "") + diffTB.toFixed(1) + "h" }
            });
            changed = true;
        }

        // 2. 调整愿望金 (Wallet)
        const diffW = newWallet - globalWallet;
        if (Math.abs(diffW) > 0.01) {
            historyData.unshift({
                id: Date.now() + 2,
                date: today,
                title: "💰 愿望金手动调节",
                fund: diffW,
                theme: diffW > 0 ? "theme-success" : "theme-shop",
                details: { manual_edit_reason: reason }
            });
            changed = true;
        }

        // 3. 调整待罚金 (Debt)
        const diffD = newDebt - globalDebt;
        if (Math.abs(diffD) > 0.01) {
            historyData.unshift({
                id: Date.now() + 3,
                date: today,
                title: "💸 待罚金手动调节",
                fund: diffD,
                theme: diffD > 0 ? "theme-repair" : "theme-pay",
                details: { manual_edit_reason: reason, note: diffD > 0 ? "手动增加" : "手动减少" }
            });
            changed = true;
        }

        if (changed) {
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
            alert("数据已成功修正，调整已记录至历史档案。");
            document.getElementById('adjReason').value = '';
        } else {
            alert("数值未发生变化，无需调整。");
        }
    }

    async function syncGitHub(action, isAuto) {
        const token = ghConfig.token;
        const repo = ghConfig.repo;
        const path = ghConfig.path || 'habit_backup.json';
        if(!token || !repo) {
            if(!isAuto) alert("请先配置 GitHub");
            return;
        }

        setSyncBadgeStatus('status-syncing', action==='push'?'上传...':'同步...');

        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };

            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });

            let sha = null, cloudData = null;

            if(getRes.ok) {
                const d = await getRes.json();
                sha = d.sha || null;
                cloudData = JSON.parse(decodeURIComponent(escape(atob((d.content || '').replace(/\n/g,"")))));
            }

            if(action === 'pull') {
                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;

                let shouldApply = false;
                if (cloudData && cloudTs > localTs) {
                    shouldApply = true;
                } else if (cloudData && !isAuto) {
                    shouldApply = confirm(`云端数据时间戳(${cloudTs})并不比本地新(${localTs})。\n仍要用云端覆盖本地吗？`);
                }

                if(shouldApply) {
                    if(cloudData.data) historyData = stripImagesFromHistory(cloudData.data);
                    if(cloudData.config) config = cloudData.config;
                    if(cloudData.todos) todoList = cloudData.todos;
                    if(cloudData.strategies) userStrategies = cloudData.strategies;
                    if(cloudData.wishes) wishList = cloudData.wishes;
                    if(cloudData.timerRecords) timerRecords = cloudData.timerRecords;
                    if(cloudData.plannedTasks) plannedTasks = cloudData.plannedTasks;
                    if(cloudData.dailyReviews) dailyReviews = cloudData.dailyReviews;
                    if(cloudData.taskUsageCount) taskUsageCount = cloudData.taskUsageCount;
                    if(cloudData.pinnedTaskId) {
                        pinnedTaskId = cloudData.pinnedTaskId;
                        localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
                    }
                    
                    // 同步计时器状态
                    if(cloudData.timerState && cloudData.timerState.running) {
                        // 如果云端有正在运行的计时器，保存到本地
                        localStorage.setItem('habit_timer_state_v1', JSON.stringify(cloudData.timerState));
                        console.log('📥 从云端同步到计时器状态:', cloudData.timerState.taskName);
                    } else {
                        // 如果云端没有运行的计时器，清除本地的
                        localStorage.removeItem('habit_timer_state_v1');
                        console.log('🧹 清除本地计时器状态（云端无活动计时器）');
                    }

                    if(cloudData.timeBank !== undefined) timeBank = cloudData.timeBank;

                    persistAllLocal();
                    localStorage.setItem('habit_last_save', String(cloudTs || Date.now()));

                    setSyncBadgeStatus('status-idle', '已更新');
                    updateUI(); renderTodos(); checkDateChange(); applySettingsToUI(); renderStrategySettings();
                    if (typeof renderTimerHistory === 'function') renderTimerHistory();
                    if (typeof renderPlannedTasks === 'function') renderPlannedTasks();
                    
                    // 恢复计时器状态（会自动处理有/无计时器的情况）
                    restoreTimerState();
                    updateStickyNotif();

                    if(!isAuto) alert("✅ 同步成功：已从云端同步所有数据");
                } else {
                    setSyncBadgeStatus('status-idle', '已最新');
                    if(!isAuto) alert("✅ 同步完成：本地数据已是最新");
                }
            } else {
                // 获取当前计时器状态
                const timerStateStr = localStorage.getItem('habit_timer_state_v1');
                const timerState = timerStateStr ? JSON.parse(timerStateStr) : null;
                
                if (timerState && timerState.running) {
                    console.log('📤 正在上传计时器状态到云端:', timerState.taskName, '已计时', Math.floor(timerState.seconds / 60), '分钟');
                }
                
                const content = {
                    timestamp: Date.now(),
                    data: stripImagesFromHistory(historyData),
                    config,
                    todos: todoList,
                    wishes: wishList,
                    strategies: userStrategies,
                    timeBank: timeBank,
                    timerRecords: timerRecords,
                    plannedTasks: plannedTasks,
                    dailyReviews: dailyReviews,
                    taskUsageCount: taskUsageCount,
                    pinnedTaskId: pinnedTaskId,
                    timerState: timerState // 包含计时器状态
                };

                const body = {
                    message: "Sync",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content))))
                };
                if (sha) body.sha = sha;

                await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) });

                setSyncBadgeStatus('status-idle', '已同步');
                localStorage.setItem('habit_last_save', String(content.timestamp));
                if(!isAuto) alert("✅ 同步成功：数据已上传至云端");
            }
        } catch(e) {
            console.error(e);
            setSyncBadgeStatus('status-error', '失败');
            if(!isAuto) alert("❌ 同步失败，请检查网络或Token");
        }

        setTimeout(()=>setSyncBadgeStatus('status-idle', document.getElementById('syncText').innerText || '本地模式'), 2000);
    }

    async function archiveToGitHub() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("请先配置 GitHub Token");
        if(!confirm("确定要创建一个永久存档吗？")) return;

        setSyncBadgeStatus('status-syncing', '上传...');

        const timestamp = getTimestampStr();
        const path = `backups/habit_archive_${timestamp}.json`;

        try {
            const content = {
                timestamp: Date.now(),
                data: stripImagesFromHistory(historyData),
                config,
                todos: todoList,
                wishes: wishList,
                strategies: userStrategies,
                timeBank: timeBank,
                timerRecords: timerRecords,
                plannedTasks: plannedTasks,
                dailyReviews: dailyReviews,
                taskUsageCount: taskUsageCount,
                pinnedTaskId: pinnedTaskId
            };
            const body = { message: `Archive ${timestamp}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))) };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" }, body: JSON.stringify(body) });
            if(res.ok) alert(`✅ 存档成功！\n文件名: ${path}`);
            else alert("❌ 存档失败");
        } catch(e) { alert("❌ 发生错误"); }

        setSyncBadgeStatus('status-idle', '本地模式');
    }

    async function listCloudBackups() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("请先配置 GitHub Token");

        const listEl = document.getElementById('cloudBackupList');
        listEl.style.display = 'block';
        listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">⌛ 正在加载列表...</div>';

        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/backups`, { headers });
            if(!res.ok) throw new Error("Fetch failed");

            const files = await res.json();
            if(!Array.isArray(files) || files.length === 0) {
                listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">📂 无云端存档。</div>';
                return;
            }
            files.sort((a,b) => b.name.localeCompare(a.name));
            listEl.innerHTML = files.map(f => `<div class="backup-file-item" onclick="restoreCloudBackup('${f.path}')"><span>📄 ${f.name}</span><span style="font-size:10px; color:var(--info);">恢复此版</span></div>`).join('');
        } catch(e) { listEl.innerHTML = '<div style="padding:12px;color:var(--danger);">❌ 获取失败。</div>'; }
    }

    async function restoreCloudBackup(path) {
        if(!confirm("⚠️ 确定要从云端文件 [" + path + "] 恢复数据吗？")) return;
        const token = ghConfig.token; const repo = ghConfig.repo;
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
            const d = await res.json();
            const content = JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,"")))));
            restoreData(content);
        } catch(e) { alert("❌ 恢复失败。"); }
    }

    function renderStrategies() {
        const container = document.getElementById('strategyArea');
        if (!container) return;
        container.innerHTML = '';
        if (!historyData || historyData.length === 0) return;
        const lastRecord = historyData[0];
        if (!lastRecord || !lastRecord.details || !lastRecord.details.penalty_rule) return;
        
        let failedTypes = [];
        if (lastRecord.details.penalty_rule.includes('少学')) failedTypes.push('study');
        if (lastRecord.details.penalty_rule.includes('晚起')) failedTypes.push('wake');
        if (lastRecord.details.penalty_rule.includes('晚睡')) failedTypes.push('sleep');

        if (failedTypes.length === 0) return;

        let suggestions = [];
        failedTypes.forEach(type => {
            if (userStrategies[type] && Array.isArray(userStrategies[type])) {
                suggestions = suggestions.concat(userStrategies[type]);
            }
        });

        if (suggestions.length === 0) return;

        const html = `
            <div style="width:100%; font-size:11px; color:var(--text-sub); margin:8px 0 4px 0; font-weight:600;">💡 点击引用补救策略:</div>
            ${suggestions.map(s => `<div class="chip" onclick="fillStrategy('${s}')" style="background:var(--input-bg);border-color:var(--primary);color:var(--primary)">${s}</div>`).join('')}
        `;
        container.innerHTML = html;
    }

    function fillStrategy(txt) {
        const targetIds = ['r_fix', 'f_plan'];
        let target = null;
        for(let id of targetIds) {
            if(document.getElementById(id)) { target = document.getElementById(id); break; }
        }
        if(target) {
            const oldVal = target.value;
            target.value = oldVal ? (oldVal + " + " + txt) : txt;
            target.style.borderColor = 'var(--primary)';
            setTimeout(()=>target.style.borderColor='var(--border)', 300);
        }
    }

    function toggleExpiredFullView() {
        expiredFullView = !expiredFullView;
        renderTodos();
    }

    function toggleTimerFullView() {
        timerFullView = !timerFullView;
        renderTimerHistory();
    }

    function toggleHistoryFullView() {
        historyFullView = !historyFullView;
        updateUI();
    }

    init();
</script>
</body>
</html>
