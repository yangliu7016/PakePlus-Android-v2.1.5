<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Habit</title>

    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f3f4f6">
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/task.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/32/task.png">

    <style>
        /* ================== CSS å˜é‡å®šä¹‰ ================== */
        :root {
            /* â˜€ï¸ æ—¥é—´æ¨¡å¼ */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --text-main: #1f2937;
            --text-sub: #6b7280;
            --border: #e5e7eb;
            --input-bg: #f9fafb;
            --header-bg: rgba(255, 255, 255, 0.95);

            /* åŠŸèƒ½è‰² */
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --info: #3b82f6;

            /* æ—¶é—´é“¶è¡Œè‰² (Indigo/Purple) */
            --time: #6366f1;
            --time-bg: #e0e7ff;

            /* é˜´å½±ä¸è¾¹è· */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        /* ğŸŒ™ å¤œé—´æ¨¡å¼ */
        [data-theme="dark"] {
            --primary: #818cf8;
            --primary-dark: #6366f1;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            --input-bg: #111827;
            --header-bg: rgba(17, 24, 39, 0.95);

            --success: #34d399;
            --success-bg: rgba(6, 78, 59, 0.4);
            --warning: #fbbf24;
            --warning-bg: rgba(69, 26, 3, 0.4);
            --danger: #f87171;
            --danger-bg: rgba(69, 10, 10, 0.4);

            --time: #818cf8;
            --time-bg: rgba(67, 56, 202, 0.4);

            --shadow: none;
        }

        /* ================== åŸºç¡€æ ·å¼ ================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: calc(90px + var(--safe-area-bottom));
            line-height: 1.5;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* Header */
        .header {
            background: var(--header-bg); backdrop-filter: blur(10px);
            padding: 10px 14px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border);
            height: 56px;
            box-sizing: border-box;
        }

        /* Sticky Notification Bar */
        .sticky-notif-bar {
            position: sticky;
            top: 56px;
            z-index: 999;
            background: var(--header-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border);
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 3px;
            padding: 6px 14px;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .notif-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            font-weight: 600;
            padding: 5px 8px;
            border-radius: 6px;
        }
        .notif-timer { background: var(--success-bg); color: var(--success); border: 1px solid rgba(52, 211, 153, 0.2); }
        .notif-pinned { background: var(--time-bg); color: var(--time); border: 1px solid rgba(129, 140, 248, 0.2); }
        .notif-quick-study { background: var(--primary-bg); color: var(--primary); border: 1px solid rgba(59, 130, 246, 0.3); }
        .notif-btn { font-size: 12px; cursor: pointer; opacity: 0.9; padding: 4px 12px; border-radius: 6px; transition: all 0.2s; }
        .notif-btn:hover { opacity: 1; transform: scale(1.05); }

        .header-left { display: flex; align-items: center; gap: 8px; flex-shrink: 0; height: 100%;}
        .header-title {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 8px;
            justify-content: flex-start;
        }
        .header-title h1 {
            margin: 0; font-size: 16px; font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, #a855f7 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            line-height: 1;
            padding: 0;
            display: block;
            text-indent: 0;
            letter-spacing: 0;
            position: relative;
        }

        .sync-badge {
            font-size: 10px; font-weight: 600; display: flex; align-items: center; gap: 4px;
            opacity: 0.9; color: var(--text-sub); background: var(--input-bg);
            padding: 3px 7px; border-radius: 10px; border: 1px solid var(--border);
            cursor: pointer; transition: all 0.2s;
            line-height: 1;
            margin: 0;
            display: inline-flex;
        }
        .sync-badge:active { transform: scale(0.95); background: var(--border); }
        .sync-icon { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #d1d5db; }
        .status-idle .sync-icon { background: var(--success); }
        .status-syncing .sync-icon { background: transparent; border: 2px solid var(--info); border-top-color: transparent; width: 10px; height: 10px; animation: spin 0.8s linear infinite; }
        .status-error .sync-icon { background: var(--danger); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .header-right {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: nowrap;
            height: 100%;
        }
        .theme-btn {
            background: none; border: 1px solid var(--border); font-size: 14px;
            cursor: pointer; padding: 0; width: 28px; height: 28px;
            border-radius: 50%; transition: all 0.3s; color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }

        .fund-badge {
            padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 4px;
            white-space: nowrap; flex-shrink: 0; height: 28px; cursor: pointer;
            line-height: 1;
        }
        .badge-wallet { background: var(--warning-bg); color: var(--warning); border: 1px solid var(--border); }
        .badge-debt { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--border); }
        .badge-time { background: var(--time-bg); color: var(--time); border: 1px solid var(--border); }

        .container { max-width: 500px; margin: 12px auto; padding: 0 14px; position: relative; z-index: 1; }
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        .card[style*="border-color:var(--primary)"] {
            background: transparent;
        }
        #view-todo .card {
            background: transparent;
            padding: 12px !important;
        }
        .card-title { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }

        .toggle-container { display: flex; background: var(--border); padding: 3px; border-radius: 10px; margin-bottom: 12px; }
        .toggle-btn { flex: 1; text-align: center; padding: 6px; font-size: 12px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--primary); box-shadow: var(--shadow); }

        .week-btn {
            padding: 10px 16px; border-radius: 10px; background: var(--input-bg);
            border: 1px solid var(--border); color: var(--text-sub);
            font-size: 13px; font-weight: bold; cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px; flex: 1; justify-content: center;
        }
        .week-btn.active {
            background: var(--info); color: #fff; border-color: var(--info);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .input-group { margin-bottom: 10px; }
        .input-label { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-bottom: 4px; font-weight: 600;}
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        input, select, textarea {
            width: 100%; padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--input-bg);
            color: var(--text-main);
            font-weight: 600;
            outline: none; -webkit-appearance: none;
            font-family: inherit;
            text-align: left;
        }
        textarea { resize: vertical; min-height: 36px; }
        input:focus, textarea:focus { border-color: var(--primary); }

        button { user-select: none; -webkit-tap-highlight-color: transparent; }
        .btn-calc {
            width: 100%; padding: 10px; border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; font-size: 14px; font-weight: 700;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        [data-theme="dark"] .btn-calc { box-shadow: none; }

        .btn-secondary { background: var(--border); color: var(--text-sub); box-shadow: none; }
        .btn-danger { background: var(--danger); color: white; box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3); }
        .btn-mini { width: auto; padding: 6px 12px; font-size: 12px; margin-top: 0; border-radius: 8px;}
        .btn-prevent { background: #e0e7ff; color: #4338ca; border: 1px solid #c7d2fe; box-shadow:none;}
        [data-theme="dark"] .btn-prevent { background: rgba(55, 48, 163, 0.4); color: #818cf8; border-color: #4338ca; }

        .list-item {
            padding: 10px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .list-item:last-child { margin-bottom: 0; }
        
        /* Inline Editor Styles */
        .inline-editor {
            background: var(--bg-card);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .inline-editor .input-group { margin-bottom: 12px; }
        .inline-editor .input-label { font-size: 11px; margin-bottom: 4px; }
        .inline-editor input, .inline-editor textarea { 
            padding: 10px; border-radius: 8px; font-size: 14px; 
            border-width: 1px;
        }

        .btn-action {
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; color: var(--text-sub); margin-left: 3px;
            background: var(--input-bg); transition: all 0.2s;
            font-size: 12px; font-weight: normal; border: 1px solid transparent; flex-shrink: 0;
        }
        .btn-action:hover { background: var(--border); }
        .btn-edit:hover { background: var(--info); color: #fff; }
        .btn-del:hover { background: var(--danger-bg); color: var(--danger); border-color: var(--danger); }

        .btn-nuke {
            font-size: 11px;
            background: var(--danger-bg);
            color: var(--danger);
            border: 1px solid var(--danger);
            padding: 4px 8px;
            border-radius: 8px;
            cursor: pointer;
            margin-left: 8px;
        }

        .privacy-check-label {
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; color: var(--text-sub); margin-top: 12px;
            cursor: pointer; padding: 12px; background: var(--input-bg);
            border-radius: 12px; border: 2px solid var(--border);
            transition: all 0.2s; user-select: none;
        }
        .privacy-check-label:active { transform: scale(0.98); }
        .privacy-check-label.checked { border-color: var(--warning); background: var(--warning-bg); color: var(--warning); font-weight: bold; }
        .privacy-check-label input { display: none; }
        .privacy-check-label::before { content: 'ğŸ”“'; margin-right: 8px; font-size: 14px; }
        .privacy-check-label.checked::before { content: 'ğŸ”’'; }

        .todo-section-title { font-size: 11px; font-weight: 800; color: var(--text-sub); margin: 18px 0 8px 4px; text-transform: uppercase; letter-spacing: 0.5px; display: none; align-items: center;}
        .todo-section-title.show { display: flex; }

        .todo-item {
            padding: 8px 10px; border: 1px solid var(--border);
            border-radius: 8px; margin-bottom: 6px;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); transition: all 0.3s ease; position: relative;
        }
        .todo-do { border-left: 2px solid var(--success); }
        .todo-dont { border-left: 2px solid var(--danger); }
        .todo-other { border-left: 2px solid var(--info); }

        .todo-expired-item { opacity: 0.6; background: var(--border); filter: grayscale(1); }

        .todo-check { width: 24px; height: 24px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--success); font-size: 14px; opacity: 0.7; transition: opacity 0.2s; flex-shrink: 0;}
        .todo-check:hover { opacity: 1; }
        .click-anim { animation: press 0.3s ease-out; }
        @keyframes press { 0% { transform: scale(1); } 50% { transform: scale(0.8); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }

        /* æ‚¬æµ®èœå• */
        .action-menu {
            position: absolute;
            right: 46px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 4px 8px;
            display: none;
            gap: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 20;
            animation: fadeIn 0.2s ease;
        }
        .action-menu.show { display: flex; align-items: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(10px, -50%); } to { opacity: 1; transform: translate(0, -50%); } }

        .action-menu-dropdown {
            flex-direction: column !important;
            border-radius: 12px !important;
            padding: 8px !important;
            min-width: 140px;
            gap: 4px !important;
            right: 0 !important;
            top: 40px !important;
            transform: none !important;
            align-items: stretch !important;
        }

        .review-history-item {
            border-bottom: 1px dashed var(--border);
            padding: 12px 0;
        }
        .review-history-item:last-child { border-bottom: none; }
        .review-history-date { font-size: 12px; font-weight: bold; color: var(--primary); margin-bottom: 4px; }
        .review-history-content { font-size: 13px; color: var(--text-main); line-height: 1.4; }
        .review-history-label { font-size: 11px; color: var(--text-sub); margin-top: 4px; }

        .tab-bar {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 460px; background: var(--header-bg); backdrop-filter: blur(10px);
            border-radius: 10px; display: flex; padding: 6px 10px;
            box-shadow: 0 4px 12px -4px rgba(0,0,0,0.1); z-index: 1000;
            border: 1px solid var(--border); justify-content: space-between;
            padding-bottom: calc(6px + var(--safe-area-bottom));
        }
        .tab { text-align: center; color: var(--text-sub); cursor: pointer; font-size: 9px; flex: 1; padding: 2px 0; transition: all 0.2s; }
        .tab.active { color: var(--primary); }
        .tab-icon { font-size: 16px; display: block; margin-bottom: 1px; }

        .page { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .page.active { display: block; opacity: 1; transform: translateY(0); }

        .heatmap-container { display: flex; gap: 6px; justify-content: space-between; margin-bottom: 20px; }
        .heatmap-day { flex: 1; text-align: center; }
        .heatmap-box { height: 36px; border-radius: 8px; background: var(--border); margin-bottom: 6px; }
        .hm-success { background: var(--success); } .hm-fix { background: var(--warning); } .hm-repair { background: var(--danger); }

        .chips-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
        .chip { font-size: 12px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; color: var(--text-sub); transition: all 0.2s; }
        .chip:hover { background: var(--input-bg); border-color: var(--primary); color: var(--primary); }
        .chip-removable { padding-right: 8px; display:inline-flex; align-items:center; }
        .chip-removable::after { content:'Ã—'; font-weight:bold; margin-left:6px; font-size:14px; opacity:0.5; }

        .record-img {
            width: 40px; height: 40px;
            border-radius: 6px; border: 1px solid var(--border);
            margin-left: 10px; object-fit: cover; cursor: zoom-in; background: #eee;
        }

        .close-pending { position: absolute; top: 12px; right: 12px; color: var(--text-sub); opacity: 0.5; cursor: pointer; font-weight: bold; }
        .close-pending:hover { opacity: 1; }
        
        /* å¾…åŠé€‰æ‹©å¼¹çª—æ ·å¼ */
        #todoSelectModal > div {
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .todo-date-badge {
            font-size: 10px; padding: 2px 6px; border-radius: 6px;
            background: var(--border); color: var(--text-main); margin-left: 6px;
            font-weight: 600;
        }

        .backup-file-item {
            padding: 12px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 13px; cursor: pointer;
        }
        .backup-file-item:hover { background: var(--input-bg); }
        
        /* è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡† */
        .custom-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px);
            z-index: 10000; align-items: center; justify-content: center;
        }
        .custom-modal.show { display: flex; }
        .modal-content {
            background: var(--bg-card); border-radius: 16px;
            width: 90%; max-width: 420px; padding: 24px;
            box-shadow: 0 20px 60px -10px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .modal-title {
            font-size: 18px; font-weight: 700; margin-bottom: 16px;
            color: var(--text-main);
        }
        .modal-message {
            font-size: 14px; color: var(--text-sub); margin-bottom: 20px;
            line-height: 1.6;
        }
        .modal-buttons {
            display: flex; gap: 12px; margin-top: 20px;
        }
        .modal-btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            transition: all 0.2s;
        }
        .modal-btn-primary {
            background: var(--primary); color: white;
        }
        .modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .modal-btn-secondary {
            background: var(--border); color: var(--text-main);
        }
        .modal-btn-secondary:hover { background: var(--input-bg); }
        .modal-input {
            width: 100%; padding: 12px; border-radius: 12px;
            border: 1px solid var(--border); background: var(--input-bg);
            font-size: 14px; color: var(--text-main);
            margin-bottom: 12px; box-sizing: border-box;
        }
        .modal-input:focus {
            outline: none; border-color: var(--primary);
        }
        .modal-input-label {
            display: block; font-size: 13px; color: var(--text-sub);
            margin-bottom: 8px; font-weight: 600;
        }
        
        /* ç•Œé¢æ˜¾ç¤ºé…ç½®å¤é€‰æ¡†æ ·å¼ */
        .interface-option {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px; background: var(--input-bg);
            border-radius: 12px; cursor: pointer;
            border: 2px solid var(--border);
            transition: all 0.2s ease;
        }
        .interface-option:hover {
            background: var(--border);
            transform: translateX(2px);
        }
        .interface-option.checked {
            background: var(--success-bg);
            border-color: var(--success);
        }
        .interface-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
            pointer-events: none;
        }
        .interface-option-label {
            flex: 1; font-size: 14px; font-weight: 600;
            color: var(--text-main);
        }
        .interface-option.checked .interface-option-label {
            color: var(--success);
        }
        .interface-option-icon {
            font-size: 18px;
            opacity: 0.3;
            transition: all 0.2s;
        }
        .interface-option.checked .interface-option-icon {
            opacity: 1;
        }

        /* Time Bank Exchange Card */
        .exchange-card {
            display: none;
            background: var(--bg-card);
            border: 2px solid var(--time);
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body onclick="if(event.target.id === 'todoSelectModal') closeTodoSelectModal(); else closeAllMenus(event);">

    <div class="header">
        <div class="header-left">
            <div class="header-title">
                <h1>Habit</h1>
                <div id="syncBadge" class="sync-badge status-idle" onclick="syncGitHub('pull', false)">
                    <span class="sync-icon"></span><span id="syncText">æœ¬åœ°æ¨¡å¼</span>
                </div>
            </div>
        </div>
        <div class="header-right">
            <button id="themeToggle" class="theme-btn" onclick="toggleTheme()">â˜€ï¸</button>
            <div class="fund-badge badge-time" onclick="toggleExchangeCard()">â³ <span id="timeBankDisplay">0</span></div>
            <div class="fund-badge badge-wallet" onclick="switchPage('shop')">ğŸ’° <span id="walletDisplay">0</span></div>
            <div class="fund-badge badge-debt" onclick="switchPage('stats')">ğŸ’¸ <span id="debtDisplay">0</span></div>
        </div>
    </div>

    <div id="stickyNotifBar" class="sticky-notif-bar">
        <!-- å­¦ä¹ å¿«é€ŸæŒ‰é’® -->
        <div id="notifQuickStudy" class="notif-item notif-quick-study" style="display:none;">
            <div style="display:flex; align-items:center; gap:10px; flex:1;">
                <span style="font-weight:600; color:var(--primary); font-size:14px;">ğŸ“š å­¦ä¹ </span>
                <span id="notifStudyTime" style="font-size:12px; color:var(--text-sub); opacity:0.8; font-family:monospace;">0.0h</span>
            </div>
            <div class="notif-btn" style="background:var(--primary); color:#fff; font-weight:600; padding:6px 16px;" onclick="quickStartStudy()">å¼€å§‹</div>
        </div>
        <!-- è®¡æ—¶çŠ¶æ€ -->
        <div id="notifTimer" class="notif-item notif-timer" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span id="notifTimerName">ä»»åŠ¡</span>
                <span id="notifTimerClock" style="font-family: monospace; font-size:14px;">00:00:00</span>
            </div>
            <div style="display:flex; gap:8px;">
                <div class="notif-btn" id="notifTimerPauseBtn" onclick="toggleTimerPause()">â¸ï¸</div>
                <div class="notif-btn" onclick="stopTimer()">â¹ï¸</div>
                <div class="notif-btn" onclick="switchPage('timer')">æŸ¥çœ‹</div>
            </div>
        </div>
        <!-- ç½®é¡¶ä»»åŠ¡ -->
        <div id="notifPinned" class="notif-item notif-pinned" style="display:none;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span>ç½®é¡¶è®¡åˆ’: <span id="notifPinnedName">è®¡åˆ’å</span></span>
                <span id="notifPinnedTime" style="font-size:11px; opacity:0.8;"></span>
            </div>
            <div style="display:flex; gap:12px;">
                <div class="notif-btn" onclick="startPinnedTask()">å¼€å§‹</div>
                <div class="notif-btn" onclick="unpinTask()">âœ•</div>
            </div>
        </div>
    </div>

    <!-- 1. é¦–é¡µ -->
    <div id="page-checkin" class="container page active">

        <div class="toggle-container">
            <div id="btn-view-checkin" class="toggle-btn active" onclick="toggleHomeView('checkin')">æ™¨é—´æ‰“å¡</div>
            <div id="btn-view-todo" class="toggle-btn" onclick="toggleHomeView('todo')">ä»Šæ—¥å¾…åŠ</div>
        </div>

        <!-- A. æ‰“å¡è§†å›¾ -->
        <div id="view-checkin">
            <!-- è¡¥æ•‘æç¤ºå¡ç‰‡ -->
            <div id="pendingCard" class="card" style="background:var(--warning-bg); border-color:var(--warning); display:none; position:relative;">
                <div class="close-pending" onclick="closePendingCard()">âœ•</div>
                <div style="font-size:13px; font-weight:800; color:var(--warning); margin-bottom:8px;">å¾…æ‰§è¡Œè¡¥æ•‘æªæ–½</div>
                <div id="pendingText" style="font-weight:600; color:var(--text-main); font-size:15px; line-height:1.4;"></div>
            </div>

            <!-- æ—¶é—´å…‘æ¢å¡ç‰‡ -->
            <div id="exchangeCard" class="exchange-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div style="font-weight:800; color:var(--time);">æ—¶é—´é“¶è¡Œå…‘æ¢</div>
                    <div class="btn-action" onclick="toggleExchangeCard()">âœ•</div>
                </div>
                <div style="font-size:13px; color:var(--text-sub); margin-bottom:12px;">1å°æ—¶ = <span id="rateDisplay">5</span> å…ƒ</div>
                <div style="display:flex; gap:8px;">
                    <input type="number" id="exchangeHours" placeholder="å°æ—¶æ•°" style="flex:1;">
                    <button class="btn-mini" style="background:var(--time); color:#fff; width:auto;" onclick="executeExchange()">å…‘æ¢</button>
                </div>
            </div>

            <div class="card" id="inputCard">
                <div class="card-title">æ‰“å¡ <span id="dayTypeBadge" style="display:none;background:var(--info);color:#fff;padding:2px 8px;border-radius:12px;font-size:10px;">å‘¨æœ«</span></div>
                <div class="input-group">
                    <label class="input-label">æ—¥æœŸ</label>
                    <input type="date" id="dateInput" onchange="checkDateChange()">
                    <div class="chips-container" style="margin-top:8px;">
                        <div class="chip" onclick="quickSetDate('today')">ä»Šæ—¥</div>
                        <div class="chip" onclick="quickSetDate('yesterday')">æ˜¨æ—¥</div>
                    </div>
                </div>
                <div class="row">
                    <div class="input-group"><label class="input-label">å…¥ç¡ <span id="targetSleep" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="sleepInput" value="00:00"></div>
                    <div class="input-group"><label class="input-label">èµ·åºŠ <span id="targetWake" style="opacity:0.6;font-weight:normal"></span></label><input type="time" id="wakeInput" value="08:30"></div>
                </div>
                <div class="input-group"><label class="input-label">ä¸“æ³¨ (h)</label><input type="number" step="0.1" id="studyInput" placeholder="æ—¶é•¿"></div>
                
                <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>

                <div id="manualInputs" style="display:none; margin-top:15px; border-top:1px dashed var(--border); padding-top:15px;">
                    <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="manualPenalty" placeholder="0"></div>
                    <div class="input-group"><label class="input-label">åŸå› </label><textarea id="manualReason" placeholder="åŸå› "></textarea></div>
                </div>

                <button class="btn-calc" onclick="calculateCheckin()">âš¡ è¯Šæ–­</button>
                <div class="row" style="margin-top: 12px;">
                    <button class="btn-calc btn-secondary" style="margin-top:0" onclick="applyRest()">â˜• ä¼‘æ¯</button>
                    <button class="btn-calc btn-prevent" style="margin-top:0" onclick="applyPrevent()">ğŸ›¡ï¸ å¹²é¢„</button>
                </div>
            </div>

            <div id="analysisCard" class="card" style="display:none; text-align:center;"></div>
            <div id="formContainer"></div>
        </div>

        <!-- B. å¾…åŠè§†å›¾ -->
        <div id="view-todo" style="display:none;">
            <div class="card" style="padding:6px; border-color:var(--primary);">
                <input type="hidden" id="editingId">
                
                <!-- æ—¶é—´è®¾ç½® -->
                <div style="margin-bottom:10px;">
                    <div style="display:flex;gap:8px; margin-bottom:8px;">
                        <input type="date" id="todoDate" style="flex:3; padding:8px; font-size:14px; text-align:left;">
                        <input type="time" id="todoTime" style="flex:2; padding:8px; font-size:14px; text-align:left;">
                    </div>
                    <div class="chips-container" style="margin-top:6px; gap:6px;" id="todoTimeChips"></div>
                </div>
                
                <!-- åç§°å’Œå¤‡æ³¨ -->
                <input type="text" id="todoTitle" placeholder="åç§°" style="margin-bottom:8px; padding:8px; font-size:15px; text-align:left;">
                <textarea id="todoNote" placeholder="å¤‡æ³¨" rows="1" style="margin-bottom:8px; padding:8px; font-size:14px; min-height:48px; resize:none; text-align:left;"></textarea>
                <div class="chips-container" style="margin-bottom:10px; gap:6px;" id="todoTaskChips"></div>

                <!-- ç±»å‹å’Œé‡è¦æ€§ -->
                <div class="chips-container" style="margin-bottom:10px; gap:6px;" id="todoTypeImportanceChips"></div>
                <input type="hidden" id="todoType" value="do">
                <input type="hidden" id="todoImportance" value="1">

                <!-- å¥–åŠ±/æƒ©ç½šå’Œæäº¤æŒ‰é’® -->
                <div style="display:flex; gap:8px; align-items:flex-start;">
                    <div style="flex:1; display:flex; flex-direction:column; gap:6px;">
                        <div style="display:flex; gap:8px;">
                            <input type="number" id="todoReward" placeholder="å¥–åŠ±" value="1" style="flex:1; padding:8px; font-size:14px; border-color:var(--success); text-align:left; width:0;">
                            <input type="number" id="todoPenalty" placeholder="æƒ©ç½š" value="1" style="flex:1; padding:8px; font-size:14px; border-color:var(--danger); text-align:left; width:0;">
                        </div>
                        <div class="chips-container" style="gap:6px;" id="todoFundChips"></div>
                    </div>
                    <button id="todoSubmitBtn" class="btn-mini" style="background:var(--primary); color:#fff; height:auto; min-height:48px; width:48px; font-size:22px; flex-shrink:0; padding:0;" onclick="saveTodo()">+</button>
                </div>
            </div>

            <div id="todoContainer">
                <div id="head-do" class="todo-section-title">Do</div>
                <div id="list-do"></div>
                <div id="head-dont" class="todo-section-title">Not</div>
                <div id="list-dont"></div>
                <div id="head-other" class="todo-section-title">å…¶å®ƒ</div>
                <div id="list-other"></div>
                <div id="head-expired" class="todo-section-title">
                    å·²ç»“æŸ
                    <button class="btn-nuke" onclick="nukeExpiredTodos()">æ¸…ç©º</button>
                </div>
                <div id="list-expired"></div>
                <div id="empty-todo-hint" style="text-align:center;color:var(--text-sub);padding:30px;display:none;">ä»Šæ—¥åŠæœªæ¥æš‚æ— å¾…åŠ</div>
            </div>
        </div>
    </div>

    <!-- 2. ç»Ÿè®¡ -->
    <div id="page-stats" class="container page">
        <div class="card">
            <div class="card-title">
                <span>æ•°æ®æ¦‚è§ˆ</span>
                <select id="statPeriod" onchange="renderStats()" style="width:auto; padding:4px 8px; font-size:12px; height:32px;">
                    <option value="7">æœ€è¿‘7å¤©</option>
                    <option value="30">æœ€è¿‘30å¤©</option>
                    <option value="today">ä»Šå¤©</option>
                    <option value="yesterday">æ˜¨å¤©</option>
                    <option value="all">å…¨éƒ¨å†å²</option>
                </select>
            </div>
            
            <div class="chips-container" style="margin-bottom: 15px;">
                <div class="chip" onclick="setStatPeriod('today')">ä»Šæ—¥</div>
                <div class="chip" onclick="setStatPeriod('yesterday')">æ˜¨æ—¥</div>
                <div class="chip" onclick="setStatPeriod('7')">è¿‘7æ—¥</div>
            </div>

            <div class="heatmap-container" id="heatmap"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;text-align:center;">
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statStudy" style="font-weight:bold;font-size:20px;">0h</div><div style="font-size:12px;color:var(--text-sub)">ä¸“æ³¨</div></div>
                <div style="background:var(--input-bg);padding:15px;border-radius:12px;"><div class="stat-num" id="statRate" style="font-weight:bold;font-size:20px;">0%</div><div style="font-size:12px;color:var(--text-sub)">å®Œç¾</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ä¸“æ³¨ç»Ÿè®¡</div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:15px;">
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--primary);" id="statTimerTotal">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">æ€»æ—¶é•¿</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--success);" id="statTimerToday">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">ä»Šæ—¥</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--warning);" id="statTimerCount">0</div>
                    <div style="font-size:11px; color:var(--text-sub);">æ¬¡æ•°</div>
                </div>
                <div style="background:var(--input-bg); padding:12px; border-radius:12px; text-align:center;">
                    <div style="font-size:18px; font-weight:bold; color:var(--time);" id="statTimerAvg">0h</div>
                    <div style="font-size:11px; color:var(--text-sub);">å¹³å‡</div>
                </div>
            </div>
            <div id="statTimerTopTasks" style="font-size:12px; color:var(--text-main);"></div>
        </div>

        <div id="paySection" class="card" style="background:var(--danger-bg); border-color:var(--danger); text-align:center; display:none;">
            <div style="color:var(--danger); font-weight:800; font-size:28px; margin:10px 0;" id="debtAmount">0</div>
            <div style="color:var(--danger); font-size:13px; margin-bottom:15px; opacity:0.8;">å¾…ç½šå…¬ç›Šé‡‘</div>
            <button class="btn-calc" style="background:var(--danger); width:auto; margin:0 auto;" onclick="document.getElementById('fileInput').click()">ğŸ“¸ ä¸Šä¼ å‡­è¯</button>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="handlePaymentWithCompress(this)">
        </div>

        <div class="card">
            <div class="card-title">å†å²æ¡£æ¡ˆ <button class="btn-mini btn-secondary" onclick="exportCSV()">ğŸ“¤ å¯¼å‡º</button></div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- 3. å•†åº— -->
    <div id="page-shop" class="container page">
        <div class="card" style="background: var(--bg-card); border: 1px solid var(--warning);">
            <div class="card-title" style="color:var(--warning)">
                <span>æ„¿æœ›å•†åº—</span>
                <div style="display:flex; gap:6px; align-items:center;">
                     <button class="btn-mini" style="background:transparent; border:1px solid var(--warning); color:var(--warning);" onclick="sortShopByPrice()">ğŸ’° æŒ‰ä»·æ ¼æ’åº</button>
                     <span id="shopPrivacyBtn" style="cursor:pointer; font-size:20px; padding:4px;" onclick="toggleShopPrivacy()">ğŸ”’</span>
                </div>
            </div>
            <div style="text-align:center; margin-bottom:15px; font-size:14px; color:var(--text-sub);">
                å¯ç”¨: <span id="shopWalletDisplay" style="font-weight:bold; font-size:18px; color:var(--warning);">0</span> å…ƒ
            </div>
            <div class="row" style="grid-template-columns: 2fr 1fr;">
                <input type="text" id="wishName" placeholder="åç§°">
                <input type="number" id="wishCost" placeholder="ä»·æ ¼">
            </div>
            <label id="wishHiddenLabel" class="privacy-check-label" onclick="togglePrivacyCheck()">
                <input type="checkbox" id="wishHidden"> ç§å¯†
            </label>
            <button id="btnShopAdd" class="btn-calc" style="background:var(--warning);" onclick="addWish()">+ ä¸Šæ¶</button>
            <button id="btnShopCancel" class="btn-calc btn-secondary" style="display:none; margin-top:8px;" onclick="cancelShopEdit()">âœ• å–æ¶ˆ</button>
        </div>

        <div class="card">
            <div id="shopList"></div>
        </div>
    </div>

    <!-- 4. è®¾ç½® -->
    <div id="page-settings" class="container page">
        <div class="card">
            <div class="card-title">ç›®æ ‡</div>
             <div class="row"><div class="input-group"><label class="input-label">å¹³æ—¥èµ·åºŠ</label><input type="time" id="setWake"></div><div class="input-group"><label class="input-label">å¹³æ—¥å…¥ç¡</label><input type="time" id="setSleep"></div></div>
            <div class="row"><div class="input-group"><label class="input-label">å‘¨æœ«èµ·åºŠ</label><input type="time" id="setWakeW"></div><div class="input-group"><label class="input-label">å‘¨æœ«å…¥ç¡</label><input type="time" id="setSleepW"></div></div>
            
            <div class="row">
                <div class="input-group">
                    <label class="input-label">ä¸“æ³¨ (h)</label>
                    <input type="number" id="setStudy">
                </div>
                <div class="input-group">
                    <label class="input-label">å½’æ¡£æ•°</label>
                    <input type="number" id="setExpiredLimit" min="1" max="50">
                </div>
            </div>
            <div class="row">
                <div class="input-group">
                    <label class="input-label">è®¡æ—¶æ•°</label>
                    <input type="number" id="setTimerLimit" min="1" max="50">
                </div>
                <div class="input-group">
                    <label class="input-label">æ¡£æ¡ˆæ•°</label>
                    <input type="number" id="setHistoryLimit" min="1" max="50">
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">é¦–é¡µ</label>
                <select id="setInitialPage" style="width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text-main);">
                    <option value="checkin">æ‰“å¡</option>
                    <option value="timer">è®¡æ—¶</option>
                </select>
            </div>

            <div class="input-group" style="margin-top:12px;border-top:1px dashed var(--border);padding-top:12px;">
                <label class="input-label">å‘¨æœ«</label>
                <div style="display:flex; gap:12px;">
                    <div id="btn_week_6" class="week-btn" onclick="toggleWeek(6)">å‘¨å…­</div>
                    <div id="btn_week_0" class="week-btn" onclick="toggleWeek(0)">å‘¨æ—¥</div>
                </div>
            </div>
             <button class="btn-calc" style="background:var(--text-main); margin-top:20px;" onclick="saveSettings()">ğŸ’¾ ä¿å­˜</button>
        </div>

        <div class="card">
            <div class="card-title">å¥–æƒ© (å…ƒ)</div>
            <div class="row" style="margin-bottom:12px;">
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--warning); margin-bottom:0;">
                    <label class="input-label" style="color:var(--warning); margin-bottom:4px;">è¾¾æ ‡å¥–åŠ±</label>
                    <input type="number" id="rewardAmount" value="5">
                </div>
                <div class="input-group" style="padding:12px; border-radius:12px; border:1px solid var(--time); margin-bottom:0;">
                    <label class="input-label" style="color:var(--time); margin-bottom:4px;">æ±‡ç‡ (å…ƒ/h)</label>
                    <input type="number" id="exchangeRate" value="5">
                </div>
            </div>

            <div style="font-size:12px; font-weight:700; color:var(--danger); margin:15px 0 8px 0; text-transform:uppercase;">æƒ©ç½šé˜¶æ¢¯</div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">èµ·åºŠ&lt;30m</span><input type="number" id="pWakeS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">èµ·åºŠâ‰¥30m</span><input type="number" id="pWakeL"></div>
            </div>
            <div class="row" style="margin-bottom:10px;">
                <div><span style="font-size:11px;color:var(--text-sub)">å…¥ç¡&lt;1h</span><input type="number" id="pSleepS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">å…¥ç¡â‰¥1h</span><input type="number" id="pSleepL"></div>
            </div>
            <div class="row">
                <div><span style="font-size:11px;color:var(--text-sub)">å­¦ä¹ &lt;1h</span><input type="number" id="pStudyS"></div>
                <div><span style="font-size:11px;color:var(--text-sub)">å­¦ä¹ â‰¥1h</span><input type="number" id="pStudyL"></div>
            </div>

             <div class="input-group" style="margin-top:10px;">
                <label class="input-label">é¢„é˜²æ‰£è´¹</label>
                <input type="number" id="preventCost" value="10">
            </div>
        </div>

        <div class="card">
            <div class="card-title">å¿«æ·é¡¹</div>
            <div class="input-group">
                <label class="input-label">å¿«æ·ä»»åŠ¡</label>
                <div class="chips-container" id="setQuickTasksList"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_quicktask" placeholder="ä»»åŠ¡åç§°">
                    <button class="btn-mini" onclick="addQuickTask()">+</button>
                </div>
            </div>
            <div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--border);">
                <div style="font-size:11px;color:var(--text-sub);margin-bottom:8px;">æŒ‰ä½¿ç”¨é¢‘æ¬¡è‡ªåŠ¨æ’åº</div>
                <button class="btn-mini btn-secondary" style="width:100%;" onclick="resetTaskUsage()">ğŸ”„ é‡ç½®é¢‘æ¬¡</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">è¡¥æ•‘ç­–ç•¥</div>
            <div class="input-group">
                <label class="input-label">æ—©èµ·è¡¥æ•‘</label>
                <div class="chips-container" id="list_wake"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_wake" placeholder="è¡¥æ•‘æªæ–½">
                    <button class="btn-mini" onclick="addStrat('wake')">+</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">æ™šç¡è¡¥æ•‘</label>
                <div class="chips-container" id="list_sleep"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_sleep" placeholder="è¡¥æ•‘æªæ–½">
                    <button class="btn-mini" onclick="addStrat('sleep')">+</button>
                </div>
            </div>
            <div class="input-group">
                <label class="input-label">ä¸“æ³¨è¡¥æ•‘</label>
                <div class="chips-container" id="list_study"></div>
                <div style="display:flex;gap:8px;margin-top:8px;">
                    <input id="input_study" placeholder="è¡¥æ•‘æªæ–½">
                    <button class="btn-mini" onclick="addStrat('study')">+</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">æ—¶é—´å¿«é€‰</div>
            <div class="input-group">
                <div class="chips-container" id="todoTimeChipsSettingsList"></div>
            </div>
            <div style="display:flex; gap:8px; margin-top:12px;">
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="addTodoTimeChip('offset')">â° åç§»æ—¶é—´</button>
                <button class="btn-calc btn-secondary" style="flex:1; margin-top:0;" onclick="addTodoTimeChip('fixed')">ğŸ• å›ºå®šæ—¶é—´</button>
            </div>
            <div style="margin-top:8px;">
                <button class="btn-mini btn-secondary" style="width:100%;" onclick="resetTodoTimeChips()">ğŸ”„ æ¢å¤é»˜è®¤</button>
            </div>
        </div>

        <div class="card">
            <div class="card-title">ç•Œé¢é…ç½®</div>
            <div style="display:flex; flex-direction:column; gap:12px;">
                <label class="interface-option" id="label-showTimer">
                    <input type="checkbox" id="showTimer" onchange="updateInterfaceOption('showTimer')">
                    <span class="interface-option-label">è®¡æ—¶é¡µé¢</span>
                    <span class="interface-option-icon">âœ“</span>
                </label>
                <label class="interface-option" id="label-showStats">
                    <input type="checkbox" id="showStats" onchange="updateInterfaceOption('showStats')">
                    <span class="interface-option-label">ç»Ÿè®¡é¡µé¢</span>
                    <span class="interface-option-icon">âœ“</span>
                </label>
                <label class="interface-option" id="label-showShop">
                    <input type="checkbox" id="showShop" onchange="updateInterfaceOption('showShop')">
                    <span class="interface-option-label">å•†åº—é¡µé¢</span>
                    <span class="interface-option-icon">âœ“</span>
                </label>
                <label class="interface-option" id="label-showQuickStudy">
                    <input type="checkbox" id="showQuickStudy" onchange="updateInterfaceOption('showQuickStudy')">
                    <span class="interface-option-label">å­¦ä¹ å¿«é€ŸæŒ‰é’®</span>
                    <span class="interface-option-icon">âœ“</span>
                </label>
            </div>
        </div>

        <div class="card">
            <div class="card-title">GitHubåŒæ­¥</div>
            <div class="input-group"><input type="password" id="ghToken" placeholder="Token"></div>
            <div class="input-group"><input type="text" id="ghRepo" placeholder="ç”¨æˆ·å/ä»“åº“å"></div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜åŒæ­¥</button>
                <button class="btn-calc btn-secondary" style="background:var(--info); color:#fff; border:none;" onclick="archiveToGitHub()">â˜ï¸ åˆ›å»ºå­˜æ¡£</button>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--info);">
            <div class="card-title" style="color:var(--info)">äº‘ç«¯å­˜æ¡£</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">ä» GitHub backups æ¢å¤</div>
            <button class="btn-calc btn-secondary" style="margin-top:0;" onclick="listCloudBackups()">ğŸ“‚ æŸ¥çœ‹åˆ—è¡¨</button>
            <div id="cloudBackupList" style="margin-top:12px; display:none; max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:12px;"></div>
        </div>

        <div class="card">
            <div class="card-title">æ•°æ®è°ƒèŠ‚</div>
            <div style="font-size:12px; color:var(--text-sub); margin-bottom:12px;">ä¿®æ”¹æ•°å€¼ï¼Œå°†è®°å½•è‡³å†å²</div>
            <div class="row">
                <div class="input-group"><label class="input-label">æ—¶é—´é“¶è¡Œ (h)</label><input type="number" step="0.1" id="adjTimeBank"></div>
                <div class="input-group"><label class="input-label">æ„¿æœ›é‡‘ (å…ƒ)</label><input type="number" id="adjWallet"></div>
            </div>
            <div class="input-group"><label class="input-label">å¾…ç½šå…¬ç›Šé‡‘ (å…ƒ)</label><input type="number" id="adjDebt"></div>
            <div class="input-group">
                <label class="input-label">ä¿®æ”¹åŸå› </label>
                <input type="text" id="adjReason" placeholder="åŸå› ">
            </div>
            <button class="btn-calc" style="background:var(--primary);" onclick="applyManualAdjustment()">âœ“ åº”ç”¨</button>
        </div>

        <div class="card">
            <div class="card-title">æ•°æ®å®‰å…¨</div>
            <div class="row">
                <button class="btn-calc btn-secondary" onclick="exportJSON()">ğŸ“¤ å¤‡ä»½</button>
                <button class="btn-calc btn-secondary" style="color:var(--success); border-color:var(--success);" onclick="document.getElementById('importFile').click()">ğŸ“¥ æ¢å¤</button>
                <input type="file" id="importFile" hidden accept=".json" onchange="importJSON(this)">
            </div>
        </div>
    </div>

    <!-- è®¡æ—¶é¡µé¢ (æ–°å¢åŠ ) -->
    <div id="page-timer" class="container page">
        <div class="card">
            <div class="card-title">è®¡æ—¶</div>
            <div class="input-group">
                <label class="input-label">ä»»åŠ¡</label>
                <input type="text" id="timerTaskName" placeholder="ä»»åŠ¡åç§°">
                <!-- å¿«é€‰èƒ¶å›Š -->
                <div id="quickTasksContainer" class="chips-container" style="margin-top: 8px;"></div>
            </div>
            
            <!-- å¾…åŠé€‰æ‹©å¼¹çª— -->
            <div id="todoSelectModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
                <div style="background:var(--bg-card); border-radius:20px; padding:24px; max-width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 10px 40px rgba(0,0,0,0.3); border:1px solid var(--border);">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:800; font-size:18px; color:var(--text-main);">é€‰æ‹©å¾…åŠ</div>
                        <div class="btn-action" onclick="closeTodoSelectModal()" style="width:32px; height:32px; font-size:18px;">âœ•</div>
                    </div>
                    <div id="todoSelectList" style="max-height:60vh; overflow-y:auto;"></div>
                </div>
            </div>

            <div class="row">
                <div class="input-group">
                    <label class="input-label">èµ·å§‹æ—¶é—´</label>
                    <input type="time" id="timerPlannedTime">
                </div>
                <div class="input-group">
                    <label class="input-label">ç»“æŸæ—¶é—´</label>
                    <input type="time" id="timerPlannedEndTime">
                </div>
            </div>
            <!-- è®¡æ—¶æ—¶é—´å¿«é€‰èƒ¶å›Š -->
            <div class="chips-container" style="margin-top:8px;" id="timerTimeChips"></div>
            
            <div class="input-group">
                <label class="input-label">å¤‡æ³¨</label>
                <textarea id="timerNote" placeholder="å¤‡æ³¨" rows="1" style="min-height: 46px;"></textarea>
            </div>

            <div id="timerControls">
                <div id="timerIdleBtns" style="display: flex; gap: 12px; align-items: stretch;">
                    <button class="btn-calc" style="flex: 2; margin-top: 0;" id="btnTimerStart" onclick="startTimer()">â–¶ï¸ å¼€å§‹</button>
                    <button class="btn-calc btn-secondary" style="flex: 1; margin-top: 0;" onclick="addPlannedTask()">ğŸ“… è®¡åˆ’</button>
                </div>
                <div id="timerActiveBtns" style="display: none; gap: 12px; align-items: stretch; flex-wrap: wrap;">
                    <div style="display: flex; gap: 12px; width: 100%;">
                        <button class="btn-calc btn-secondary" id="btnTimerPause" style="flex: 1; margin-top: 0;" onclick="toggleTimerPause()">â¸ï¸ æš‚åœ</button>
                        <button class="btn-calc btn-danger" style="flex: 1; margin-top: 0;" onclick="stopTimer()">â¹ï¸ ç»“æŸ</button>
                    </div>
                    <button class="btn-calc btn-secondary" style="width: 100%; margin-top: 8px;" onclick="addPlannedTaskWhileRunning()">+ æ·»åŠ è®¡åˆ’</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">
                <span>å¤ç›˜</span>
                <div style="display:flex; gap:8px;">
                    <button class="btn-mini" style="background:var(--info); color:#fff;" onclick="toggleHistoryReview()">ğŸ“œ å†å²</button>
                    <button id="btnSaveReview" class="btn-mini" style="background:var(--success); color:#fff;" onclick="saveDailyReview(true)">ğŸ’¾ ä¿å­˜</button>
                </div>
            </div>
            
            <div id="reviewInputArea">
                <div class="input-group">
                    <label class="input-label">åšå¾—å¥½çš„</label>
                    <textarea id="reviewGreat" placeholder="è®°å½•..." rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label class="input-label">éœ€æ”¹è¿›çš„</label>
                    <textarea id="reviewImprove" placeholder="æ”¹è¿›..." rows="2"></textarea>
                </div>
            </div>

            <!-- å†å²å¤ç›˜å®¹å™¨ -->
            <div id="reviewHistoryArea" style="display:none; margin-top:10px; border-top:1px solid var(--border); padding-top:10px; max-height:300px; overflow-y:auto;">
                <div id="reviewHistoryList"></div>
            </div>
        </div>

        <!-- è®¡åˆ’æ¸…å• -->
        <div class="card" id="card-planned-tasks">
            <div class="card-title">è®¡åˆ’</div>
            <div id="plannedTasksList"></div>
        </div>

        <div class="card">
            <div class="card-title">å†å²</div>
            <div id="timerHistoryList"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab active" onclick="switchPage('checkin')"><span class="tab-icon">âœ¨</span>ä¸»é¡µ</div>
        <div class="tab" onclick="switchPage('timer')"><span class="tab-icon">â±ï¸</span>è®¡æ—¶</div>
        <div class="tab" onclick="switchPage('stats')"><span class="tab-icon">ğŸ“Š</span>ç»Ÿè®¡</div>
        <div class="tab" onclick="switchPage('shop')"><span class="tab-icon">ğŸ</span>å•†åº—</div>
        <div class="tab" onclick="switchPage('settings')"><span class="tab-icon">âš™ï¸</span>è®¾ç½®</div>
    </div>

    <!-- è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡† -->
    <div id="customModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">æç¤º</div>
            <div class="modal-message" id="modalMessage"></div>
            <div id="modalInputContainer"></div>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>

<script>
    const DEFAULT_CONFIG = { 
        wake: "08:30", 
        sleep: "01:00", 
        study: 4.0, 
        wakeW: "10:00", 
        sleepW: "02:00", 
        reward: 5, 
        preventCost: 10, 
        exchangeRate: 5, 
        initialPage: "checkin",
        expiredLimit: 5,
        timerLimit: 5,
        historyLimit: 5,
        quickTasks: ['ğŸ“š é˜…è¯»', 'ğŸ’» ç¼–ç¨‹', 'âœï¸ å†™ä½œ', 'ğŸƒ è¿åŠ¨', 'ğŸ¸ ç»ƒä¹ ', 'ğŸ§¹ å®¶åŠ¡'],
        penalties: { wakeS: 2, wakeL: 5, sleepS: 2, sleepL: 5, studyS: 5, studyL: 10 }, 
        weekend: [0, 6],
        todoTimeChips: [], // é»˜è®¤ä¸ºç©ºæ•°ç»„ï¼Œä½¿ç”¨å†…ç½®é»˜è®¤å¿«é€‰
        interface: { showTimer: true, showStats: true, showShop: true, showQuickStudy: true } // é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰ç•Œé¢
    };
    
    function safeParse(key, defaultVal) {
        try {
            const val = localStorage.getItem(key);
            if (!val || val === 'undefined') return defaultVal;
            return JSON.parse(val);
        } catch (e) {
            console.error("Error parsing " + key, e);
            return defaultVal;
        }
    }
    
    // è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†å‡½æ•°
    function showModal(options) {
        const modal = document.getElementById('customModal');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const inputContainer = document.getElementById('modalInputContainer');
        const buttonsContainer = document.getElementById('modalButtons');
        
        title.textContent = options.title || 'æç¤º';
        message.textContent = options.message || '';
        inputContainer.innerHTML = '';
        buttonsContainer.innerHTML = '';
        
        // æ·»åŠ è¾“å…¥æ¡†ï¼ˆå¦‚æœæœ‰ï¼‰
        if (options.inputs && options.inputs.length > 0) {
            options.inputs.forEach(input => {
                const label = document.createElement('label');
                label.className = 'modal-input-label';
                label.textContent = input.label;
                
                const inputEl = document.createElement(input.type === 'textarea' ? 'textarea' : 'input');
                inputEl.className = 'modal-input';
                inputEl.id = input.id;
                inputEl.placeholder = input.placeholder || '';
                inputEl.value = input.value || '';
                if (input.type && input.type !== 'textarea') inputEl.type = input.type;
                if (input.type === 'textarea') inputEl.rows = 3;
                
                inputContainer.appendChild(label);
                inputContainer.appendChild(inputEl);
            });
        }
        
        // æ·»åŠ æŒ‰é’®
        if (options.buttons && options.buttons.length > 0) {
            options.buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `modal-btn ${btn.primary ? 'modal-btn-primary' : 'modal-btn-secondary'}`;
                button.textContent = btn.text;
                button.onclick = () => {
                    // æ”¶é›†è¾“å…¥å€¼
                    const values = {};
                    if (options.inputs) {
                        options.inputs.forEach(input => {
                            const el = document.getElementById(input.id);
                            values[input.id] = el ? el.value : '';
                        });
                    }
                    
                    hideModal();
                    if (btn.callback) btn.callback(values);
                };
                buttonsContainer.appendChild(button);
            });
        }
        
        modal.classList.add('show');
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.onclick = (e) => {
            if (e.target === modal) hideModal();
        };
    }
    
    function hideModal() {
        const modal = document.getElementById('customModal');
        modal.classList.remove('show');
    }

    let historyData = safeParse('habit_data_v15', []);
    let config = safeParse('habit_config_v7', DEFAULT_CONFIG);
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«å¿«æ·ä»»åŠ¡ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.quickTasks || config.quickTasks.length === 0) {
        config.quickTasks = DEFAULT_CONFIG.quickTasks;
    }
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«ç•Œé¢æ˜¾ç¤ºè®¾ç½®ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.interface) {
        config.interface = DEFAULT_CONFIG.interface;
    }
    
    // ç¡®ä¿é…ç½®ä¸­åŒ…å«å¾…åŠæ—¶é—´å¿«é€‰ï¼ˆå‘åå…¼å®¹ï¼‰
    if (!config.todoTimeChips) {
        config.todoTimeChips = DEFAULT_CONFIG.todoTimeChips;
    }
    
    let wishList = safeParse('habit_wishes_v1', []);
    let todoList = safeParse('habit_todos_v1', []);
    let userStrategies = safeParse('habit_strategies_v1', { study: ["âš¡ ç•ªèŒ„é’Ÿ"], sleep: ["ğŸ“µ è¿œç¦»å±å¹•"], wake: ["â° é—¹é’Ÿæ”¾è¿œ"] });
    let timeBank = parseFloat(localStorage.getItem('habit_time_bank_v1'));
    if (isNaN(timeBank) || timeBank < 0) timeBank = 0;
    let timerRecords = safeParse('habit_timer_records_v1', []);
    let plannedTasks = safeParse('habit_planned_tasks_v1', []);
    let ghConfig = safeParse('habit_gh_v1', { token: '', repo: '', path: 'habit_backup.json' });
    let currentTheme = localStorage.getItem('habit_theme') || 'auto';
    let todayIsWeekend = false;
    let isDeleting = false;
    let isShopPrivacyOn = true;
    let openMenuId = null;
    let editingPlannedId = null;
    let editingTimerRecordId = null;
    let editingHistoryItemId = null;
    let pinnedTaskId = localStorage.getItem('habit_pinned_task_id') || null;
    let globalWallet = 0, globalDebt = 0;
    let dailyReviews = safeParse('habit_daily_reviews_v1', {});
    let taskUsageCount = safeParse('habit_task_usage_v1', {}); // ä»»åŠ¡ä½¿ç”¨é¢‘æ¬¡ç»Ÿè®¡
    let expiredFullView = false;
    let timerFullView = false;
    let historyFullView = false;
    let isReviewHistoryOpen = false;

    function switchPage(id){
        if (typeof closeAllMenus === 'function') closeAllMenus();

        const exchangeCard = document.getElementById('exchangeCard');
        if (exchangeCard) exchangeCard.style.display = 'none';

        if (id !== 'shop') {
            isShopPrivacyOn = true;
            const shopBtn = document.getElementById('shopPrivacyBtn');
            if (shopBtn) shopBtn.innerText = 'ğŸ”’';
        }

        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        
        const targetPage = document.getElementById('page-'+id);
        if (targetPage) targetPage.classList.add('active');

        const maps={checkin:0, timer:1, stats:2, shop:3, settings:4};
        const tabs = document.querySelectorAll('.tab');
        if (tabs[maps[id]]) tabs[maps[id]].classList.add('active');

        if(id==='stats' && typeof renderStats === 'function') renderStats();
        if(id==='shop' && typeof renderShop === 'function') renderShop();
        if(id==='settings') { 
            if (typeof applySettingsToUI === 'function') applySettingsToUI();
            if (typeof renderQuickTaskSettings === 'function') renderQuickTaskSettings();
        }
        if(id==='timer') { 
            if (typeof renderPlannedTasks === 'function') renderPlannedTasks(); 
            if (typeof renderTimerHistory === 'function') renderTimerHistory(); 
            if (typeof loadDailyReview === 'function') loadDailyReview();
            if (typeof renderQuickTasks === 'function') renderQuickTasks();
            if (typeof renderTimerTimeChips === 'function') renderTimerTimeChips();
            if (!timerRunning) initTimerTime();
        }
        
        // è®°å½•æœ€åä¸€æ¬¡è®¿é—®çš„ä¹ æƒ¯é¡µé¢ (ç”¨äºä»è´¢å¯Œæ¨¡å¼åˆ‡å›)
        if (id !== 'wealth') {
            localStorage.setItem('habit_last_page', id);
        }
    }

    let tempTimeDiff = 0;
    let useTimeBank = false;
    let defaultFund = 0;
    let calcReason = "";
    let failedTypes = [];
    let editingWishIndex = -1; // è®°å½•æ­£åœ¨ç¼–è¾‘çš„å•†å“ç´¢å¼•

    // è®¡æ—¶å™¨å˜é‡
    let timerRunning = false;
    let timerPaused = false;
    let timerSeconds = 0;
    let timerInterval = null;
    let timerSyncInterval = null; // ç”¨äºå®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€
    let isTimerFromPlan = false; // è®°å½•å½“å‰è®¡æ—¶æ˜¯å¦æ¥è‡ªè®¡åˆ’æ¸…å•
    
    // ä¿å­˜å½“å‰è®¡æ—¶å™¨çŠ¶æ€åˆ°localStorage
    function saveTimerState() {
        if (!timerRunning) {
            localStorage.removeItem('habit_timer_state_v1');
            return;
        }
        
        // å°è¯•è·å–å·²å­˜åœ¨çš„startTimestampï¼Œå¦‚æœæ²¡æœ‰åˆ™è®¡ç®—æ–°çš„
        let startTimestamp;
        const existingState = localStorage.getItem('habit_timer_state_v1');
        if (existingState) {
            try {
                const parsed = JSON.parse(existingState);
                startTimestamp = parsed.startTimestamp || (Date.now() - (timerSeconds * 1000));
            } catch (e) {
                startTimestamp = Date.now() - (timerSeconds * 1000);
            }
        } else {
            startTimestamp = Date.now() - (timerSeconds * 1000);
        }
        
        const timerState = {
            running: timerRunning,
            paused: timerPaused,
            seconds: timerSeconds,
            taskName: document.getElementById('timerTaskName').value || '',
            note: document.getElementById('timerNote').value || '',
            todoId: document.getElementById('timerTaskName').getAttribute('data-todo-id') || null,
            fromPlan: isTimerFromPlan,
            lastUpdate: Date.now(),
            startTimestamp: startTimestamp // ä¿æŒåŸæœ‰çš„å¼€å§‹æ—¶é—´æˆ³
        };
        localStorage.setItem('habit_timer_state_v1', JSON.stringify(timerState));
    }
    
    // ä»localStorageæ¢å¤è®¡æ—¶å™¨çŠ¶æ€
    function restoreTimerState() {
        // å…ˆæ¸…ç†ç°æœ‰çš„è®¡æ—¶å™¨
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        if (timerSyncInterval) {
            clearInterval(timerSyncInterval);
            timerSyncInterval = null;
        }
        
        const saved = localStorage.getItem('habit_timer_state_v1');
        if (!saved) {
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œåœæ­¢è®¡æ—¶å™¨å¹¶é‡ç½®UI
            const wasRunning = timerRunning;
            
            timerRunning = false;
            timerPaused = false;
            timerSeconds = 0;
            
            // é‡ç½®UI
            const idleBtns = document.getElementById('timerIdleBtns');
            const activeBtns = document.getElementById('timerActiveBtns');
            if (idleBtns) idleBtns.style.display = 'flex';
            if (activeBtns) activeBtns.style.display = 'none';
            
            // é‡ç½®æ˜¾ç¤º
            updateTimerUI();
            updateStickyNotif();
            
            if (wasRunning) {
                console.log('â¹ï¸ è®¡æ—¶å™¨å·²åœ¨å…¶ä»–è®¾å¤‡ç»“æŸï¼Œæœ¬åœ°åŒæ­¥åœæ­¢');
            }
            return;
        }
        
        try {
            const state = JSON.parse(saved);
            const now = Date.now();
            
            // åªæ¢å¤24å°æ—¶å†…çš„è®¡æ—¶çŠ¶æ€ï¼Œé¿å…æ¢å¤è¿‡æ—§çš„çŠ¶æ€
            if (!state.running || now - state.lastUpdate > 24 * 60 * 60 * 1000) {
                localStorage.removeItem('habit_timer_state_v1');
                return;
            }
            
            // å¦‚æœè®¡æ—¶å™¨æ²¡æœ‰æš‚åœï¼Œæ ¹æ®å¼€å§‹æ—¶é—´æˆ³è®¡ç®—å®é™…å·²ç»è¿‡å»çš„ç§’æ•°
            if (!state.paused && state.startTimestamp) {
                const elapsedMs = now - state.startTimestamp;
                timerSeconds = Math.floor(elapsedMs / 1000);
            } else {
                // å¦‚æœæš‚åœäº†ï¼Œå°±ä½¿ç”¨ä¿å­˜çš„ç§’æ•°
                timerSeconds = state.seconds || 0;
            }
            
            timerRunning = state.running;
            timerPaused = state.paused || false;
            isTimerFromPlan = state.fromPlan || false;
            
            // æ¢å¤UI
            const taskNameInput = document.getElementById('timerTaskName');
            const noteInput = document.getElementById('timerNote');
            
            if (taskNameInput) taskNameInput.value = state.taskName || '';
            if (noteInput) noteInput.value = state.note || '';
            if (state.todoId && taskNameInput) taskNameInput.setAttribute('data-todo-id', state.todoId);
            
            // é‡æ–°å¯åŠ¨è®¡æ—¶å™¨
            if (timerRunning) {
                const idleBtns = document.getElementById('timerIdleBtns');
                const activeBtns = document.getElementById('timerActiveBtns');
                if (idleBtns) idleBtns.style.display = 'none';
                if (activeBtns) activeBtns.style.display = 'flex';
                
                const pauseBtn = document.getElementById('btnTimerPause');
                if (pauseBtn) {
                    pauseBtn.innerText = timerPaused ? 'ç»§ç»­' : 'æš‚åœ';
                }
                
                updateTimerUI();
                updateStickyNotif();
                
                timerInterval = setInterval(() => {
                    if (!timerPaused) {
                        timerSeconds++;
                        updateTimerUI();
                        saveTimerState(); // æ¯ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€åˆ°æœ¬åœ°
                    }
                }, 1000);
                
                // æ¢å¤åä¹Ÿå¯åŠ¨å®šæœŸåŒæ­¥
                timerSyncInterval = setInterval(async () => {
                    if (timerRunning && ghConfig.token && ghConfig.repo) {
                        console.log('ğŸ”„ å®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€...');
                        // å…ˆ pull æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰å˜åŒ–ï¼ˆæ¯”å¦‚å…¶ä»–è®¾å¤‡å·²ç»“æŸè®¡æ—¶ï¼‰
                        await syncGitHub('pull', true);
                        // å¦‚æœè®¡æ—¶å™¨è¿˜åœ¨è¿è¡Œï¼ˆæ²¡æœ‰è¢« pull åœæ­¢ï¼‰ï¼Œå† push æœ¬åœ°çŠ¶æ€
                        if (timerRunning) {
                            triggerAutoSave();
                        }
                    } else if (timerRunning) {
                        // å¦‚æœæ²¡æœ‰é…ç½® GitHubï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                        saveTimerState();
                    }
                }, 30000); // 30ç§’
                
                console.log('âœ… å·²æ¢å¤è®¡æ—¶å™¨çŠ¶æ€:', state.taskName, 'å·²è®¡æ—¶', Math.floor(timerSeconds / 60), 'åˆ†é’Ÿ');
            }
        } catch (e) {
            console.error('æ¢å¤è®¡æ—¶å™¨çŠ¶æ€å¤±è´¥:', e);
            localStorage.removeItem('habit_timer_state_v1');
        }
    }

    /* ================== âœ… æ•°æ®åˆå¹¶å‡½æ•°ï¼šæ™ºèƒ½åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ® ================== */
    function mergeData(cloudData, localData) {
        if (!cloudData || !localData) return;
        
        // åˆå¹¶å†å²è®°å½•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€è®°å½•ï¼ˆæŒ‰idå»é‡ï¼‰
        if (cloudData.data && Array.isArray(cloudData.data)) {
            const localDataArray = localData.data || [];
            const localIds = new Set(localDataArray.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            const cloudIds = new Set(cloudData.data.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            
            // æ·»åŠ äº‘ç«¯ç‹¬æœ‰çš„è®°å½•
            cloudData.data.forEach(record => {
                if (record && record.id && !localIds.has(record.id)) {
                    localDataArray.push(record);
                }
            });
            
            // æŒ‰æ—¥æœŸå’Œidæ’åº
            localDataArray.sort((a, b) => {
                if (!a || !b) return 0;
                if (a.date !== b.date) return (b.date || '').localeCompare(a.date || '');
                return (b.id || 0) - (a.id || 0);
            });
            
            historyData = localDataArray;
        }
        
        // åˆå¹¶å¾…åŠäº‹é¡¹ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€å¾…åŠï¼ˆæŒ‰idå»é‡ï¼‰
        if (cloudData.todos && Array.isArray(cloudData.todos)) {
            const localTodosArray = localData.todos || [];
            const localTodoIds = new Set(localTodosArray.map(t => t && t.id ? t.id : null).filter(id => id !== null));
            
            cloudData.todos.forEach(todo => {
                if (todo && todo.id && !localTodoIds.has(todo.id)) {
                    localTodosArray.push(todo);
                }
            });
            
            todoList = localTodosArray;
        }
        
        // åˆå¹¶æ„¿æœ›æ¸…å•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€æ„¿æœ›ï¼ˆæŒ‰åç§°å»é‡ï¼‰
        if (cloudData.wishes && Array.isArray(cloudData.wishes)) {
            const localWishesArray = localData.wishes || [];
            const localWishNames = new Set(localWishesArray.map(w => w && w.name ? w.name : null).filter(name => name !== null));
            
            cloudData.wishes.forEach(wish => {
                if (wish && wish.name && !localWishNames.has(wish.name)) {
                    localWishesArray.push(wish);
                }
            });
            
            wishList = localWishesArray;
        }
        
        // åˆå¹¶ç­–ç•¥ï¼šåˆå¹¶æ•°ç»„
        if (cloudData.strategies && typeof cloudData.strategies === 'object') {
            const localStrategies = localData.strategies || {};
            Object.keys(cloudData.strategies).forEach(key => {
                if (!localStrategies[key]) {
                    localStrategies[key] = [];
                }
                if (Array.isArray(cloudData.strategies[key])) {
                    cloudData.strategies[key].forEach(strategy => {
                        if (strategy && !localStrategies[key].includes(strategy)) {
                            localStrategies[key].push(strategy);
                        }
                    });
                }
            });
            userStrategies = localStrategies;
        }
        
        // åˆå¹¶è®¡æ—¶å™¨è®°å½•ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€è®°å½•
        if (cloudData.timerRecords && Array.isArray(cloudData.timerRecords)) {
            const localTimerArray = localData.timerRecords || [];
            const localTimerIds = new Set(localTimerArray.map(r => r && r.id ? r.id : null).filter(id => id !== null));
            
            cloudData.timerRecords.forEach(record => {
                if (record && record.id && !localTimerIds.has(record.id)) {
                    localTimerArray.push(record);
                }
            });
            
            timerRecords = localTimerArray;
        }
        
        // åˆå¹¶è®¡åˆ’ä»»åŠ¡ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€ä»»åŠ¡
        if (cloudData.plannedTasks && Array.isArray(cloudData.plannedTasks)) {
            const localPlansArray = localData.plannedTasks || [];
            const localPlanIds = new Set(localPlansArray.map(p => p && p.id ? p.id : null).filter(id => id !== null));
            
            cloudData.plannedTasks.forEach(task => {
                if (task && task.id && !localPlanIds.has(task.id)) {
                    localPlansArray.push(task);
                }
            });
            
            plannedTasks = localPlansArray;
        }
        
        // åˆå¹¶æ¯æ—¥å¤ç›˜ï¼šä¿ç•™æ‰€æœ‰å”¯ä¸€å¤ç›˜ï¼ˆæŒ‰æ—¥æœŸå»é‡ï¼Œä¿ç•™æœ€æ–°çš„ï¼‰
        if (cloudData.dailyReviews && typeof cloudData.dailyReviews === 'object') {
            const localReviews = localData.dailyReviews || {};
            Object.keys(cloudData.dailyReviews).forEach(date => {
                const cloudReview = cloudData.dailyReviews[date];
                const localReview = localReviews[date];
                
                if (!localReview || (cloudReview && cloudReview.timestamp && cloudReview.timestamp > (localReview.timestamp || 0))) {
                    localReviews[date] = cloudReview;
                }
            });
            dailyReviews = localReviews;
        }
        
        // åˆå¹¶ä»»åŠ¡ä½¿ç”¨è®¡æ•°ï¼šå–è¾ƒå¤§å€¼
        if (cloudData.taskUsageCount && typeof cloudData.taskUsageCount === 'object') {
            const localUsageCount = localData.taskUsageCount || {};
            Object.keys(cloudData.taskUsageCount).forEach(task => {
                const cloudCount = cloudData.taskUsageCount[task] || 0;
                const localCount = localUsageCount[task] || 0;
                localUsageCount[task] = Math.max(cloudCount, localCount);
            });
            taskUsageCount = localUsageCount;
        }
        
        // æ—¶é—´é“¶è¡Œï¼šå–è¾ƒå¤§å€¼ï¼ˆé¿å…ä¸¢å¤±æ—¶é—´ï¼‰
        if (cloudData.timeBank !== undefined) {
            timeBank = Math.max(timeBank, cloudData.timeBank);
        }
        
        // é…ç½®ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°é…ç½®ï¼ˆç”¨æˆ·è®¾ç½®ä¸åº”è¯¥è¢«è¦†ç›–ï¼‰
        // config ä¿æŒä¸å˜
        
        // ç½®é¡¶ä»»åŠ¡ï¼šå¦‚æœäº‘ç«¯æœ‰ä¸”æœ¬åœ°æ²¡æœ‰ï¼Œä½¿ç”¨äº‘ç«¯çš„
        if (cloudData.pinnedTaskId && !pinnedTaskId) {
            pinnedTaskId = cloudData.pinnedTaskId;
            localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
        }
        
        // ä¿å­˜åˆå¹¶åçš„æ•°æ®åˆ°æœ¬åœ°
        persistAllLocal();
    }
    
    /* ================== âœ… åŒæ­¥ä¿®å¤ï¼šå‰¥ç¦»å›¾ç‰‡å­—æ®µï¼ˆä»…ç”¨äºäº‘ç«¯/æ‹‰å–å†™å…¥ï¼‰ ================== */
    function stripImagesFromHistory(arr) {
        if (!Array.isArray(arr)) return [];
        return arr.map(r => {
            if (!r || typeof r !== 'object') return r;
            const nr = { ...r };
            if (nr.details && typeof nr.details === 'object') {
                const nd = { ...nr.details };
                if (nd.image) delete nd.image; // ä¸åŒæ­¥/ä¸è½ç›˜å›¾ç‰‡
                nr.details = nd;
            }
            return nr;
        });
    }

    function persistAllLocal() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
    }

    function setSyncBadgeStatus(status, text) {
        const badge = document.getElementById('syncBadge');
        const badgeText = document.getElementById('syncText');
        badge.className = `sync-badge ${status}`;
        if (typeof text === 'string') badgeText.innerText = text;
    }

    function initTodoTime() {
        // é»˜è®¤è®¾ç½®ä¸º1å°æ—¶å
        const now = new Date();
        const after1h = new Date(now.getTime() + 60 * 60 * 1000);
        const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
        
        const todoTimeInput = document.getElementById('todoTime');
        if (todoTimeInput) todoTimeInput.value = time1h;
        
        // æ¸²æŸ“æ—¶é—´å¿«é€‰èƒ¶å›Š
        renderTodoTimeChips();
        // æ¸²æŸ“ä»»åŠ¡å¿«é€‰èƒ¶å›Š
        renderTodoTaskChips();
        // æ¸²æŸ“é‡‘é¢å¿«é€‰èƒ¶å›Š
        renderTodoFundChips();
        // æ¸²æŸ“ç±»å‹å’Œé‡è¦æ€§èƒ¶å›Š
        renderTodoTypeChips();
        renderTodoImportanceChips();
    }
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹æ—¶é—´å¿«é€‰èƒ¶å›Š
    function renderTodoTimeChips() {
        const container = document.getElementById('todoTimeChips');
        if (!container) return;
        
        const now = new Date();
        const offsetChips = []; // æ—¶é—´æ®µï¼ˆoffsetç±»å‹ï¼‰
        const fixedChips = [];  // å›ºå®šæ—¶é—´ç‚¹ï¼ˆfixedç±»å‹ï¼‰
        
        // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„æ—¶é—´å¿«é€‰ï¼ˆå¦‚æœæœ‰ï¼‰
        const customTimeChips = config.todoTimeChips || [];
        
        if (customTimeChips.length > 0) {
            // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¿«é€‰
            customTimeChips.forEach(chipConfig => {
                if (chipConfig.type === 'offset') {
                    // åç§»ç±»å‹ï¼šå¦‚"1å°æ—¶å"
                    const offsetMs = chipConfig.hours * 60 * 60 * 1000;
                    const targetTime = new Date(now.getTime() + offsetMs);
                    const timeStr = `${String(targetTime.getHours()).padStart(2, '0')}:${String(targetTime.getMinutes()).padStart(2, '0')}`;
                    offsetChips.push({ 
                        html: `<div class="chip" onclick="setTodoTime('${timeStr}')">${chipConfig.label}</div>`,
                        hours: chipConfig.hours 
                    });
                } else if (chipConfig.type === 'fixed') {
                    // å›ºå®šæ—¶é—´ç±»å‹ï¼šå¦‚"ä»Šæ™š23:59"
                    fixedChips.push({ 
                        html: `<div class="chip" onclick="setTodoTime('${chipConfig.time}')">${chipConfig.label}</div>`,
                        time: chipConfig.time 
                    });
                }
            });
        } else {
            // é»˜è®¤å¿«é€‰
            // 1å°æ—¶å
            const after1h = new Date(now.getTime() + 60 * 60 * 1000);
            const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
            offsetChips.push({ html: `<div class="chip" onclick="setTodoTime('${time1h}')">1å°æ—¶å</div>`, hours: 1 });
            
            // 2å°æ—¶å
            const after2h = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const time2h = `${String(after2h.getHours()).padStart(2, '0')}:${String(after2h.getMinutes()).padStart(2, '0')}`;
            offsetChips.push({ html: `<div class="chip" onclick="setTodoTime('${time2h}')">2å°æ—¶å</div>`, hours: 2 });
            
            // 3å°æ—¶å
            const after3h = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            const time3h = `${String(after3h.getHours()).padStart(2, '0')}:${String(after3h.getMinutes()).padStart(2, '0')}`;
            offsetChips.push({ html: `<div class="chip" onclick="setTodoTime('${time3h}')">3å°æ—¶å</div>`, hours: 3 });
            
            // ä»Šæ™š11ç‚¹åŠ
            fixedChips.push({ html: `<div class="chip" onclick="setTodoTime('23:30')">ä»Šæ™š</div>`, time: '23:30' });
        }
        
        // æ’åºï¼šæ—¶é—´æ®µæŒ‰hoursæ’åºï¼Œå›ºå®šæ—¶é—´ç‚¹æŒ‰timeæ’åº
        offsetChips.sort((a, b) => a.hours - b.hours);
        fixedChips.sort((a, b) => a.time.localeCompare(b.time));
        
        // åˆå¹¶ï¼šå…ˆæ—¶é—´æ®µï¼Œå†å›ºå®šæ—¶é—´ç‚¹
        const allChips = offsetChips.map(c => c.html).concat(fixedChips.map(c => c.html));
        container.innerHTML = allChips.join('');
    }
    
    // è®¾ç½®å¾…åŠæ—¶é—´
    function setTodoTime(time) {
        const todoTimeInput = document.getElementById('todoTime');
        if (todoTimeInput) todoTimeInput.value = time;
    }
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹ä»»åŠ¡å¿«é€‰èƒ¶å›Šï¼ˆä¸è®¡æ—¶å™¨åŒæ­¥ï¼‰
    function renderTodoTaskChips() {
        const container = document.getElementById('todoTaskChips');
        if (!container) return;
        
        const quickTasks = config.quickTasks || [];
        container.innerHTML = quickTasks.map(task => 
            `<div class="chip" onclick="setTodoTask('${task}')">${task}</div>`
        ).join('');
    }
    
    // è®¾ç½®å¾…åŠä»»åŠ¡
    function setTodoTask(task) {
        const todoTitleInput = document.getElementById('todoTitle');
        if (todoTitleInput) todoTitleInput.value = task;
    }
    
    let lastReward = parseFloat(localStorage.getItem('habit_last_reward')) || 1;
    let lastPenalty = parseFloat(localStorage.getItem('habit_last_penalty')) || 1;
    
    // æ¸²æŸ“å¾…åŠäº‹é¡¹é‡‘é¢å¿«é€‰èƒ¶å›Š
    function renderTodoFundChips() {
        const container = document.getElementById('todoFundChips');
        if (!container) return;
        
        const chips = [];
        
        // ç»Ÿè®¡å†å²è¾“å…¥ä¸­çš„å¸¸ç”¨é‡‘é¢
        const rewardCounts = {};
        const penaltyCounts = {};
        const comboCounts = {};
        
        todoList.forEach(t => {
            if (t.reward && t.reward > 0) {
                rewardCounts[t.reward] = (rewardCounts[t.reward] || 0) + 1;
            }
            if (t.penalty && t.penalty > 0) {
                penaltyCounts[t.penalty] = (penaltyCounts[t.penalty] || 0) + 1;
            }
            // ç»Ÿè®¡ç»„åˆ
            const combo = `${t.reward || 0}/${t.penalty || 0}`;
            comboCounts[combo] = (comboCounts[combo] || 0) + 1;
        });
        
        // æ‰¾å‡ºæœ€å¸¸ç”¨çš„å¥–åŠ±å’Œæƒ©ç½šé‡‘é¢ï¼ˆå„å–å‰3ä¸ªï¼‰
        const topRewards = Object.entries(rewardCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([val]) => parseFloat(val));
        
        const topPenalties = Object.entries(penaltyCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([val]) => parseFloat(val));
        
        // æ‰¾å‡ºæœ€å¸¸ç”¨çš„ç»„åˆï¼ˆå–å‰3ä¸ªï¼‰
        const topCombos = Object.entries(comboCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 3)
            .map(([combo]) => {
                const [r, p] = combo.split('/').map(parseFloat);
                return { reward: r, penalty: p };
            });
        
        // æ·»åŠ "ä¸Šæ¬¡"é€‰é¡¹ï¼ˆä¸æ˜¾ç¤º"ä¸Šæ¬¡"æ–‡å­—ï¼‰
        if (lastReward > 0 || lastPenalty > 0) {
            chips.push(`<div class="chip" onclick="setTodoFunds(${lastReward}, ${lastPenalty})">${lastReward}/${lastPenalty}</div>`);
        }
        
        // æ·»åŠ æœ€å¸¸ç”¨çš„ç»„åˆï¼ˆæœ€å¤š3ä¸ªï¼‰
        topCombos.forEach(combo => {
            if (combo.reward > 0 || combo.penalty > 0) {
                chips.push(`<div class="chip" onclick="setTodoFunds(${combo.reward}, ${combo.penalty})">${combo.reward}/${combo.penalty}</div>`);
            }
        });
        
        // å¦‚æœæ²¡æœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºé»˜è®¤å€¼
        if (chips.length === 0) {
            chips.push(`<div class="chip" onclick="setTodoFunds(1, 1)">1/1</div>`);
            chips.push(`<div class="chip" onclick="setTodoFunds(5, 5)">5/5</div>`);
            chips.push(`<div class="chip" onclick="setTodoFunds(10, 10)">10/10</div>`);
        }
        
        container.innerHTML = chips.join('');
    }
    
    // è®¾ç½®å¾…åŠé‡‘é¢
    function setTodoFunds(reward, penalty) {
        const rewardInput = document.getElementById('todoReward');
        const penaltyInput = document.getElementById('todoPenalty');
        if (rewardInput) rewardInput.value = reward;
        if (penaltyInput) penaltyInput.value = penalty;
    }

    // æ¸²æŸ“å¾…åŠç±»å‹å’Œé‡è¦æ€§èƒ¶å›Šï¼ˆåˆå¹¶åœ¨ä¸€è¡Œï¼‰
    function renderTodoTypeChips() {
        const container = document.getElementById('todoTypeImportanceChips');
        if (!container) return;
        
        const currentType = document.getElementById('todoType')?.value || 'do';
        const currentImportance = document.getElementById('todoImportance')?.value || '1';
        
        const types = [
            { value: 'do', label: 'å»åš' },
            { value: 'dont', label: 'ä¸åš' },
            { value: 'other', label: 'å…¶å®ƒ' }
        ];
        
        const importances = [
            { value: '1', label: 'æ™®é€š', color: 'var(--info)', bg: 'rgba(59, 130, 246, 0.2)' },
            { value: '2', label: 'ä¸­ç­‰', color: 'var(--warning)', bg: 'rgba(245, 158, 11, 0.2)' },
            { value: '3', label: 'é‡è¦', color: 'var(--danger)', bg: 'rgba(239, 68, 68, 0.2)' }
        ];
        
        const typeChips = types.map(t => {
            const active = currentType === t.value ? 'style="background:var(--primary-bg); border-color:var(--primary); color:var(--primary);"' : '';
            return `<div class="chip" ${active} onclick="setTodoType('${t.value}')">${t.label}</div>`;
        }).join('');
        
        const importanceChips = importances.map(i => {
            const isActive = currentImportance === i.value;
            const activeStyle = isActive ? `background:${i.bg}; border-color:${i.color}; color:${i.color}; font-weight:700;` : `border-color:${i.color}; color:${i.color}; opacity:0.7;`;
            return `<div class="chip" style="${activeStyle}" onclick="setTodoImportance('${i.value}')">${i.label}</div>`;
        }).join('');
        
        container.innerHTML = typeChips + importanceChips;
    }

    // æ¸²æŸ“å¾…åŠé‡è¦æ€§èƒ¶å›Šï¼ˆä¿ç•™å‡½æ•°ä»¥å…¼å®¹ï¼‰
    function renderTodoImportanceChips() {
        renderTodoTypeChips();
    }

    // è®¾ç½®å¾…åŠç±»å‹
    function setTodoType(type) {
        const typeInput = document.getElementById('todoType');
        if (typeInput) {
            typeInput.value = type;
            checkTodoTypeChange();
            renderTodoTypeChips(); // æ›´æ–°åˆå¹¶åçš„èƒ¶å›Šæ˜¾ç¤º
        }
    }

    // è®¾ç½®å¾…åŠé‡è¦æ€§
    function setTodoImportance(importance) {
        const importanceInput = document.getElementById('todoImportance');
        if (importanceInput) {
            importanceInput.value = importance;
            renderTodoTypeChips(); // æ›´æ–°åˆå¹¶åçš„èƒ¶å›Šæ˜¾ç¤º
        }
    }

    function initTimerTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;
        const timerPlannedTimeInput = document.getElementById('timerPlannedTime');
        if (timerPlannedTimeInput) timerPlannedTimeInput.value = timeStr;
        
        // æ¸²æŸ“è®¡æ—¶å™¨æ—¶é—´å¿«é€‰èƒ¶å›Š
        renderTimerTimeChips();
    }
    
    // æ¸²æŸ“è®¡æ—¶å™¨æ—¶é—´å¿«é€‰èƒ¶å›Š
    function renderTimerTimeChips() {
        const container = document.getElementById('timerTimeChips');
        if (!container) return;
        
        const now = new Date();
        const chips = [];
        
        // è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„æ—¶é—´å¿«é€‰ï¼ˆä¸å¾…åŠå…±äº«é…ç½®ï¼‰
        const customTimeChips = config.todoTimeChips || [];
        
        if (customTimeChips.length > 0) {
            // ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„å¿«é€‰
            customTimeChips.forEach(chipConfig => {
                if (chipConfig.type === 'offset') {
                    // åç§»ç±»å‹ï¼šå¦‚"1å°æ—¶å"
                    const offsetMs = chipConfig.hours * 60 * 60 * 1000;
                    const targetTime = new Date(now.getTime() + offsetMs);
                    const timeStr = `${String(targetTime.getHours()).padStart(2, '0')}:${String(targetTime.getMinutes()).padStart(2, '0')}`;
                    chips.push(`<div class="chip" onclick="setTimerPlannedTime('${timeStr}')">${chipConfig.label} ${timeStr}</div>`);
                } else if (chipConfig.type === 'fixed') {
                    // å›ºå®šæ—¶é—´ç±»å‹ï¼šå¦‚"ä»Šæ™š23:59"
                    chips.push(`<div class="chip" onclick="setTimerPlannedTime('${chipConfig.time}')">${chipConfig.label}</div>`);
                }
            });
        } else {
            // é»˜è®¤å¿«é€‰
            // 1å°æ—¶å
            const after1h = new Date(now.getTime() + 60 * 60 * 1000);
            const time1h = `${String(after1h.getHours()).padStart(2, '0')}:${String(after1h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time1h}')">1å°æ—¶å ${time1h}</div>`);
            
            // 2å°æ—¶å
            const after2h = new Date(now.getTime() + 2 * 60 * 60 * 1000);
            const time2h = `${String(after2h.getHours()).padStart(2, '0')}:${String(after2h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time2h}')">2å°æ—¶å ${time2h}</div>`);
            
            // 3å°æ—¶å
            const after3h = new Date(now.getTime() + 3 * 60 * 60 * 1000);
            const time3h = `${String(after3h.getHours()).padStart(2, '0')}:${String(after3h.getMinutes()).padStart(2, '0')}`;
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('${time3h}')">3å°æ—¶å ${time3h}</div>`);
            
            // ä»Šæ™š11ç‚¹åŠ
            chips.push(`<div class="chip" onclick="setTimerPlannedTime('23:30')">ä»Šæ™š 23:30</div>`);
        }
        
        container.innerHTML = chips.join('');
    }
    
    // è®¾ç½®è®¡æ—¶å™¨èµ·å§‹æ—¶é—´
    function setTimerPlannedTime(time) {
        const input = document.getElementById('timerPlannedTime');
        if (input) input.value = time;
    }
    
    // è®¾ç½®è®¡æ—¶å™¨ç»“æŸæ—¶é—´
    function setTimerPlannedEndTime(time) {
        const input = document.getElementById('timerPlannedEndTime');
        if (input) input.value = time;
    }
    
    // å¿«é€Ÿè®¾ç½®è®¡æ—¶å™¨æ—¶é—´æ®µï¼ˆèµ·å§‹+ç»“æŸï¼‰
    function setTimerTimeRange(startTime, duration) {
        const startInput = document.getElementById('timerPlannedTime');
        if (startInput) startInput.value = startTime;
        
        // è®¡ç®—ç»“æŸæ—¶é—´
        const [hours, minutes] = startTime.split(':').map(Number);
        const startDate = new Date();
        startDate.setHours(hours, minutes, 0, 0);
        const endDate = new Date(startDate.getTime() + duration * 60 * 60 * 1000);
        const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
        
        const endInput = document.getElementById('timerPlannedEndTime');
        if (endInput) endInput.value = endTime;
    }

    function init() {
        fixCorruptData();
        initTheme();
        const today = getLocalTodayStr();
        document.getElementById('dateInput').value = today;
        document.getElementById('todoDate').value = today;
        initTodoTime();
        initTimerTime();
        checkWeekend(); applySettingsToUI();
        renderStrategySettings();
        renderQuickTaskSettings(); // åˆå§‹åŒ–å¿«æ·ä»»åŠ¡è®¾ç½®æ˜¾ç¤º
        if(ghConfig.token && ghConfig.repo) { document.getElementById('ghToken').value = ghConfig.token; document.getElementById('ghRepo').value = ghConfig.repo; }
        checkDateChange();
        restoreTimerState(); // æ¢å¤æ­£åœ¨è¿›è¡Œçš„è®¡æ—¶å™¨çŠ¶æ€
        updateUI();
        updateStickyNotif(); // åŠ è½½æ—¶æ˜¾ç¤ºå¯èƒ½çš„ç½®é¡¶ä»»åŠ¡

        // é»˜è®¤è¿›å…¥èµ·å§‹é¡µ
        switchPage(config.initialPage || 'checkin');

        setInterval(() => {
            if(!isDeleting) {
                autoCheckTodos();
                updateStickyNotif(); // å‘¨æœŸæ€§æ›´æ–°ç½®é¡¶é€šçŸ¥ï¼ˆç¡®ä¿"ä¸‹ä¸€è®¡åˆ’"éšæ—¶é—´è‡ªåŠ¨åˆ‡æ¢ï¼‰
            }
        }, 2000);

        // åˆå§‹åŒæ­¥
        if(ghConfig.token && ghConfig.repo) syncGitHub('pull', true);
        
        // æ¯2åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ï¼Œæ£€æµ‹å…¶ä»–è®¾å¤‡çš„å˜åŒ–
        if(ghConfig.token && ghConfig.repo) {
            setInterval(() => {
                console.log('ğŸ”„ å®šæœŸæ£€æŸ¥äº‘ç«¯æ•°æ®æ›´æ–°...');
                syncGitHub('pull', true);
            }, 120000); // 2åˆ†é’Ÿ
        }
    }

    function toggleWeek(day) {
        if(!config.weekend) config.weekend = [0, 6];
        const idx = config.weekend.indexOf(day);
        if(idx > -1) config.weekend.splice(idx, 1);
        else config.weekend.push(day);

        applySettingsToUI();
        checkWeekend();

        config.weekend = config.weekend || [0, 6];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
    }

    function toggleExchangeCard() {
        const card = document.getElementById('exchangeCard');
        if(card.style.display === 'block') {
            card.style.display = 'none';
        } else {
            switchPage('checkin');
            toggleHomeView('checkin');
            card.style.display = 'block';
            document.getElementById('rateDisplay').innerText = config.exchangeRate || 5;
            document.getElementById('exchangeHours').value = '';
        }
    }

    function executeExchange() {
        const hours = parseFloat(document.getElementById('exchangeHours').value);
        if(!hours || hours <= 0) return alert("è¯·è¾“å…¥æœ‰æ•ˆå°æ—¶æ•°");
        if(hours > timeBank) return alert(`ä½™é¢ä¸è¶³ï¼Œå½“å‰ä»…æœ‰ ${timeBank.toFixed(1)} å°æ—¶`);

        const rate = config.exchangeRate || 5;
        const money = hours * rate;

        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${hours} å°æ—¶å…‘æ¢ ${money} å…ƒæ„¿æœ›é‡‘ï¼Ÿ`)) return;

        timeBank -= hours;
        saveRecord({
            fund: money,
            title: 'æ—¶é—´å…‘æ¢',
            theme: 'theme-success',
            details: { note: `æ¶ˆè€— ${hours}h, æ±‡ç‡ ${rate}`, time_bank_change: `-${hours}h` }
        }, false);

        toggleExchangeCard();
        alert("å…‘æ¢æˆåŠŸï¼");
    }

    function toggleTheme() {
        currentTheme = (currentTheme === 'light' ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', currentTheme);
        localStorage.setItem('habit_theme', currentTheme);
        document.getElementById('themeToggle').innerText = (currentTheme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™');
    }

    function initTheme() {
        const saved = localStorage.getItem('habit_theme') || 'light';
        currentTheme = saved;
        document.documentElement.setAttribute('data-theme', saved);
        document.getElementById('themeToggle').innerText = (saved === 'light' ? 'â˜€ï¸' : 'ğŸŒ™');
    }

    function toggleHomeView(view) {
        document.getElementById('view-checkin').style.display = (view === 'checkin' ? 'block' : 'none');
        document.getElementById('view-todo').style.display = (view === 'todo' ? 'block' : 'none');
        document.getElementById('btn-view-checkin').classList.toggle('active', view === 'checkin');
        document.getElementById('btn-view-todo').classList.toggle('active', view === 'todo');
        if (view === 'todo') {
            renderTodos();
            renderTodoTimeChips();
            renderTodoTaskChips();
            renderTodoFundChips();
        }
    }

    function getLocalTodayStr() {
        const d = new Date();
        return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    }

    function checkDateChange() {
        checkWeekend();
        const dateStr = document.getElementById('dateInput').value;
        document.getElementById('todoDate').value = dateStr;
        const todayStr = getLocalTodayStr();
        const toggleContainer = document.querySelector('.toggle-container');
        if (dateStr === todayStr) {
            const hasCheckin = historyData.some(r => r.date === dateStr && ['theme-success','theme-fix','theme-repair','theme-prevent','theme-skip'].includes(r.theme));
            if (hasCheckin) {
                document.getElementById('inputCard').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-sub);">ä»Šæ—¥å·²å®Œæˆæ‰“å¡</div>';
                // éšè—æ ‡é¢˜åˆ‡æ¢æŒ‰é’®ï¼Œç›´æ¥æ˜¾ç¤ºå¾…åŠè§†å›¾
                if (toggleContainer) toggleContainer.style.display = 'none';
                toggleHomeView('todo');
            } else {
                // å¦‚æœæ²¡æœ‰æ‰“å¡è®°å½•ï¼Œæ¢å¤æ˜¾ç¤ºæ ‡é¢˜
                if (toggleContainer) toggleContainer.style.display = '';
                toggleHomeView('checkin');
            }
        } else {
            // éä»Šæ—¥æ—¥æœŸï¼Œæ¢å¤æ˜¾ç¤ºæ ‡é¢˜
            if (toggleContainer) toggleContainer.style.display = '';
            toggleHomeView('checkin');
        }
        renderTodos();
        renderStrategies();
    }

    function calculateCheckin() {
        autoCalculate();
    }

    function applyRest() {
        const leaveCount = historyData.filter(r => r.date.startsWith(document.getElementById('dateInput').value.slice(0, 7)) && r.theme === 'theme-skip').length;
        renderForm('skip', leaveCount);
    }

    function applyPrevent() {
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">è¯Šæ–­ä¸­...</div>`;
        renderForm('prevent');
    }

    function renderStrategySettings() {
        ['wake','sleep','study'].forEach(type => {
            const container = document.getElementById('list_' + type);
            if (!container) return;
            container.innerHTML = (userStrategies[type]||[]).map((s, idx) => `
                <div class="chip chip-removable" onclick="removeStrat('${type}', ${idx})">${s}</div>
            `).join('');
        });
    }

    function addStrat(type) {
        const input = document.getElementById(`input_${type}`);
        const val = input.value.trim();
        if(!val) return;
        if(!userStrategies[type]) userStrategies[type] = [];
        userStrategies[type].push(val);
        input.value = '';
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }
    function removeStrat(type, idx) {
        if(!confirm(`åˆ é™¤æ­¤ç­–ç•¥?`)) return;
        userStrategies[type].splice(idx, 1);
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        renderStrategySettings(); triggerAutoSave();
    }

    function getTimestampStr() {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, '0');
        return now.getFullYear() + pad(now.getMonth() + 1) + pad(now.getDate()) + "_" + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
    }

    function fixCorruptData() {
        let originalLen = todoList.length;
        todoList = todoList.filter(t => t);
        todoList.forEach(t => { if(!t.id) t.id = 'fixed_' + Math.random(); if(!t.title) t.title = "ä¿®å¤çš„æ•°æ®"; });
        const seen = new Set();
        todoList = todoList.filter(t => { if(seen.has(t.id)) return false; seen.add(t.id); return true; });
        if(todoList.length !== originalLen) localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
    }

    function nukeExpiredTodos() {
        if(!confirm("âš ï¸ ç¡®è®¤æ¸…ç©ºåˆ—è¡¨ä¸­çš„æ‰€æœ‰ã€å·²ç»“æŸ/å·²è¿‡æœŸã€‘é¡¹ç›®ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) return;
        isDeleting = true;
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        const todayStr = getLocalTodayStr();
        todoList = todoList.filter(t => {
            if(t.archived) return false; // ç§»é™¤å·²å½’æ¡£
            if(t.date > todayStr) return true;
            if(t.date === todayStr && t.time >= currentHm) return true;
            let isExpired = (t.date < todayStr) ||
                            (t.date === todayStr && currentHm > t.time && (t.status === 'pending' || t.status.startsWith('expired_')));
            return !isExpired;
        });
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        renderTodos();
        triggerAutoSave();
        setTimeout(() => isDeleting = false, 500);
    }

    function checkTodoTypeChange() {
        const type = document.getElementById('todoType').value;
        if(type === 'other') {
            const d = new Date();
            d.setMonth(d.getMonth() + 1);
            document.getElementById('todoDate').value = d.toISOString().split('T')[0];
            document.getElementById('todoReward').value = 0;
            document.getElementById('todoPenalty').value = 0;
        } else {
            if(document.getElementById('todoReward').value == 0) document.getElementById('todoReward').value = config.reward || 5;
            if(document.getElementById('todoPenalty').value == 0) document.getElementById('todoPenalty').value = 1;
            document.getElementById('todoDate').value = getLocalTodayStr();
        }
    }

    function renderTodos() {
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);

        ['list-do','list-dont','list-other','list-expired'].forEach(id=>document.getElementById(id).innerHTML='');
        ['head-do','head-dont','head-other','head-expired'].forEach(id=>document.getElementById(id).classList.remove('show'));

        // 1. åˆ†ç¦» Active å’Œ Expired
        let activeItems = [];
        let expiredItems = [];

        todoList.forEach(t => {
            let isExpired = (t.date < todayStr) || t.archived; // å¢åŠ æ‰‹åŠ¨å½’æ¡£åˆ¤æ–­
            if (!isExpired && t.date === todayStr && currentHm >= t.time) {
                 if (currentHm > t.time) {
                     if (t.status === 'pending' || t.status.startsWith('expired_')) {
                         isExpired = true;
                     }
                 }
            }
            if(isExpired) expiredItems.push(t);
            else activeItems.push(t);
        });

        // 2. æ¸²æŸ“ Active (é‡è¦ç­‰çº§ä¼˜å…ˆï¼Œå…¶æ¬¡æŒ‰æ—¶é—´æ’åº)
        activeItems.sort((a, b) => {
            const impA = a.importance || 1;
            const impB = b.importance || 1;
            if (impA !== impB) return impB - impA; // æŒ‰é‡è¦ç­‰çº§é™åº
            return (a.date + a.time).localeCompare(b.date + b.time); // åŒçº§æŒ‰æ—¶é—´å‡åº
        });
        
        let activeCount = 0;
        activeItems.forEach(t => {
            const html = generateTodoHtml(t, false);
            activeCount++;
            if(t.type === 'do') { document.getElementById('list-do').insertAdjacentHTML('beforeend', html); document.getElementById('head-do').classList.add('show'); }
            else if(t.type === 'dont') { document.getElementById('list-dont').insertAdjacentHTML('beforeend', html); document.getElementById('head-dont').classList.add('show'); }
            else { document.getElementById('list-other').insertAdjacentHTML('beforeend', html); document.getElementById('head-other').classList.add('show'); }
        });

        // 3. æ¸²æŸ“ Expired (æŒ‰å½’æ¡£æ—¶é—´æ’åºï¼Œå€’åº)
        if(expiredItems.length > 0) {
            expiredItems.sort((a, b) => {
                // æŒ‰å½’æ¡£æ—¶é—´æ’åºï¼ˆå€’åºï¼Œæœ€æ–°å½’æ¡£çš„åœ¨å‰ï¼‰
                const archiveTimeA = a.archivedAt || 0;
                const archiveTimeB = b.archivedAt || 0;
                
                // å¦‚æœéƒ½æœ‰å½’æ¡£æ—¶é—´ï¼ŒæŒ‰å½’æ¡£æ—¶é—´å€’åº
                if (archiveTimeA > 0 && archiveTimeB > 0) {
                    return archiveTimeB - archiveTimeA;
                }
                // å¦‚æœåªæœ‰ä¸€ä¸ªæœ‰å½’æ¡£æ—¶é—´ï¼Œæœ‰å½’æ¡£æ—¶é—´çš„æ’åœ¨å‰é¢
                if (archiveTimeA > 0) return -1;
                if (archiveTimeB > 0) return 1;
                
                // éƒ½æ²¡æœ‰å½’æ¡£æ—¶é—´ï¼ˆè‡ªåŠ¨è¿‡æœŸçš„ï¼‰ï¼ŒæŒ‰äº‹ä»¶æ—¶é—´å€’åºä½œä¸ºfallback
                const dtA = a.date + a.time;
                const dtB = b.date + b.time;
                return dtB.localeCompare(dtA);
            });

            const limit = expiredFullView ? expiredItems.length : (config.expiredLimit || 5);
            const displayedExpired = expiredItems.slice(0, limit);

            const expiredHtml = displayedExpired.map(t => generateTodoHtml(t, true)).join('');
            document.getElementById('list-expired').innerHTML = expiredHtml;
            document.getElementById('head-expired').classList.add('show');
            
            // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
            if (!expiredFullView && expiredItems.length > limit) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleExpiredFullView()">
                        æ›´å¤š
                    </div>`
                );
            } else if (expiredFullView && expiredItems.length > (config.expiredLimit || 5)) {
                document.getElementById('list-expired').insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleExpiredFullView()">
                        æ”¶èµ·
                    </div>`
                );
            }
        }

        document.getElementById('empty-todo-hint').style.display = activeCount === 0 ? 'block' : 'none';

        if(openMenuId) {
             const menu = document.getElementById(`menu-${openMenuId}`);
             if(menu && menu.classList.contains('show')) {
                 clearTimeout(menuTimer);
                 menuTimer = setTimeout(() => {
                    menu.classList.remove('show');
                    openMenuId = null;
                 }, 8000);
             }
        }
    }

    function generateTodoHtml(t, isExpired) {
        let statusIcon = '', actionBtn = '';
        const reward = t.reward || 0;
        const penalty = t.penalty || 0;

        const importance = t.importance || 1;
        // ç§»é™¤é‡è¦æ€§åœ†ç‚¹ï¼Œä½¿ç•Œé¢æ›´ç®€æ´
        let importanceDot = '';

        const noteContent = t.hideNote ? '******' : t.note;
        const note = t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:2px;background:var(--input-bg);padding:4px;border-radius:6px;word-break:break-all;">${noteContent}</div>` : '';
        const safeId = String(t.id);
        const todayStr = getLocalTodayStr();
        const isFuture = t.date > todayStr;

        if (t.status === 'success') {
            // å·²å®ŒæˆçŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡ï¼Œåªæ˜¾ç¤ºå¥–åŠ±é‡‘é¢
            statusIcon = '';
            actionBtn = `<span style="font-size:11px;color:var(--success);opacity:0.8;">+${reward}</span>`;
        } else if (t.status === 'fail') {
            // å·²å¤±è´¥çŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡ï¼Œåªæ˜¾ç¤ºæƒ©ç½šé‡‘é¢
            statusIcon = '';
            actionBtn = `<span style="font-size:11px;color:var(--danger);opacity:0.8;">-${penalty}</span>`;
        } else {
            // pendingçŠ¶æ€
            statusIcon = '';
            if (isExpired) {
                // å·²è¿‡æœŸçŠ¶æ€ï¼šç§»é™¤çŠ¶æ€å›¾æ ‡
                if(t.status === 'expired_fail') actionBtn = `<span style="font-size:11px;color:var(--danger);opacity:0.7;">å·²è¶…æ—¶</span>`;
                else if(t.status === 'expired_success') actionBtn = `<span style="font-size:11px;color:var(--success);opacity:0.7;">å·²è¾¾æˆ</span>`;
                else actionBtn = `<span style="font-size:11px;color:var(--text-sub);opacity:0.7;">å·²è¿‡æœŸ</span>`;
            } else {
                if (t.type === 'do' || t.type==='other') {
                    actionBtn = `<div id="btn-${safeId}" class="todo-check" onclick="finishTodoWithAnim('${safeId}', 'success')">âœ”</div>`;
                } else {
                    actionBtn = `<button class="btn-mini" style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger);font-size:11px;padding:4px 8px;" onclick="finishTodoWithAnim('${safeId}', 'fail')">ç ´æˆ’</button>`;
                }
            }
        }
        const wrapperClass = isExpired ? 'todo-item todo-expired-item' : `todo-item todo-${t.type}`;

        let menuHtml = '';
        const showClass = (safeId === openMenuId) ? 'show' : '';

        let customActions = '';
        if (!isExpired && (t.status === 'success' || t.status === 'fail')) {
            customActions += `<div class="btn-action" style="background:var(--input-bg);color:var(--text-sub);font-size:12px;" onclick="archiveTodo('${safeId}')">å½’æ¡£</div>`;
        }
        if (t.note) {
            customActions += `<div class="btn-action" style="font-size:12px;" onclick="toggleTodoNote('${safeId}')">å¤‡æ³¨</div>`;
        }

        if(t.status === 'pending' || t.status.startsWith('expired_')) {
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">â‹®</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-edit" onclick="editTodo('${safeId}')">âœï¸</div>
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">ğŸ—‘ï¸</div>
                </div>
            `;
        } else {
            menuHtml = `
                <div class="btn-action" onclick="toggleMenu(event, '${safeId}')">â‹®</div>
                <div id="menu-${safeId}" class="action-menu ${showClass}">
                    ${customActions}
                    <div class="btn-action btn-del" onclick="deleteTodo('${safeId}')">âœ•</div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼šä»Šå¤©ä¸æ˜¾ç¤ºï¼Œæœ€è¿‘æ—¥æœŸç”¨"æ˜¨"ã€"æ˜"ä»£æ›¿
        let dateBadgeFormatted = '';
        if (isFuture || isExpired) {
            const todoDate = new Date(t.date + 'T00:00:00');
            const today = new Date(todayStr + 'T00:00:00');
            const diffDays = Math.floor((todoDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays === -1) {
                dateBadgeFormatted = '<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">æ˜¨</span>';
            } else if (diffDays === 0) {
                dateBadgeFormatted = '';
            } else if (diffDays === 1) {
                dateBadgeFormatted = '<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">æ˜</span>';
            } else {
                dateBadgeFormatted = `<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">${t.date.slice(5)}</span>`;
            }
        }
        
        // å¥–åŠ±/æƒ©ç½šä¿¡æ¯ï¼šéƒ½è¦æ˜¾ç¤º
        const rewardText = reward > 0 ? `+${reward}` : reward === 0 ? '0' : '';
        const penaltyText = penalty > 0 ? `-${penalty}` : penalty === 0 ? '0' : '';
        const fundInfo = `<span style="font-size:10px;color:var(--text-sub);opacity:0.7;">${rewardText}/${penaltyText}</span>`;
        
        return `
        <div class="${wrapperClass}" id="todo-row-${safeId}">
            <div style="flex:1; display:flex; align-items:flex-start; gap:6px; min-width:0;">
                <div style="flex:1; min-width:0;">
                    <div style="font-size:10px; color:var(--text-sub); opacity:0.7; margin-bottom:3px; display:flex; align-items:center; gap:6px;">
                        <span>${t.time}</span>
                        ${dateBadgeFormatted}
                        ${fundInfo}
                    </div>
                    <div style="font-weight:600; color:var(--text-main); font-size:14px; line-height:1.3;">
                        ${t.title}
                    </div>
                    ${note}
                </div>
            </div>
            <div style="display:flex;align-items:center; gap:3px; flex-shrink:0;">
                ${actionBtn} ${menuHtml}
            </div>
        </div>`;
    }

    let menuTimer = null;
    function toggleMenu(e, id) {
        e.stopPropagation();
        const menu = document.getElementById(`menu-${id}`);
        const isShown = menu.classList.contains('show');

        closeAllMenus();

        if(!isShown) {
            menu.classList.add('show');
            openMenuId = id;

            clearTimeout(menuTimer);
            menuTimer = setTimeout(() => {
                menu.classList.remove('show');
                openMenuId = null;
            }, 8000);
        }
    }

    function closeAllMenus(e) {
        clearTimeout(menuTimer);
        document.querySelectorAll('.action-menu.show').forEach(el => el.classList.remove('show'));
        openMenuId = null;
    }

    function saveTodo() {
        const id = document.getElementById('editingId').value;
        const title = document.getElementById('todoTitle').value;
        const note = document.getElementById('todoNote').value;
        const time = document.getElementById('todoTime').value;
        const date = document.getElementById('todoDate').value;
        const type = document.getElementById('todoType').value;
        const importance = parseInt(document.getElementById('todoImportance').value) || 1;
        const reward = parseFloat(document.getElementById('todoReward').value) || 0;
        const penalty = parseFloat(document.getElementById('todoPenalty').value) || 0;

        if(!title || !time || !date) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼ˆä»»åŠ¡åç§°ã€æˆªæ­¢æ—¶é—´ï¼‰',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }

        // ä¿å­˜æœ¬æ¬¡é‡‘é¢ï¼Œç”¨äºä¸‹æ¬¡å¿«é€‰
        if (reward > 0) {
            lastReward = reward;
            localStorage.setItem('habit_last_reward', reward);
        }
        if (penalty > 0) {
            lastPenalty = penalty;
            localStorage.setItem('habit_last_penalty', penalty);
        }
        renderTodoFundChips(); // æ›´æ–°é‡‘é¢å¿«é€‰èƒ¶å›Š

        if (id) {
            const t = todoList.find(x => String(x.id) === id);
            if (t) {
                t.title = title;
                t.note = note;
                t.time = time;
                t.date = date;
                t.type = type;
                t.importance = importance;
                t.reward = reward;
                t.penalty = penalty;
                t.status = 'pending';
                delete t.archived; // ç¼–è¾‘åå–æ¶ˆå½’æ¡£çŠ¶æ€
            }
        } else {
            const newId = 't_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            todoList.push({ id: newId, date, title, note, time, type, importance, reward, penalty, status: 'pending' });
        }

        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
        cancelEdit();
    }

    function editTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (!t) return;

        document.getElementById('editingId').value = t.id;
        document.getElementById('todoTitle').value = t.title;
        document.getElementById('todoNote').value = t.note || '';
        document.getElementById('todoTime').value = t.time;
        document.getElementById('todoDate').value = t.date;
        document.getElementById('todoType').value = t.type;
        document.getElementById('todoImportance').value = t.importance || 1;
        document.getElementById('todoReward').value = t.reward;
        document.getElementById('todoPenalty').value = t.penalty;

        // æ›´æ–°èƒ¶å›Šé€‰ä¸­çŠ¶æ€
        renderTodoTypeChips();
        renderTodoImportanceChips();

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = 'ä¿å­˜';
        submitBtn.style.fontSize = '16px';

        document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    }

    function cancelEdit() {
        document.getElementById('editingId').value = '';
        document.getElementById('todoTitle').value = '';
        document.getElementById('todoNote').value = '';
        document.getElementById('todoType').value = 'do';
        document.getElementById('todoImportance').value = '1';

        document.getElementById('todoReward').value = '1';
        document.getElementById('todoPenalty').value = '1';
        
        // æ›´æ–°èƒ¶å›Šé€‰ä¸­çŠ¶æ€
        renderTodoTypeChips();
        renderTodoImportanceChips();

        initTodoTime();
        document.getElementById('todoDate').value = getLocalTodayStr();

        const submitBtn = document.getElementById('todoSubmitBtn');
        submitBtn.innerHTML = '+';
        submitBtn.style.fontSize = '20px';
    }

    function toggleTodoNote(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.hideNote = !t.hideNote;
            renderTodos();
            triggerAutoSave();
        }
    }

    function archiveTodo(id) {
        const t = todoList.find(x => String(x.id) === String(id));
        if (t) {
            t.archived = true;
            t.archivedAt = Date.now(); // è®°å½•å½’æ¡£æ—¶é—´æˆ³
            renderTodos();
            triggerAutoSave();
        }
    }

    function addTodo() { saveTodo(); }

    function deleteTodo(id) {
        if(!confirm("åˆ é™¤æ­¤å¾…åŠï¼Ÿ")) return;
        isDeleting = true;
        todoList = todoList.filter(t => String(t.id) !== String(id));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        const el = document.getElementById(`todo-row-${id}`);
        if(el) el.remove();
        setTimeout(() => { 
            renderTodos(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
            triggerAutoSave(); 
            isDeleting = false; 
        }, 300);
    }

    function finishTodoWithAnim(id, result) {
        const btn = document.getElementById(`btn-${id}`);
        if(btn) btn.classList.add('click-anim');
        setTimeout(() => { finishTodo(id, result); }, 300);
    }

    function finishTodo(id, result) {
        const t = todoList.find(x => String(x.id) === String(id));
        if(!t) return;
        t.status = result;

        let fund, theme, displayTitle, recordType;
        if (t.type === 'do' || t.type === 'other') {
            if (result === 'success') { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
            else { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
        } else if (t.type === 'dont') {
            if (result === 'fail') { fund = -t.penalty; theme = 'theme-pay'; recordType = 'todo-fail'; }
            else { fund = t.reward; theme = 'theme-success'; recordType = 'todo-success'; }
        }

        displayTitle = t.title;
        saveRecord({ fund, title: displayTitle, theme, details:{type:'Todoç»“ç®—', result, recordType} }, false);
        renderTodos();
        if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
    }

    function autoCheckTodos() {
        if(isDeleting) return;
        const now = new Date(), currentHm = now.toTimeString().slice(0, 5), todayStr = getLocalTodayStr();
        let changed = false;

        todoList.forEach(t => {
            if (t.date === todayStr && t.status === 'pending' && currentHm > t.time) {
                if (t.type === 'dont') {
                    t.status = 'expired_success';
                    saveRecord({ fund: t.reward, title: t.title, theme: 'theme-success', details: { note: 'åšæŒè¾¾æˆ', recordType: 'todo-success' } }, false);
                    changed = true;
                } else {
                    t.status = 'expired_fail';
                    saveRecord({ fund: -t.penalty, title: t.title, theme: 'theme-pay', details: { note: 'è¶…æ—¶æœªå®Œæˆ', recordType: 'todo-fail' } }, false);
                    changed = true;
                }
            }
        });
        if (changed) { 
            renderTodos(); 
            updateUI(); 
            if (typeof renderQuickTasks === 'function') renderQuickTasks(); // æ›´æ–°è®¡æ—¶é¡µé¢çš„å¿«é€‰èƒ¶å›Š
            triggerAutoSave(); 
        }
    }

    function toggleShopPrivacy() {
        isShopPrivacyOn = !isShopPrivacyOn;
        document.getElementById('shopPrivacyBtn').innerText = isShopPrivacyOn ? 'ğŸ”’' : 'ğŸ‘ï¸';
        renderShop();
    }

    function renderShop() {
        const list = document.getElementById('shopList');
        if (wishList.length === 0) { list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æ„¿æœ›æ¸…å•ç©ºç©ºå¦‚ä¹Ÿ</div>'; return; }

        list.innerHTML = wishList.map((item, idx) => {
            const isHidden = item.hidden && isShopPrivacyOn;
            const nameDisplay = isHidden ? '****** ğŸ”’' : item.name;
            const btnState = isHidden ? 'disabled style="background:var(--border);cursor:not-allowed;"' : 'style="background:var(--warning);color:#fff;" onclick="buyItem(' + idx + ')"';

            const idSuffix = `shop-${idx}`;
            const showClass = (openMenuId === idSuffix) ? 'show' : '';

            const moveUp = idx > 0 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, -1)">â¬†ï¸</div>` : '';
            const moveDown = idx < wishList.length - 1 ? `<div class="btn-action" style="background:var(--info);color:#fff;" onclick="moveWish(${idx}, 1)">â¬‡ï¸</div>` : '';

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold;color:var(--text-main);">${nameDisplay}</div>
                    <div style="font-size:12px;color:var(--warning);">${item.cost}</div>
                </div>
                <div style="display:flex;gap:4px; align-items:center;">
                    <button class="btn-mini" ${btnState}>å…‘æ¢</button>
                    <div class="btn-action" onclick="toggleMenu(event, '${idSuffix}')">â‹®</div>

                    <div id="menu-${idSuffix}" class="action-menu ${showClass}">
                        ${moveUp} ${moveDown}
                        <div class="btn-action btn-edit" onclick="editWish(${idx})">âœï¸</div>
                        <div class="btn-del btn-action" onclick="deleteWish(${idx})">ğŸ—‘ï¸</div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function moveWish(index, direction) {
        if (direction === -1 && index > 0) { [wishList[index], wishList[index-1]] = [wishList[index-1], wishList[index]]; }
        else if (direction === 1 && index < wishList.length - 1) { [wishList[index], wishList[index+1]] = [wishList[index+1], wishList[index]]; }
        else return;
        renderShop(); triggerAutoSave();
    }

    function editWish(index) {
        const item = wishList[index];
        document.getElementById('wishName').value = item.name;
        document.getElementById('wishCost').value = item.cost;

        const checkbox = document.getElementById('wishHidden');
        checkbox.checked = item.hidden || false;
        if(checkbox.checked) { document.getElementById('wishHiddenLabel').classList.add('checked'); }
        else { document.getElementById('wishHiddenLabel').classList.remove('checked'); }

        editingWishIndex = index;
        document.getElementById('btnShopAdd').innerText = "ä¿å­˜";
        document.getElementById('btnShopCancel').style.display = "inline-block";
        document.querySelector('#page-shop .card').scrollIntoView({behavior:'smooth'});
    }

    function cancelShopEdit() {
        document.getElementById('wishName').value = '';
        document.getElementById('wishCost').value = '';
        document.getElementById('wishHidden').checked = false;
        document.getElementById('wishHiddenLabel').classList.remove('checked');

        editingWishIndex = -1;
        document.getElementById('btnShopAdd').innerText = "ä¸Šæ¶";
        document.getElementById('btnShopCancel').style.display = "none";
    }

    function togglePrivacyCheck() {
        const checkbox = document.getElementById('wishHidden');
        const label = document.getElementById('wishHiddenLabel');
        checkbox.checked = !checkbox.checked;
        if(checkbox.checked) { label.classList.add('checked'); } else { label.classList.remove('checked'); }
    }

    function addWish() {
        const n = document.getElementById('wishName').value.trim();
        const c = parseFloat(document.getElementById('wishCost').value);
        const checkbox = document.getElementById('wishHidden');
        const h = checkbox.checked;
        if(!n || !c || c <= 0) return alert("è¯·è¾“å…¥æ­£ç¡®çš„åç§°å’Œä»·æ ¼");

        if (editingWishIndex > -1) {
            wishList[editingWishIndex] = {name:n, cost:c, hidden:h};
            cancelShopEdit();
        } else {
            wishList.push({name:n, cost:c, hidden:h});
            document.getElementById('wishName').value = ''; document.getElementById('wishCost').value = '';
            checkbox.checked = false; document.getElementById('wishHiddenLabel').classList.remove('checked');
        }
        renderShop(); triggerAutoSave();
    }
    function deleteWish(idx) { if(!confirm("ç¡®è®¤åˆ é™¤æ­¤å•†å“ï¼Ÿ")) return; wishList.splice(idx, 1); if(idx === editingWishIndex) cancelShopEdit(); renderShop(); triggerAutoSave(); }
    function buyItem(idx){
        const item = wishList[idx];
        if(globalWallet < item.cost) return alert(`âŒ ä½™é¢ä¸è¶³ï¼è¿˜å·® ${item.cost - globalWallet} å…ƒ`);
        if(!confirm(`ç¡®è®¤æ¶ˆè€— ${item.cost} å…ƒå…‘æ¢ã€${item.name}ã€‘?`)) return;
        saveRecord({fund: -item.cost, title:'å•†åº—å…‘æ¢', theme:'theme-shop', details:{item: item.name}}, false);
    }

    function handlePaymentWithCompress(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let width = img.width, height = img.height;
                if(width > 800) { height *= 800 / width; width = 800; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                const payAmount = globalDebt;
                saveRecord({ fund: -payAmount, title: 'æ”¯ä»˜æ¸…é›¶', theme: 'theme-pay', details: { image: dataUrl, note: 'ä¸Šä¼ å‡­è¯æ¸…é›¶' } }, false);
                alert("âœ… æ”¯ä»˜å‡­è¯å·²ä¸Šä¼ ï¼Œå€ºåŠ¡å·²æ¸…é›¶ï¼");
                
                // æ¸…ç†å†…å­˜
                reader.onload = null;
                img.onload = null;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function updateUI() {
        calculateFunds();
        document.getElementById('timeBankDisplay').innerText = (Number(timeBank) || 0).toFixed(1); // æ›´æ–°æ—¶é—´é“¶è¡Œæ˜¾ç¤º

        const list = document.getElementById('historyList');
        if (historyData.length === 0) {
            list.innerHTML = '<div style="color:var(--text-sub);text-align:center;padding:30px;">æš‚æ— è®°å½•</div>';
        } else {
            const limit = historyFullView ? historyData.length : (config.historyLimit || 5);
            const displayedHistory = historyData.slice(0, limit);

            list.innerHTML = displayedHistory.map(i => {
                if (editingHistoryItemId === i.id) {
                    return `
                    <div class="inline-editor">
                        <div class="input-group"><label class="input-label">è®°å½•æ ‡é¢˜</label><input type="text" id="editItemTitle-${i.id}" value="${i.title}" style="font-weight:bold;"></div>
                        <div class="input-group"><label class="input-label">é‡‘é¢ (å…ƒ)</label><input type="number" id="editItemFund-${i.id}" value="${i.fund}"></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryItem(${i.id})">ğŸ’¾ ä¿å­˜</button>
                            <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                        </div>
                    </div>`;
                }

                let imgHtml = '';
                if(i.details && i.details.image) {
                    imgHtml = `<img src="${i.details.image}" class="record-img" onclick="const w=window.open('about:blank');w.document.write('<img src=${i.details.image} style=width:100%>')">`;
                }
                return ` <div class="list-item"> <div style="flex:1"> <div style="display:flex;justify-content:space-between;align-items:center;"> <span style="font-size:13px;color:var(--text-sub);font-weight:600">${i.date}</span> <span style="font-weight:800;font-size:16px;color:${i.fund>=0 ? (i.theme==='theme-pay'?'var(--danger)':'var(--success)') : (i.theme==='theme-shop'?'var(--warning)':'var(--danger)')}"> ${i.fund>0?'+':''}${i.fund} </span> </div> <div><span style="padding:2px 8px;border-radius:6px;font-size:12px;font-weight:700;background:var(--border);color:var(--text-main);">${i.title}</span> ${imgHtml}</div> <div style="font-size:13px;color:var(--text-sub);margin-top:6px;">${Object.entries(i.details||{}).map(([k,v]) => { if(k==='manual_edit_reason') return `æ”¹:${v}`; if(k==='penalty_rule') return `${v}`; if(k==='image') return ''; return v; }).join(' Â· ')}</div> </div> <div style="display:flex; gap:4px;"> <div class="btn-action" onclick="editItem(${i.id})">âœï¸</div> <div class="btn-action btn-del" onclick="deleteItem(${i.id})">âœ•</div> </div> </div>`;
            }).join('');

            // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
            if (!historyFullView && historyData.length > limit) {
                list.insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleHistoryFullView()">
                        æ›´å¤š
                    </div>`
                );
            } else if (historyFullView && historyData.length > (config.historyLimit || 5)) {
                list.insertAdjacentHTML('beforeend', 
                    `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleHistoryFullView()">
                        æ”¶èµ·
                    </div>`
                );
            }
        }

        const pendingCard = document.getElementById('pendingCard');
        const lastRecord = historyData[0];
        if (lastRecord && (lastRecord.theme === 'theme-repair' || lastRecord.theme === 'theme-fix')) {
            const fixPlan = lastRecord.details.r_fix || lastRecord.details.f_plan;
            if (fixPlan && pendingHiddenId !== lastRecord.id.toString()) {
                pendingCard.style.display = 'block';
                pendingCard.dataset.id = lastRecord.id;
                document.getElementById('pendingText').innerHTML = `${lastRecord.date}: ${fixPlan}`;
            } else { pendingCard.style.display = 'none'; }
        } else { pendingCard.style.display = 'none'; }

        const paySection = document.getElementById('paySection');
        if (globalDebt > 0) { paySection.style.display = 'block'; document.getElementById('debtAmount').innerText = globalDebt; }
        else { paySection.style.display = 'none'; }
        renderStats(); renderShop();
    }

    function editItem(id) {
        editingHistoryItemId = id;
        updateUI();
    }

    function saveInlineHistoryItem(id) {
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        
        const newTitle = document.getElementById(`editItemTitle-${id}`).value.trim();
        const newFund = parseFloat(document.getElementById(`editItemFund-${id}`).value);
        
        if (!newTitle) return alert("è¯·è¾“å…¥æ ‡é¢˜");
        if (newFund === undefined || newFund === null) return alert("è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢");

        record.title = newTitle;
        record.fund = newFund;
        
        editingHistoryItemId = null;
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        updateUI();
        triggerAutoSave();
    }

    function closePendingCard() {
        const card = document.getElementById('pendingCard');
        const id = card.dataset.id;
        if(id) { pendingHiddenId = id.toString(); localStorage.setItem('habit_pending_hide', pendingHiddenId); card.style.display = 'none'; }
    }

    function calculateFunds() {
        let wallet = 0, debt = 0;
        historyData.forEach(i => {
            if(['theme-success'].includes(i.theme) || (i.details && i.details.recordType === 'todo-success')) { wallet += Math.abs(i.fund); }
            else if(i.theme === 'theme-shop') { wallet += i.fund; }
            else if(['theme-fix', 'theme-repair', 'theme-prevent'].includes(i.theme) || (i.details && i.details.recordType === 'todo-fail')) { debt += Math.abs(i.fund); }
            else if(i.theme === 'theme-pay') { debt -= Math.abs(i.fund); }
        });
        globalWallet = Math.max(0, wallet); globalDebt = Math.max(0, debt);
        document.getElementById('walletDisplay').innerText = globalWallet;
        document.getElementById('shopWalletDisplay').innerText = globalWallet;
        document.getElementById('debtDisplay').innerText = globalDebt;
    }

    function saveRecord(data, reload = true) { historyData.unshift({ id: Date.now(), date: document.getElementById('dateInput').value, ...data }); updateUI(); triggerAutoSave(); if(reload) setTimeout(() => location.reload(), 500); }

    function deleteItem(id){
        const record = historyData.find(i => i.id === id);
        if (!record) return;
        if(confirm("åˆ é™¤æ­¤è®°å½•ï¼Ÿ\n(æ³¨æ„ï¼šå…³è”çš„æ—¶é—´é“¶è¡Œå˜åŠ¨å°†è‡ªåŠ¨å›æ»š)")){
            if (record.details && record.details.time_bank_change) {
                const amount = parseFloat(record.details.time_bank_change);
                if (!isNaN(amount)) {
                    timeBank -= amount;
                    localStorage.setItem('habit_time_bank_v1', timeBank);
                    alert(`ğŸ”„ æ—¶é—´é“¶è¡Œèµ„é‡‘å·²å›æ»š: ${amount > 0 ? '-' : '+'}${Math.abs(amount)}h`);
                }
            }

            historyData = historyData.filter(i => i.id !== id);
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
        }
    }

    function autoCalculate() {
        tempTimeDiff = 0; useTimeBank = false;
        const studyInput = document.getElementById('studyInput');
        const studyVal = studyInput.value === '' ? null : parseFloat(studyInput.value);
        const sleepVal = document.getElementById('sleepInput').value;
        const wakeVal = document.getElementById('wakeInput').value;

        if (studyVal === null || studyVal === undefined || isNaN(studyVal) || studyVal < 0 || !sleepVal || !wakeVal) { 
            const card = document.getElementById('analysisCard');
            card.style.display = 'block';
            card.style.textAlign = 'center';
            card.innerHTML = `<div style="color:var(--danger); font-weight:bold; padding:20px;">âš ï¸ è¯·å¡«å…¨æ‰“å¡æ•°æ®åå†ç»“ç®—</div>`;
            return; 
        }

        const limitWake = todayIsWeekend ? config.wakeW : config.wake;
        const limitSleep = todayIsWeekend ? config.sleepW : config.sleep;
        const p = config.penalties;
        let penalty = 0, reasons = [], faults = [], types = [];

        const diff = studyVal - config.study;
        tempTimeDiff = diff;

        if (diff < 0) {
            if (timeBank >= Math.abs(diff)) {
                if(confirm(`ä¸“æ³¨æ—¶é•¿ä¸è¶³ ${Math.abs(diff)}hã€‚\nä½™é¢: ${timeBank.toFixed(1)}hã€‚\n\næ˜¯å¦æ¶ˆè€—å­˜æ¬¾æŠµæ¶ˆæƒ©ç½šï¼Ÿ`)) {
                    useTimeBank = true;
                } else {
                    types.push('study');
                    const gap = Math.abs(diff);
                    if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`å°‘å­¦<1h`); faults.push("è½»å¾®å°‘å­¦"); }
                    else { penalty += parseFloat(p.studyL); reasons.push(`å°‘å­¦â‰¥1h`); faults.push("ä¸¥é‡å°‘å­¦"); }
                }
            } else {
                types.push('study');
                const gap = Math.abs(diff);
                if (gap < 1) { penalty += parseFloat(p.studyS); reasons.push(`å°‘å­¦<1h`); faults.push("è½»å¾®å°‘å­¦"); }
                else { penalty += parseFloat(p.studyL); reasons.push(`å°‘å­¦â‰¥1h`); faults.push("ä¸¥é‡å°‘å­¦"); }
            }
        }

        if (wakeVal > limitWake) { types.push('wake'); const diffW = toMin(wakeVal) - toMin(limitWake); if (diffW < 30) { penalty += parseFloat(p.wakeS); reasons.push(`æ™šèµ·<30m`); faults.push("è½»å¾®æ™šèµ·"); } else { penalty += parseFloat(p.wakeL); reasons.push(`æ™šèµ·â‰¥30m`); faults.push("ä¸¥é‡æ™šèµ·"); } }
        const actSleep = toAdjMin(sleepVal); const limSleep = toAdjMin(limitSleep);
        if (actSleep > limSleep) { types.push('sleep'); const diffS = actSleep - limSleep; if (diffS < 60) { penalty += parseFloat(p.sleepS); reasons.push(`æ™šç¡<1h`); faults.push("è½»å¾®æ™šç¡"); } else { penalty += parseFloat(p.sleepL); reasons.push(`æ™šç¡â‰¥1h`); faults.push("ä¸¥é‡æ™šç¡"); } }

        defaultFund = penalty > 0 ? -penalty : parseFloat(config.reward || 5);
        calcReason = penalty > 0 ? reasons.join(' | ') : "ğŸ‰ å®Œç¾è¾¾æ ‡å¥–åŠ±";
        if(useTimeBank && penalty === 0) calcReason = "âœ¨ å®Œç¾è¾¾æ ‡ (æ—¶é—´é“¶è¡ŒæŠµç”¨)";

        failedTypes = types;
        document.getElementById('analysisCard').style.display = 'block';
        document.getElementById('analysisCard').innerHTML = `<div style="font-weight:700;color:var(--primary);padding:15px;text-align:center;">è¯Šæ–­å®Œæˆï¼Œè¯·åœ¨ä¸‹æ–¹ç¡®è®¤ç»“æœ...</div>`;
        renderForm(penalty > 0 ? (faults.length >= 2 ? 'repair' : 'fix') : 'success', null, useTimeBank);
    }

    function renderForm(type, extraInfo = null, isUsingBank = false) {
        const con = document.getElementById('formContainer');
        con.style.display = 'block';
        document.getElementById('inputCard').style.opacity = '0.5';
        document.getElementById('inputCard').style.pointerEvents = 'none';
        
        let inputs = [], title = '', theme = '', extraHTML = '';
        if (type === 'skip') {
            title = 'ğŸ›Œ ç”³è¯·ä¼‘æ¯'; theme = 'theme-skip'; defaultFund = 0; 
            inputs = [{l:'ç”³è¯·åŸå› ', id:'s_reason', p:'å¿…å¡«'}]; 
            extraHTML = `<div style="font-size:12px;color:var(--text-sub);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">æœ¬æœˆå·²ä¼‘æ¯ ${extraInfo} æ¬¡</div>`;
        } else if (type === 'prevent') {
            title = 'ä¸»åŠ¨å¹²é¢„'; theme = 'theme-prevent';
            const cost = config.preventCost || 10;
            defaultFund = -cost;
            inputs = [{l:'å¹²é¢„è¯´æ˜', id:'p_fix', p:'è¯´æ˜æ¥ä¸‹æ¥çš„è¡ŒåŠ¨è®¡åˆ’'}];
            extraHTML = `<div style="font-size:12px;color:var(--info);background:var(--input-bg);padding:10px;border-radius:10px;margin-bottom:12px;">é£é™©å¯¹å†²é‡‘: ${cost} å…ƒ</div>`;
        } else if (type === 'repair') {
            title = 'æ·±åº¦ä¿®å¤'; theme = 'theme-repair'; 
            inputs = [{l:'å¤±æ§å¤ç›˜', id:'r_reason', p:'åˆ†æåŸå› '}, {l:'è¡¥æ•‘æªæ–½', id:'r_fix', p:'æ˜æ—¥å±•ç¤º'}];
        } else if (type === 'fix') {
            title = 'ä¸€çº§ä¿®æ­£'; theme = 'theme-fix'; 
            inputs = [{l:'åå·®åŸå› ', id:'f_reason', p:'ç®€å•æè¿°'}, {l:'è¡¥å¿è®¡åˆ’', id:'f_plan', p:'æ˜æ—¥å±•ç¤º'}];
        } else {
            title = 'ğŸ‰ å®Œç¾è¾¾æ ‡'; theme = 'theme-success'; 
            inputs = [{l:'ä»Šæ—¥æˆå°±', id:'s_note', p:'è®°ä¸‹ä¸€ä»¶å¼€å¿ƒçš„äº‹'}];
        }

        let moneyTip = defaultFund >= 0 ? `å¥–åŠ±: +${defaultFund}` : `æ‰£ç½š: ${defaultFund}`; 
        if (defaultFund === 0) moneyTip = "æ— èµ„é‡‘å˜åŠ¨";

        let timeTip = '';
        if (isUsingBank) {
            timeTip = `<div style="font-size:12px;color:var(--time);background:var(--time-bg);padding:10px;border-radius:10px;margin-bottom:10px;">é“¶è¡Œæ”¯å‡º: -${Math.abs(tempTimeDiff).toFixed(1)}h</div>`;
        }

        extraHTML += timeTip + `
            <div style="font-size:13px; font-weight:bold; color:${defaultFund>=0?'var(--success)':'var(--danger)'}; background:var(--bg-card); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px; text-align:center;">
                ${moneyTip} å…ƒæ„¿æœ›é‡‘<br>
                <span style="font-weight:normal; opacity:0.8; font-size:11px; color:var(--text-sub)">${calcReason}</span>
            </div>`;

        let html = `
            <div class="card" style="margin-top:0px; border-top: 4px solid ${theme==='theme-success'?'var(--success)':'var(--warning)'}; animation: slideDown 0.4s ease;">
                <div class="card-title">${title}</div>
                ${extraHTML}
                <div style="background:var(--input-bg); border:1px solid var(--border); padding:12px; border-radius:12px; margin-bottom:15px;">
                    <div style="display:flex; align-items:center; justify-content:space-between;">
                        <span style="font-size:13px; font-weight:bold;">æœ€ç»ˆé‡‘é¢:</span>
                        <div style="display:flex;align-items:center;"><span style="margin-right:4px;">Â¥</span><input type="number" id="fundInput" value="${defaultFund}" oninput="checkFundEdit()" style="width:80px; padding:8px; text-align:right;"></div>
                    </div>
                    <div id="fundReasonBox" style="display:none; margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                        <label style="font-size:11px; color:var(--danger); font-weight:bold;">âš ï¸ é‡‘é¢å·²ä¿®æ”¹ï¼Œè¯·å¡«å†™åŸå› :</label>
                        <input type="text" id="fundReason" placeholder="å¿…å¡«..." style="margin-top:4px; font-size:13px;">
                    </div>
                </div>
                ${inputs.map(i => `<div class="input-group"><label class="input-label">${i.l}</label><textarea id="${i.id}" placeholder="${i.p||''}" rows="2"></textarea></div>`).join('')}
                <div id="strategyArea" class="chips-container" style="margin-bottom:15px;"></div>
                <button class="btn-calc" onclick="submitForm('${theme}', '${title}')" style="margin-top:10px;">âœ“ ç¡®è®¤æäº¤</button>
                <button class="btn-calc btn-secondary" onclick="cancelForm()" style="margin-top:8px;">âœ• å–æ¶ˆ</button>
            </div>`;
        con.innerHTML = html;
        if (['theme-repair', 'theme-fix'].includes(theme)) renderStrategies();
    }

    function checkFundEdit() { 
        const val = parseFloat(document.getElementById('fundInput').value); 
        const box = document.getElementById('fundReasonBox'); 
        if (val !== defaultFund) { box.style.display = 'block'; } else { box.style.display = 'none'; } 
    }

    function cancelForm() {
        document.getElementById('formContainer').style.display = 'none';
        document.getElementById('analysisCard').style.display = 'none';
        document.getElementById('inputCard').style.opacity = '1';
        document.getElementById('inputCard').style.pointerEvents = 'auto';
    }

    function submitForm(theme, title) {
        if (theme === 'theme-skip' && !document.getElementById('s_reason').value.trim()) return alert("è¯·å¡«å†™ç”³è¯·åŸå› ");
        if (theme === 'theme-repair' && !document.getElementById('r_fix').value.trim()) return alert("è¯·å¡«å†™è¡¥æ•‘æªæ–½");
        
        const fund = parseFloat(document.getElementById('fundInput').value);
        const fundReason = document.getElementById('fundReason') ? document.getElementById('fundReason').value : '';
        if (fund !== defaultFund && !fundReason.trim()) return alert("âš ï¸ è¯·å¡«å†™æ‰‹åŠ¨ä¿®æ”¹é‡‘é¢çš„åŸå› ï¼");

        let details = {};
        document.getElementById('formContainer').querySelectorAll('textarea, input[type=text]').forEach(i => { 
            if(i.id !== 'fundReason' && i.id.indexOf('input_')!==0) details[i.id] = i.value;
        });

        // ç»Ÿä¸€å¤„ç†æ‰“å¡åŸå§‹æ•°æ®
        const studyVal = parseFloat(document.getElementById('studyInput').value);
        const sleepVal = document.getElementById('sleepInput').value;
        const wakeVal = document.getElementById('wakeInput').value;
        if (studyVal) details.study = studyVal;
        if (sleepVal) details.sleep = sleepVal;
        if (wakeVal) details.wake = wakeVal;

        if (useTimeBank) {
            timeBank -= Math.abs(tempTimeDiff);
            details['time_bank_change'] = `-${Math.abs(tempTimeDiff).toFixed(1)}h`;
            localStorage.setItem('habit_time_bank_v1', timeBank);
        }

        if (calcReason && fund < 0 && theme !== 'theme-prevent') details['penalty_rule'] = calcReason;
        if (fund !== defaultFund) details['manual_edit_reason'] = fundReason;

        // ä¿å­˜è®°å½•ï¼Œä¸é‡æ–°åŠ è½½é¡µé¢
        saveRecord({ fund, title, theme, details }, false);
        
        // å…³é—­è¡¨å•å®¹å™¨
        cancelForm();
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ‰“å¡ç•Œé¢çŠ¶æ€
        const dateStr = document.getElementById('dateInput').value;
        const todayStr = getLocalTodayStr();
        if (dateStr === todayStr) {
            const hasCheckin = historyData.some(r => r.date === dateStr && ['theme-success','theme-fix','theme-repair','theme-prevent','theme-skip'].includes(r.theme));
            if (hasCheckin) {
                document.getElementById('inputCard').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-sub);">ä»Šæ—¥å·²å®Œæˆæ‰“å¡</div>';
                // éšè—æ ‡é¢˜åˆ‡æ¢æŒ‰é’®ï¼Œç›´æ¥æ˜¾ç¤ºå¾…åŠè§†å›¾
                const toggleContainer = document.querySelector('.toggle-container');
                if (toggleContainer) toggleContainer.style.display = 'none';
                toggleHomeView('todo');
            }
        }
        
        // æ›´æ–°UIæ˜¾ç¤º
        updateUI();
    }

    function quickSelectTask(name) {
        document.getElementById('timerTaskName').value = name;
        
        // ç»Ÿè®¡ä½¿ç”¨é¢‘æ¬¡
        if (!taskUsageCount[name]) taskUsageCount[name] = 0;
        taskUsageCount[name]++;
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        
        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ’åº
        renderQuickTasks();
    }

    function selectTodoForTimer(todoId) {
        // ç¡®ä¿èƒ½å¤„ç†å­—ç¬¦ä¸²å’Œæ•°å­—ç±»å‹çš„ID
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        const todo = todoList.find(t => String(t.id) === id);
        if (!todo) {
            console.warn('å¾…åŠæœªæ‰¾åˆ°:', todoId);
            return;
        }
        
        // è®¾ç½®ä»»åŠ¡åç§°
        const taskNameInput = document.getElementById('timerTaskName');
        if (taskNameInput) {
            taskNameInput.value = todo.title;
            // åœ¨ä»»åŠ¡åç§°è¾“å…¥æ¡†ä¸Šå­˜å‚¨todoIdï¼Œæ–¹ä¾¿ç»“æŸæ—¶è¯†åˆ«
            taskNameInput.setAttribute('data-todo-id', id);
        }
        
        // è®¾ç½®ç»“æŸæ—¶é—´ï¼ˆå¦‚æœå¾…åŠæœ‰æˆªæ­¢æ—¶é—´ï¼‰
        if (todo.time) {
            const endTimeInput = document.getElementById('timerPlannedEndTime');
            if (endTimeInput) endTimeInput.value = todo.time;
        }
        
        // å¦‚æœæœ‰å¤‡æ³¨ï¼Œä¹Ÿå¯ä»¥å¡«å……åˆ°å¤‡æ³¨æ¡†
        if (todo.note) {
            const noteInput = document.getElementById('timerNote');
            if (noteInput) noteInput.value = todo.note;
        }
    }

    function addPlannedTask() {
        const name = document.getElementById('timerTaskName').value.trim();
        const note = document.getElementById('timerNote').value.trim();
        const plannedTime = document.getElementById('timerPlannedTime').value;
        const plannedEndTime = document.getElementById('timerPlannedEndTime').value;
        if (!name) return alert("è¯·è¾“å…¥è®¡åˆ’çš„ä»»åŠ¡åç§°");

        const plan = {
            id: Date.now(),
            name: name,
            note: note,
            plannedTime: plannedTime,
            plannedEndTime: plannedEndTime
        };

        plannedTasks.push(plan);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        // æ¸…ç©ºè¾“å…¥æ¡†ï¼ˆä»…åœ¨ç©ºé—²æ—¶ï¼‰
        if (!timerRunning) {
            document.getElementById('timerTaskName').value = '';
            document.getElementById('timerNote').value = '';
            initTimerTime();
            document.getElementById('timerPlannedEndTime').value = '';
        }
        
        renderPlannedTasks();
        triggerAutoSave();
        
        if (timerRunning) {
            alert("âœ… è®¡åˆ’å·²æ·»åŠ ï¼å½“å‰è®¡æ—¶ä»»åŠ¡ä¸å—å½±å“ã€‚");
        }
    }
    
    // è®¡æ—¶å™¨è¿è¡Œæ—¶æ·»åŠ è®¡åˆ’ä»»åŠ¡ï¼ˆä½¿ç”¨ç®€å•å¯¹è¯æ¡†ï¼‰
    function addPlannedTaskWhileRunning() {
        const taskName = prompt("è¯·è¾“å…¥æ–°è®¡åˆ’çš„ä»»åŠ¡åç§°ï¼š");
        if (!taskName || !taskName.trim()) return;
        
        const plannedTime = prompt("è®¡åˆ’å¼€å§‹æ—¶é—´ï¼ˆæ ¼å¼ HH:MMï¼Œå¯ç•™ç©ºï¼‰ï¼š", "");
        const plannedEndTime = prompt("è®¡åˆ’ç»“æŸæ—¶é—´ï¼ˆæ ¼å¼ HH:MMï¼Œå¯ç•™ç©ºï¼‰ï¼š", "");
        const note = prompt("å¤‡æ³¨ï¼ˆå¯ç•™ç©ºï¼‰ï¼š", "") || '';
        
        // éªŒè¯æ—¶é—´æ ¼å¼ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
        if (plannedTime && plannedTime.trim() && !/^\d{1,2}:\d{2}$/.test(plannedTime.trim())) {
            alert("âŒ å¼€å§‹æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MM");
            return;
        }
        if (plannedEndTime && plannedEndTime.trim() && !/^\d{1,2}:\d{2}$/.test(plannedEndTime.trim())) {
            alert("âŒ ç»“æŸæ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MM");
            return;
        }
        
        const plan = {
            id: Date.now(),
            name: taskName.trim(),
            note: note.trim(),
            plannedTime: (plannedTime || '').trim(),
            plannedEndTime: (plannedEndTime || '').trim()
        };
        
        plannedTasks.push(plan);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        renderPlannedTasks();
        triggerAutoSave();
        
        alert(`âœ… è®¡åˆ’ã€Œ${taskName.trim()}ã€å·²æ·»åŠ ï¼\n\nå½“å‰è®¡æ—¶ä»»åŠ¡ã€Œ${document.getElementById('timerTaskName').value}ã€ç»§ç»­è¿è¡Œä¸­ã€‚`);
    }

    function renderPlannedTasks() {
        const list = document.getElementById('plannedTasksList');
        if (plannedTasks.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:10px;font-size:13px;">æš‚æ— è®¡åˆ’ï¼Œå¿«å»æ·»åŠ ä¸€ä¸ªå§</div>';
            return;
        }

        // æŒ‰æ—¶é—´æ’åºï¼Œæ—©çš„æ—¶é—´æ’åœ¨å‰é¢
        plannedTasks.sort((a, b) => {
            const timeA = a.plannedTime || '99:99';
            const timeB = b.plannedTime || '99:99';
            return timeA.localeCompare(timeB);
        });

        list.innerHTML = plannedTasks.map(p => {
            if (editingPlannedId === p.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">ä»»åŠ¡åç§°</label><input type="text" id="editPlanName-${p.id}" value="${p.name}" style="font-weight:bold;"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">èµ·å§‹æ—¶é—´</label><input type="time" id="editPlanStart-${p.id}" value="${p.plannedTime || ''}"></div>
                        <div class="input-group"><label class="input-label">ç»“æŸæ—¶é—´</label><input type="time" id="editPlanEnd-${p.id}" value="${p.plannedEndTime || ''}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">å¤‡æ³¨</label><textarea id="editPlanNote-${p.id}" style="min-height:60px;">${p.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlinePlannedTask(${p.id})">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                    </div>
                </div>`;
            }

            const idSuffix = `plan-${p.id}`;
            const showClass = openMenuId === idSuffix ? 'show' : '';

            return `
            <div class="list-item" style="border-left: 4px solid var(--info); padding-right: 8px;">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${p.name} 
                        ${p.plannedTime || p.plannedEndTime ? `
                        <span style="font-size:11px; color:var(--info); background:var(--border); padding:2px 6px; border-radius:4px; margin-left:4px;">
                            ${p.plannedTime || '--:--'}${p.plannedEndTime ? ' - ' + p.plannedEndTime : ''}
                        </span>` : ''}
                    </div>
                    ${p.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px;">' + p.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:4px; align-items:center;">
                    <button class="btn-mini" style="background:var(--success); color:#fff; padding:6px 10px;" onclick="startFromPlan(${p.id})">â–¶ï¸ å¼€å§‹</button>
                    
                    <div style="position:relative;">
                        <div class="btn-action" onclick="togglePlanMenu(event, '${idSuffix}')">â‹®</div>
                        <div id="menu-${idSuffix}" class="action-menu action-menu-dropdown ${showClass}">
                            <div class="btn-mini" style="background:var(--time); color:#fff; width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="completePlannedTask(${p.id})">âœ… å®Œæˆä»»åŠ¡</div>
                            <div class="btn-mini" style="background:var(--warning); color:#fff; width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="abandonPlannedTask(${p.id})">ğŸš« æ”¾å¼ƒä»»åŠ¡</div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="togglePinTask(${p.id})">
                                ${pinnedTaskId == p.id ? 'å–æ¶ˆç½®é¡¶' : 'è®¾ä¸ºç½®é¡¶'}
                            </div>
                            <div class="btn-mini" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="editPlannedTask(${p.id})">âœï¸ ç¼–è¾‘</div>
                            <div class="btn-mini" style="background:var(--danger-bg); color:var(--danger); border:1px solid var(--danger); width:100%; text-align:left; display:flex; align-items:center; gap:8px;" onclick="deletePlannedTask(${p.id})">ğŸ—‘ï¸ åˆ é™¤è®¡åˆ’</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function togglePlanMenu(event, id) {
        event.stopPropagation();
        if (openMenuId === id) {
            openMenuId = null;
        } else {
            closeAllMenus();
            openMenuId = id;
        }
        renderPlannedTasks();
    }

    let currentReviewDate = getLocalTodayStr();

    function saveDailyReview(showMsg = false) {
        const date = currentReviewDate;
        const great = document.getElementById('reviewGreat').value.trim();
        const improve = document.getElementById('reviewImprove').value.trim();
        
        if (!dailyReviews[date]) dailyReviews[date] = {};
        dailyReviews[date].great = great;
        dailyReviews[date].improve = improve;
        
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        triggerAutoSave();
        
        if(showMsg) alert(`âœ… ${date === getLocalTodayStr() ? 'ä»Šæ—¥' : date} å¤ç›˜å·²ä¿å­˜`);
        
        // ä¿å­˜åé‡ç½®å›ä»Šæ—¥ï¼Œé˜²æ­¢è¯¯æ“ä½œè¦†ç›–å†å²
        currentReviewDate = getLocalTodayStr();
    }

    function loadDailyReview() {
        const date = getLocalTodayStr();
        const review = dailyReviews[date] || { great: '', improve: '' };
        document.getElementById('reviewGreat').value = review.great || '';
        document.getElementById('reviewImprove').value = review.improve || '';
    }

    function toggleHistoryReview() {
        const area = document.getElementById('reviewHistoryArea');
        const inputArea = document.getElementById('reviewInputArea');
        const saveBtn = document.getElementById('btnSaveReview');
        isReviewHistoryOpen = !isReviewHistoryOpen;
        
        if (isReviewHistoryOpen) {
            area.style.display = 'block';
            inputArea.style.display = 'none';
            saveBtn.style.display = 'none';
            renderHistoryReviews();
        } else {
            area.style.display = 'none';
            inputArea.style.display = 'block';
            saveBtn.style.display = 'inline-block';
            // åˆ‡æ¢å›æ¥æ—¶ï¼Œç¡®ä¿åŠ è½½çš„æ˜¯ä»Šæ—¥å†…å®¹ï¼Œé™¤éç”¨æˆ·æ­£åœ¨ç¼–è¾‘å†å²
            if (currentReviewDate === getLocalTodayStr()) {
                loadDailyReview();
            }
        }
    }

    function renderHistoryReviews() {
        const list = document.getElementById('reviewHistoryList');
        const sortedDates = Object.keys(dailyReviews).sort((a,b) => b.localeCompare(a));
        
        if (sortedDates.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">æš‚æ— å†å²å¤ç›˜è®°å½•</div>';
            return;
        }

        list.innerHTML = sortedDates.map(date => {
            const r = dailyReviews[date];
            if (!r || (!r.great && !r.improve)) return '';
            return `
                <div class="review-history-item">
                    <div class="review-history-date">${date}</div>
                    ${r.great ? `
                        <div class="review-history-label">çœŸæ£’:</div>
                        <div class="review-history-content">${r.great}</div>
                    ` : ''}
                    ${r.improve ? `
                        <div class="review-history-label">åŠ æ²¹:</div>
                        <div class="review-history-content">${r.improve}</div>
                    ` : ''}
                    <div style="text-align:right; margin-top:8px;">
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); font-size:10px;" onclick="editHistoricalReview('${date}')">âœï¸ ç¼–è¾‘</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function editHistoricalReview(date) {
        const r = dailyReviews[date];
        if (!r) return;
        
        document.getElementById('reviewGreat').value = r.great || '';
        document.getElementById('reviewImprove').value = r.improve || '';
        currentReviewDate = date; // åˆ‡æ¢ä¿å­˜ç›®æ ‡æ—¥æœŸ
        
        // è‡ªåŠ¨åˆ‡å›åˆ°è¾“å…¥æ¨¡å¼
        isReviewHistoryOpen = false;
        document.getElementById('reviewHistoryArea').style.display = 'none';
        document.getElementById('reviewInputArea').style.display = 'block';
        document.getElementById('btnSaveReview').style.display = 'inline-block';
        alert(`å·²è°ƒå‡º ${date} çš„å¤ç›˜å†…å®¹ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜å°†æ›´æ–°è¯¥æ—¥è®°å½•ã€‚`);
    }

    function editPlannedTask(id) {
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function saveInlinePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;

        const name = document.getElementById(`editPlanName-${id}`).value.trim();
        const start = document.getElementById(`editPlanStart-${id}`).value;
        const end = document.getElementById(`editPlanEnd-${id}`).value;
        const note = document.getElementById(`editPlanNote-${id}`).value.trim();

        if (!name) return alert("è¯·è¾“å…¥åç§°");

        p.name = name;
        p.plannedTime = start;
        p.plannedEndTime = end;
        p.note = note;

        editingPlannedId = null;
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        updateStickyNotif(); // æ›´æ–°ç½®é¡¶é€šçŸ¥
        triggerAutoSave();
    }

    function togglePinTask(id) {
        if (pinnedTaskId == id) {
            pinnedTaskId = null;
        } else {
            pinnedTaskId = id;
        }
        localStorage.setItem('habit_pinned_task_id', pinnedTaskId || '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function unpinTask() {
        pinnedTaskId = null;
        localStorage.setItem('habit_pinned_task_id', '');
        renderPlannedTasks();
        updateStickyNotif();
        triggerAutoSave();
    }

    function startPinnedTask() {
        let taskId = pinnedTaskId;
        // å¦‚æœæ²¡æœ‰æ‰‹åŠ¨ç½®é¡¶ï¼Œåˆ™å¯»æ‰¾ä¸‹ä¸€ä¸ªæœ€è¿‘çš„ä»»åŠ¡
        if (!taskId) {
            const next = getNextPlannedTask();
            if (next) taskId = next.id;
        }

        if (taskId) {
            startFromPlan(parseInt(taskId));
            if (pinnedTaskId == taskId) unpinTask();
        }
    }

    function getNextPlannedTask() {
        if (plannedTasks.length === 0) return null;
        const nowHm = new Date().toTimeString().slice(0, 5);
        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªèµ·å§‹æ—¶é—´å¤§äºç­‰äºå½“å‰æ—¶é—´çš„ä»»åŠ¡
        // (plannedTasks å·²ç»æŒ‰æ—¶é—´æ’å¥½åºäº†)
        return plannedTasks.find(p => p.plannedTime && p.plannedTime >= nowHm) || null;
    }

    // è®¡ç®—ä»Šå¤©å·²å­¦ä¹ æ—¶é—´ï¼ˆåªç»Ÿè®¡ä»»åŠ¡ååŒ…å«"å­¦ä¹ "çš„è®¡æ—¶ï¼‰
    function getTodayStudyTime() {
        const todayStr = getLocalTodayStr();
        const studyRecords = timerRecords.filter(r => 
            r.date === todayStr && 
            r.name && 
            (r.name.includes('å­¦ä¹ ') || r.name.includes('study') || r.name.toLowerCase().includes('study'))
        );
        const totalHours = studyRecords.reduce((sum, r) => sum + parseFloat(r.duration || 0), 0);
        return totalHours;
    }

    function updateStickyNotif() {
        const bar = document.getElementById('stickyNotifBar');
        const notifTimer = document.getElementById('notifTimer');
        const notifPinned = document.getElementById('notifPinned');
        const notifQuickStudy = document.getElementById('notifQuickStudy');
        
        let hasContent = false;

        // 1. æ›´æ–°è®¡æ—¶å™¨é€šçŸ¥
        if (timerRunning) {
            notifTimer.style.display = 'flex';
            document.getElementById('notifTimerName').innerText = document.getElementById('timerTaskName').value || 'ä»»åŠ¡';
            // æ›´æ–°æš‚åœæŒ‰é’®æ–‡å­—
            const pauseBtn = document.getElementById('notifTimerPauseBtn');
            if (pauseBtn) {
                pauseBtn.innerText = timerPaused ? 'â–¶ï¸' : 'â¸ï¸';
            }
            hasContent = true;
            // è®¡æ—¶è¿è¡Œæ—¶éšè—å­¦ä¹ å¿«é€ŸæŒ‰é’®
            if (notifQuickStudy) notifQuickStudy.style.display = 'none';
        } else {
            notifTimer.style.display = 'none';
            // è®¡æ—¶æœªè¿è¡Œæ—¶ï¼Œæ ¹æ®é…ç½®æ˜¾ç¤ºå­¦ä¹ å¿«é€ŸæŒ‰é’®
            const interfaceConfig = config.interface || { showQuickStudy: true };
            if (notifQuickStudy && interfaceConfig.showQuickStudy !== false) {
                notifQuickStudy.style.display = 'flex';
                // æ›´æ–°ä»Šå¤©å·²å­¦ä¹ æ—¶é—´
                const studyTime = getTodayStudyTime();
                const studyTimeEl = document.getElementById('notifStudyTime');
                if (studyTimeEl) {
                    studyTimeEl.innerText = studyTime.toFixed(1) + 'h';
                }
                hasContent = true;
            } else if (notifQuickStudy) {
                notifQuickStudy.style.display = 'none';
            }
        }

        // 2. æ›´æ–°ç½®é¡¶é€šçŸ¥ (ä¼˜å…ˆæ‰‹åŠ¨ç½®é¡¶ï¼Œå…¶æ¬¡è‡ªåŠ¨æ˜¾ç¤ºä¸‹ä¸€ä¸ªæœ€è¿‘ä»»åŠ¡)
        let displayTask = null;
        let isAutoPinned = false;

        if (pinnedTaskId) {
            displayTask = plannedTasks.find(x => x.id == pinnedTaskId);
            if (!displayTask) {
                pinnedTaskId = null;
                localStorage.setItem('habit_pinned_task_id', '');
            }
        }

        if (!displayTask) {
            displayTask = getNextPlannedTask();
            isAutoPinned = !!displayTask;
        }

        if (displayTask) {
            notifPinned.style.display = 'flex';
            const prefix = isAutoPinned ? 'ä¸‹ä¸€è®¡åˆ’: ' : 'ç½®é¡¶è®¡åˆ’: ';
            document.getElementById('notifPinnedName').innerText = displayTask.name;
            document.getElementById('notifPinnedTime').innerText = displayTask.plannedTime ? `${prefix}${displayTask.plannedTime}` : prefix;
            hasContent = true;
        } else {
            notifPinned.style.display = 'none';
        }

        bar.style.display = hasContent ? 'flex' : 'none';
    }

    // å¿«é€Ÿå¯åŠ¨"å­¦ä¹ "è®¡æ—¶
    function quickStartStudy() {
        if (timerRunning) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'å·²æœ‰è®¡æ—¶åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸå½“å‰è®¡æ—¶',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }
        
        // åˆ‡æ¢åˆ°è®¡æ—¶é¡µé¢
        switchPage('timer');
        
        // è®¾ç½®ä»»åŠ¡åç§°ä¸º"å­¦ä¹ "
        const timerTaskName = document.getElementById('timerTaskName');
        if (timerTaskName) {
            timerTaskName.value = 'å­¦ä¹ ';
        }
        
        // ç›´æ¥å¼€å§‹è®¡æ—¶
        setTimeout(() => {
            startTimer();
        }, 100);
    }

    function startFromPlan(id) {
        const plan = plannedTasks.find(x => x.id === id);
        if (!plan) return;

        if (timerRunning) return alert("å·²æœ‰è®¡æ—¶åœ¨è¿›è¡Œä¸­ï¼Œè¯·å…ˆç»“æŸå½“å‰è®¡æ—¶");

        document.getElementById('timerTaskName').value = plan.name;
        document.getElementById('timerNote').value = plan.note || '';
        document.getElementById('timerPlannedTime').value = plan.plannedTime || '';
        document.getElementById('timerPlannedEndTime').value = plan.plannedEndTime || '';
        
        isTimerFromPlan = true; // æ ‡è®°æ¥è‡ªè®¡åˆ’

        // ä»è®¡åˆ’ä¸­ç§»é™¤
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        
        renderPlannedTasks();
        startTimer(true); // ä¼ å…¥ true è¡¨ç¤ºä¸é‡ç½® isTimerFromPlan
        triggerAutoSave(); // ç¡®ä¿ä»è®¡åˆ’å¼€å§‹ä¹ŸåŒæ­¥
    }

    function completePlannedTask(id) {
        const p = plannedTasks.find(x => x.id === id);
        if (!p) return;
        
        // å¦‚æœå·²ç»æœ‰èµ·æ­¢æ—¶é—´ï¼Œç›´æ¥å®Œæˆ
        if (p.plannedTime && p.plannedEndTime) {
            const hours = getTimeDiff(p.plannedTime, p.plannedEndTime);
            if (hours > 0) {
                const record = {
                    id: Date.now(),
                    name: p.name,
                    duration: hours.toFixed(2),
                    seconds: Math.floor(hours * 3600),
                    note: p.note,
                    date: getLocalTodayStr(),
                    startTime: p.plannedTime,
                    time: p.plannedEndTime,
                    isPlanned: true
                };
                timerRecords.unshift(record);
                if (pinnedTaskId == id) unpinTask(); // å¦‚æœå®Œæˆçš„æ˜¯ç½®é¡¶ä»»åŠ¡ï¼Œå–æ¶ˆç½®é¡¶
                plannedTasks = plannedTasks.filter(x => x.id !== id);
                localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
                localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                renderTimerHistory();
                renderPlannedTasks();
                
                // è¯¢é—®æ˜¯å¦æ·»åŠ å¥–åŠ±é‡‘
                showModal({
                    title: 'âœ… å®Œæˆè®¡åˆ’',
                    message: `è®¡åˆ’ä»»åŠ¡ã€Œ${p.name}ã€å·²å®Œæˆ\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶\n\næ˜¯å¦æ·»åŠ æ„¿æœ›é‡‘ï¼ˆå¥–åŠ±ï¼‰ï¼Ÿ`,
                    buttons: [
                        { text: 'ä¸æ·»åŠ ', primary: false, callback: () => {
                            updateUI();
                            triggerAutoSave();
                        }},
                        { text: 'æ·»åŠ å¥–åŠ±', primary: true, callback: () => {
                            showModal({
                                title: 'æ·»åŠ å¥–åŠ±é‡‘',
                                message: `ä»»åŠ¡ï¼š${p.name}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
                                inputs: [
                                    { id: 'planRewardAmount', label: 'é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                                    { id: 'planRewardReason', label: 'åŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `å®Œæˆè®¡åˆ’ä»»åŠ¡ã€Œ${p.name}ã€` }
                                ],
                                buttons: [
                                    { text: 'å–æ¶ˆ', primary: false, callback: () => {
                                        updateUI();
                                        triggerAutoSave();
                                    }},
                                    { text: 'ç¡®è®¤æ·»åŠ ', primary: true, callback: (values) => {
                                        const amount = parseFloat(values.planRewardAmount);
                                        if (!isNaN(amount) && amount > 0) {
                                            const fundRecord = {
                                                id: Date.now() + 1,
                                                date: getLocalTodayStr(),
                                                title: `å®Œæˆè®¡åˆ’ï¼š${p.name}`,
                                                fund: amount,
                                                theme: 'theme-success',
                                                details: {
                                                    note: values.planRewardReason,
                                                    duration: hours.toFixed(2) + 'h',
                                                    plannedTime: `${p.plannedTime} - ${p.plannedEndTime}`
                                                }
                                            };
                                            historyData.unshift(fundRecord);
                                            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                                        }
                                        updateUI();
                                        triggerAutoSave();
                                    }}
                                ]
                            });
                        }}
                    ]
                });
                return;
            }
        }
        
        // å¦åˆ™è¿›å…¥ç¼–è¾‘çŠ¶æ€å®Œå–„æ—¶é—´
        alert("è¯·å®Œå–„è®¡åˆ’çš„èµ·æ­¢æ—¶é—´å†ç‚¹å‡»å®Œæˆ");
        editingPlannedId = id;
        renderPlannedTasks();
    }

    function deletePlannedTask(id) {
        if (!confirm("ç¡®å®šå–æ¶ˆæ­¤è®¡åˆ’ï¼Ÿ")) return;
        if (pinnedTaskId == id) unpinTask(); // å¦‚æœå–æ¶ˆçš„æ˜¯ç½®é¡¶ä»»åŠ¡ï¼Œç§»é™¤é€šçŸ¥
        plannedTasks = plannedTasks.filter(x => x.id !== id);
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        renderPlannedTasks();
        triggerAutoSave();
    }
    
    function abandonPlannedTask(id) {
        const task = plannedTasks.find(x => x.id === id);
        if (!task) return;
        
        showModal({
            title: 'ğŸš« æ”¾å¼ƒè®¡åˆ’',
            message: `ç¡®å®šè¦æ”¾å¼ƒè®¡åˆ’ä»»åŠ¡ã€Œ${task.name}ã€å—ï¼Ÿ\n\nå¯ä»¥é€‰æ‹©æ˜¯å¦æ·»åŠ ç½šé‡‘`,
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { text: 'ä»…åˆ é™¤è®¡åˆ’', primary: false, callback: () => {
                    if (pinnedTaskId == id) unpinTask();
                    plannedTasks = plannedTasks.filter(x => x.id !== id);
                    localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                    renderPlannedTasks();
                    updateUI();
                    triggerAutoSave();
                }},
                { text: 'æ·»åŠ ç½šé‡‘å¹¶åˆ é™¤', primary: true, callback: () => {
                    showModal({
                        title: 'æ·»åŠ ç½šé‡‘',
                        message: `æ”¾å¼ƒä»»åŠ¡ï¼š${task.name}`,
                        inputs: [
                            { id: 'penaltyAmount', label: 'ç½šé‡‘é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                            { id: 'penaltyReason', label: 'æ”¾å¼ƒåŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `æ”¾å¼ƒè®¡åˆ’ä»»åŠ¡ã€Œ${task.name}ã€` }
                        ],
                        buttons: [
                            { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                            { text: 'ç¡®è®¤', primary: true, callback: (values) => {
                                const penalty = parseFloat(values.penaltyAmount);
                                if (!isNaN(penalty) && penalty > 0) {
                                    const fundRecord = {
                                        id: Date.now(),
                                        date: getLocalTodayStr(),
                                        title: `æ”¾å¼ƒè®¡åˆ’ï¼š${task.name}`,
                                        fund: -penalty,
                                        theme: 'theme-repair',
                                        details: {
                                            note: values.penaltyReason,
                                            plannedTime: task.plannedTime || '--',
                                            plannedEndTime: task.plannedEndTime || '--'
                                        }
                                    };
                                    historyData.unshift(fundRecord);
                                    localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                                }
                                
                                if (pinnedTaskId == id) unpinTask();
                                plannedTasks = plannedTasks.filter(x => x.id !== id);
                                localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
                                renderPlannedTasks();
                                updateUI();
                                triggerAutoSave();
                            }}
                        ]
                    });
                }}
            ]
        });
    }

    function startTimer(fromPlan = false) {
        if (!document.getElementById('timerTaskName').value.trim()) {
            showModal({
                title: 'âš ï¸ æç¤º',
                message: 'è¯·å…ˆè¾“å…¥ä»»åŠ¡åç§°',
                buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
            });
            return;
        }
        timerRunning = true;
        timerPaused = false;
        if (!fromPlan) isTimerFromPlan = false; // å¦‚æœä¸æ˜¯ä»è®¡åˆ’å¼€å§‹ï¼Œé‡ç½®æ ‡å¿—
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'none';
        if (activeBtns) activeBtns.style.display = 'flex';
        
        updateStickyNotif(); // å¼€å¯æ—¶æ˜¾ç¤ºç½®é¡¶é€šçŸ¥
        saveTimerState(); // ä¿å­˜è®¡æ—¶å™¨çŠ¶æ€
        triggerAutoSave(); // åŒæ­¥åˆ°äº‘ç«¯

        timerInterval = setInterval(() => {
            if (!timerPaused) {
                timerSeconds++;
                updateTimerUI();
                saveTimerState(); // æ¯ç§’ä¿å­˜ä¸€æ¬¡çŠ¶æ€åˆ°æœ¬åœ°
            }
        }, 1000);
        
        // æ¯30ç§’åŒæ­¥ä¸€æ¬¡åˆ°äº‘ç«¯ï¼Œç¡®ä¿å¤šè®¾å¤‡èƒ½åŠæ—¶è·å–æœ€æ–°çŠ¶æ€
        timerSyncInterval = setInterval(async () => {
            if (timerRunning && ghConfig.token && ghConfig.repo) {
                console.log('ğŸ”„ å®šæœŸåŒæ­¥è®¡æ—¶å™¨çŠ¶æ€...');
                // å…ˆ pull æ£€æŸ¥äº‘ç«¯æ˜¯å¦æœ‰å˜åŒ–ï¼ˆæ¯”å¦‚å…¶ä»–è®¾å¤‡å·²ç»“æŸè®¡æ—¶ï¼‰
                await syncGitHub('pull', true);
                // å¦‚æœè®¡æ—¶å™¨è¿˜åœ¨è¿è¡Œï¼ˆæ²¡æœ‰è¢« pull åœæ­¢ï¼‰ï¼Œå† push æœ¬åœ°çŠ¶æ€
                if (timerRunning) {
                    triggerAutoSave();
                }
            } else if (timerRunning) {
                // å¦‚æœæ²¡æœ‰é…ç½® GitHubï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                saveTimerState();
            }
        }, 30000); // 30ç§’
    }

    function toggleTimerPause() {
        timerPaused = !timerPaused;
        const btnTimerPause = document.getElementById('btnTimerPause');
        if (btnTimerPause) btnTimerPause.innerText = timerPaused ? 'â–¶ï¸ ç»§ç»­' : 'â¸ï¸ æš‚åœ';
        // æ›´æ–°é€šçŸ¥æ çš„æš‚åœæŒ‰é’®
        const notifPauseBtn = document.getElementById('notifTimerPauseBtn');
        if (notifPauseBtn) notifPauseBtn.innerText = timerPaused ? 'â–¶ï¸' : 'â¸ï¸';
        saveTimerState(); // ä¿å­˜æš‚åœçŠ¶æ€
        triggerAutoSave(); // åŒæ­¥åˆ°äº‘ç«¯
    }

    function updateTimerUI() {
        const h = Math.floor(timerSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((timerSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (timerSeconds % 60).toString().padStart(2, '0');
        const clockStr = `${h}:${m}:${s}`;
        
        // æ›´æ–°ç½®é¡¶é€šçŸ¥æ çš„æ—¶é’Ÿ
        const notifClock = document.getElementById('notifTimerClock');
        if (notifClock) notifClock.innerText = clockStr;
    }

    function stopTimer() {
        const hours = timerSeconds / 3600;
        const taskName = document.getElementById('timerTaskName').value;
        
        showModal({
            title: 'ç»“æŸè®¡æ—¶',
            message: `ç¡®è®¤ç»“æŸæœ¬æ¬¡è®¡æ—¶å¹¶ä¿å­˜ï¼Ÿ\n\nä»»åŠ¡ï¼š${taskName}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                { text: 'ç¡®è®¤ç»“æŸ', primary: true, callback: () => { finalizeStopTimer(); } }
            ]
        });
    }
    
    function finalizeStopTimer() {
        clearInterval(timerInterval);
        clearInterval(timerSyncInterval); // æ¸…é™¤åŒæ­¥å®šæ—¶å™¨
        const hours = timerSeconds / 3600;
        const taskName = document.getElementById('timerTaskName').value;
        const note = document.getElementById('timerNote').value;
        const endTime = new Date().toTimeString().slice(0, 5);
        const startTime = calculateStartTime(endTime, hours);
        const taskInput = document.getElementById('timerTaskName');
        const todoId = taskInput.getAttribute('data-todo-id');

        // ä¿å­˜è®°å½•
        const record = {
            id: Date.now(),
            name: taskName,
            duration: hours.toFixed(2),
            seconds: timerSeconds,
            note: note,
            date: getLocalTodayStr(),
            startTime: startTime,
            time: endTime,
            isPlanned: isTimerFromPlan,
            todoId: todoId ? parseInt(todoId) : null
        };
        
        timerRecords.unshift(record);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        // æ›´æ–°å­¦ä¹ æ—¶é—´æ˜¾ç¤º
        updateStickyNotif();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„å¾…åŠäº‹é¡¹
        if (todoId) {
            const id = String(todoId);
            const todo = todoList.find(t => String(t.id) === id && t.status === 'pending');
            if (todo) {
                const reward = todo.reward || 0;
                showModal({
                    title: 'âœ… å®Œæˆå¾…åŠï¼Ÿ',
                    message: `è®¡æ—¶å·²ç»“æŸï¼\n\næ˜¯å¦åŒæ—¶å®Œæˆå¾…åŠäº‹é¡¹ã€Œ${todo.title}ã€ï¼Ÿ\nå®Œæˆå°†è·å¾— +${reward} å…ƒæ„¿æœ›é‡‘`,
                    buttons: [
                        { text: 'æš‚ä¸å®Œæˆ', primary: false, callback: () => { askForFunds(taskName, hours); } },
                        { text: 'å®Œæˆå¾…åŠ', primary: true, callback: () => {
                            finishTodo(id, 'success');
                            askForFunds(taskName, hours);
                        }}
                    ]
                });
                return;
            }
        }
        
        // ç›´æ¥è¯¢é—®æ·»åŠ å¥–åŠ±/ç½šé‡‘
        askForFunds(taskName, hours);
    }
    
    function askForFunds(taskName, hours) {
        showModal({
            title: 'æ·»åŠ å¥–åŠ±/æƒ©ç½š',
            message: `è®¡æ—¶ä»»åŠ¡ã€Œ${taskName}ã€å·²å®Œæˆ\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶\n\næ˜¯å¦æ·»åŠ æ„¿æœ›é‡‘æˆ–ç½šé‡‘ï¼Ÿ`,
            buttons: [
                { text: 'ä¸æ·»åŠ ', primary: false, callback: () => { completeTimerStop(); } },
                { text: 'æ·»åŠ å¥–åŠ±', primary: true, callback: () => { showFundInput(taskName, hours, true); } },
                { text: 'æ·»åŠ ç½šé‡‘', primary: false, callback: () => { showFundInput(taskName, hours, false); } }
            ]
        });
    }
    
    function showFundInput(taskName, hours, isReward) {
        showModal({
            title: isReward ? 'æ·»åŠ æ„¿æœ›é‡‘' : 'æ·»åŠ ç½šé‡‘',
            message: `ä»»åŠ¡ï¼š${taskName}\nç”¨æ—¶ï¼š${hours.toFixed(2)} å°æ—¶`,
            inputs: [
                { id: 'fundAmount', label: 'é‡‘é¢ï¼ˆå…ƒï¼‰', type: 'number', placeholder: 'è¾“å…¥é‡‘é¢', value: '' },
                { id: 'fundReason', label: 'åŸå› /å¤‡æ³¨', type: 'textarea', placeholder: 'è®°å½•ä¸€ä¸‹åŸå› ', value: `å®Œæˆè®¡æ—¶ä»»åŠ¡ã€Œ${taskName}ã€` }
            ],
            buttons: [
                { text: 'å–æ¶ˆ', primary: false, callback: () => { completeTimerStop(); } },
                { text: 'ç¡®è®¤æ·»åŠ ', primary: true, callback: (values) => {
                    const amount = parseFloat(values.fundAmount);
                    if (isNaN(amount) || amount <= 0) {
                        completeTimerStop();
                        return;
                    }
                    
                    const fundRecord = {
                        id: Date.now() + 1,
                        date: getLocalTodayStr(),
                        title: isReward ? `è®¡æ—¶å¥–åŠ±ï¼š${taskName}` : `è®¡æ—¶æƒ©ç½šï¼š${taskName}`,
                        fund: isReward ? amount : -amount,
                        theme: isReward ? 'theme-success' : 'theme-repair',
                        details: {
                            note: values.fundReason,
                            timerDuration: hours.toFixed(2) + 'h'
                        }
                    };
                    
                    historyData.unshift(fundRecord);
                    localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
                    completeTimerStop();
                }}
            ]
        });
    }
    
    function completeTimerStop() {
        // é‡ç½®UI
        timerSeconds = 0;
        timerRunning = false;
        isTimerFromPlan = false;
        updateTimerUI();
        document.getElementById('timerTaskName').value = '';
        document.getElementById('timerTaskName').removeAttribute('data-todo-id');
        document.getElementById('timerNote').value = '';
        initTimerTime();
        
        const idleBtns = document.getElementById('timerIdleBtns');
        const activeBtns = document.getElementById('timerActiveBtns');
        if (idleBtns) idleBtns.style.display = 'flex';
        if (activeBtns) activeBtns.style.display = 'none';
        
        updateStickyNotif();
        localStorage.removeItem('habit_timer_state_v1');
        console.log('â¹ï¸ è®¡æ—¶å™¨å·²ç»“æŸï¼Œå‡†å¤‡åŒæ­¥åˆ°äº‘ç«¯...');

        renderTimerHistory();
        renderQuickTasks();
        updateUI();
        triggerAutoSave();
    }

    function renderTimerHistory() {
        const list = document.getElementById('timerHistoryList');
        if (timerRecords.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:20px;">æš‚æ— è®¡æ—¶è®°å½•</div>';
            return;
        }

        const limit = timerFullView ? timerRecords.length : (config.timerLimit || 5);
        const displayedRecords = timerRecords.slice(0, limit);

        list.innerHTML = displayedRecords.map(r => {
            const startTime = r.startTime || calculateStartTime(r.time, r.duration);
            
            if (editingTimerRecordId === r.id) {
                return `
                <div class="inline-editor">
                    <div class="input-group"><label class="input-label">ä»»åŠ¡åç§°</label><input type="text" id="editHistoryName-${r.id}" value="${r.name}" style="font-weight:bold;"></div>
                    <div class="row">
                        <div class="input-group"><label class="input-label">èµ·å§‹æ—¶é—´</label><input type="time" id="editHistoryStart-${r.id}" value="${startTime}"></div>
                        <div class="input-group"><label class="input-label">ç»“æŸæ—¶é—´</label><input type="time" id="editHistoryEnd-${r.id}" value="${r.time}"></div>
                    </div>
                    <div class="input-group"><label class="input-label">å¤‡æ³¨</label><textarea id="editHistoryNote-${r.id}" style="min-height:60px;">${r.note || ''}</textarea></div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn-mini" style="background:var(--success); color:#fff; flex:1" onclick="saveInlineHistoryRecord(${r.id})">ğŸ’¾ ä¿å­˜</button>
                        <button class="btn-mini" style="background:var(--border); color:var(--text-main); flex:1" onclick="cancelInlineEdit()">âœ• å–æ¶ˆ</button>
                    </div>
                </div>`;
            }

            return `
            <div class="list-item">
                <div style="flex:1">
                    <div style="font-weight:bold; color:var(--text-main);">${r.name}</div>
                    <div style="font-size:12px; color:var(--primary);">${r.duration}h | ${r.date} ${startTime} - ${r.time}</div>
                    ${r.note ? '<div style="font-size:11px; color:var(--text-sub); margin-top:4px; background:var(--input-bg); padding:4px; border-radius:4px;">' + r.note + '</div>' : ''}
                </div>
                <div style="display:flex; gap:8px;">
                    <div class="btn-action" onclick="editTimerRecord(${r.id})">âœï¸</div>
                    <div class="btn-action btn-del" onclick="deleteTimerRecord(${r.id})">âœ•</div>
                </div>
            </div>
        `;}).join('');

        // å¦‚æœæœ‰æ›´å¤šï¼Œæ˜¾ç¤ºä¸€ä¸ªæç¤º
        if (!timerFullView && timerRecords.length > limit) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; font-size:11px; color:var(--primary); padding:12px; cursor:pointer; font-weight:600;" onclick="toggleTimerFullView()">
                    æ›´å¤š
                </div>`
            );
        } else if (timerFullView && timerRecords.length > (config.timerLimit || 5)) {
            list.insertAdjacentHTML('beforeend', 
                `<div style="text-align:center; font-size:11px; color:var(--text-sub); padding:12px; cursor:pointer;" onclick="toggleTimerFullView()">
                    æ”¶èµ·
                </div>`
            );
        }
    }

    function editTimerRecord(id) {
        editingTimerRecordId = id;
        renderTimerHistory();
    }

    function saveInlineHistoryRecord(id) {
        const r = timerRecords.find(x => x.id === id);
        if (!r) return;
        
        const name = document.getElementById(`editHistoryName-${id}`).value.trim();
        const start = document.getElementById(`editHistoryStart-${id}`).value;
        const end = document.getElementById(`editHistoryEnd-${id}`).value;
        const note = document.getElementById(`editHistoryNote-${id}`).value.trim();

        if (!name) return alert("è¯·è¾“å…¥åç§°");

        const newDuration = getTimeDiff(start, end);
        if (!newDuration || newDuration < 0) return alert("æ—¶é—´è®¾ç½®ä¸åˆæ³•");

        r.name = name;
        r.startTime = start;
        r.time = end;
        r.duration = newDuration.toFixed(2);
        r.seconds = Math.floor(newDuration * 3600);
        r.note = note;

        editingTimerRecordId = null;
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        
        renderTimerHistory();
        updateUI();
        triggerAutoSave();
    }

    function deleteTimerRecord(id) {
        if (!confirm("ç¡®å®šåˆ é™¤æ­¤è®°å½•ï¼Ÿ")) return;
        timerRecords = timerRecords.filter(r => r.id !== id);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        renderTimerHistory();
        triggerAutoSave();
    }

    function toMin(t){ const[h,m]=t.split(':').map(Number); return h*60+m; }
    function toAdjMin(t){ let[h,m]=t.split(':').map(Number); if(h<12)h+=24; return h*60+m; }

    function calculateStartTime(endTime, durationHours) {
        let [h, m] = endTime.split(':').map(Number);
        let totalMin = h * 60 + m - Math.round(parseFloat(durationHours) * 60);
        while (totalMin < 0) totalMin += 24 * 60;
        let sh = Math.floor(totalMin / 60 % 24).toString().padStart(2, '0');
        let sm = (totalMin % 60).toString().padStart(2, '0');
        return `${sh}:${sm}`;
    }

    function getTimeDiff(start, end) {
        let [sh, sm] = start.split(':').map(Number);
        let [eh, em] = end.split(':').map(Number);
        let startMin = sh * 60 + sm;
        let endMin = eh * 60 + em;
        if (endMin < startMin) endMin += 24 * 60; 
        return (endMin - startMin) / 60;
    }

    function checkWeekend() {
        const date = new Date(document.getElementById('dateInput').value);
        const day = date.getDay();
        const we = config.weekend || [0, 6];
        todayIsWeekend = we.includes(day);
        document.getElementById('dayTypeBadge').style.display = todayIsWeekend ? 'inline-block' : 'none';
        document.getElementById('targetWake').innerText = `â‰¤ ${todayIsWeekend ? config.wakeW : config.wake}`;
        document.getElementById('targetSleep').innerText = `â‰¤ ${todayIsWeekend ? config.sleepW : config.sleep}`;
    }

    function setStatPeriod(p) {
        document.getElementById('statPeriod').value = p;
        renderStats();
    }

    function renderStats() {
        const period = document.getElementById('statPeriod').value;
        const todayStr = getLocalTodayStr();
        
        let filterDates = [];

        if (period === 'today') {
            filterDates = [todayStr];
        } else if (period === 'yesterday') {
            const yest = new Date();
            yest.setDate(yest.getDate() - 1);
            filterDates = [yest.toISOString().split('T')[0]];
        } else if (period === 'all') {
            filterDates = historyData.map(r => r.date);
        } else {
            const days = parseInt(period);
            for(let i=days-1; i>=0; i--) { 
                const d=new Date(); 
                d.setDate(d.getDate()-i); 
                filterDates.push(d.toISOString().split('T')[0]); 
            }
        }

        // çƒ­åŠ›å›¾å§‹ç»ˆæ˜¾ç¤ºæœ€è¿‘7å¤©
        const heatmapDates = [];
        for(let i=6; i>=0; i--) { const d=new Date(); d.setDate(d.getDate()-i); heatmapDates.push(d.toISOString().split('T')[0]); }
        const hm = document.getElementById('heatmap');
        hm.innerHTML = heatmapDates.map(date => {
            const rec = historyData.find(r => r.date === date);
            let cls = 'hm-none';
            if (rec) { if (rec.theme.includes('success')) cls = 'hm-success'; else if (rec.theme.includes('fix')) cls = 'hm-fix'; else if (rec.theme.includes('repair')) cls = 'hm-repair'; }
            return `<div class="heatmap-day"><div class="heatmap-box ${cls}"></div><div style="font-size:9px;color:var(--text-sub)">${date.slice(5)}</div></div>`;
        }).join('');

        const filteredHistory = historyData.filter(r => filterDates.includes(r.date) && !['theme-skip','theme-shop','theme-pay'].includes(r.theme));
        const total = filteredHistory.reduce((a,c) => a + parseFloat(c.study||0), 0);
        const rate = filteredHistory.length ? Math.round((filteredHistory.filter(r => r.theme==='theme-success').length/filteredHistory.length)*100) : 0;
        
        document.getElementById('statStudy').innerText = total.toFixed(1) + 'h';
        document.getElementById('statRate').innerText = rate + '%';

        // ä¸“æ³¨è®¡æ—¶ç»Ÿè®¡ä¹Ÿå—å‘¨æœŸå½±å“
        const filteredTimerRecords = timerRecords.filter(r => filterDates.includes(r.date));
        const timerTotal = filteredTimerRecords.reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerToday = timerRecords.filter(r => r.date === todayStr).reduce((a,r) => a + parseFloat(r.duration), 0);
        const timerCount = filteredTimerRecords.length;
        const timerAvg = timerCount > 0 ? (timerTotal / timerCount) : 0;

        document.getElementById('statTimerTotal').innerText = timerTotal.toFixed(1) + 'h';
        document.getElementById('statTimerToday').innerText = timerToday.toFixed(1) + 'h';
        document.getElementById('statTimerCount').innerText = timerCount;
        document.getElementById('statTimerAvg').innerText = timerAvg.toFixed(1) + 'h';

        // çƒ­é—¨ä»»åŠ¡ç»Ÿè®¡
        const taskMap = {};
        filteredTimerRecords.forEach(r => {
            taskMap[r.name] = (taskMap[r.name] || 0) + parseFloat(r.duration);
        });
        const topTasks = Object.entries(taskMap)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 3);
        
        const topTasksHtml = topTasks.length > 0 
            ? '<div style="margin-top:10px; font-weight:bold; margin-bottom:5px;">ğŸ”¥ çƒ­é—¨ä»»åŠ¡:</div>' + 
              topTasks.map(([name, dur], i) => `
                <div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px solid var(--border);">
                    <span>${i+1}. ${name}</span>
                    <span style="color:var(--primary); font-weight:bold;">${dur.toFixed(1)}h</span>
                </div>
              `).join('')
            : '<div style="text-align:center; color:var(--text-sub); margin-top:10px;">è¯¥å‘¨æœŸå†…æš‚æ— è®¡æ—¶æ•°æ®</div>';
        
        document.getElementById('statTimerTopTasks').innerHTML = topTasksHtml;
    }

    function exportCSV(){
        let c="æ—¥æœŸ,ç±»å‹,åŸºé‡‘,è¯¦æƒ…\n";
        historyData.forEach(i=>c+=`${i.date},${i.title},${i.fund},"${Object.values(i.details||{}).join('|')}"\n`);
        const l=document.createElement("a");
        l.href=URL.createObjectURL(new Blob([c],{type:'text/csv'}));
        l.download="data.csv";
        l.click();
    }

    function exportJSON() {
        const backup = { history: historyData, config: config, todos: todoList, wishes: wishList, strategies: userStrategies, gh: ghConfig, timeBank: timeBank, dailyReviews: dailyReviews, taskUsageCount: taskUsageCount };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "habit_backup_" + getTimestampStr() + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importJSON(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { const data = JSON.parse(e.target.result); restoreData(data); }
            catch(err) { alert("âŒ æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•æ¢å¤"); }
        };
        reader.readAsText(file);
    }

    function restoreData(data) {
        if(confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
            const historyToRestore = data.history || data.data;
            if(historyToRestore) localStorage.setItem('habit_data_v15', JSON.stringify(historyToRestore));

            if(data.config) localStorage.setItem('habit_config_v7', JSON.stringify(data.config));
            if(data.todos) localStorage.setItem('habit_todos_v1', JSON.stringify(data.todos));
            if(data.wishes) localStorage.setItem('habit_wishes_v1', JSON.stringify(data.wishes));
            if(data.strategies) localStorage.setItem('habit_strategies_v1', JSON.stringify(data.strategies));
            if(data.gh) localStorage.setItem('habit_gh_v1', JSON.stringify(data.gh));
            if(data.timeBank !== undefined) localStorage.setItem('habit_time_bank_v1', data.timeBank);
            if(data.dailyReviews) localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(data.dailyReviews));
            if(data.taskUsageCount) localStorage.setItem('habit_task_usage_v1', JSON.stringify(data.taskUsageCount));
            alert("âœ… æ•°æ®æ¢å¤æˆåŠŸï¼é¡µé¢å³å°†åˆ·æ–°..."); location.reload();
        }
    }

    function triggerAutoSave() {
        localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
        localStorage.setItem('habit_todos_v1', JSON.stringify(todoList));
        localStorage.setItem('habit_wishes_v1', JSON.stringify(wishList));
        localStorage.setItem('habit_strategies_v1', JSON.stringify(userStrategies));
        localStorage.setItem('habit_time_bank_v1', timeBank);
        localStorage.setItem('habit_timer_records_v1', JSON.stringify(timerRecords));
        localStorage.setItem('habit_planned_tasks_v1', JSON.stringify(plannedTasks));
        localStorage.setItem('habit_daily_reviews_v1', JSON.stringify(dailyReviews));
        // è®¡æ—¶å™¨çŠ¶æ€å·²ç»ç”±saveTimerState()å•ç‹¬ä¿å­˜
        syncGitHub('push', true);
    }

    function saveSettings(){
        ghConfig.token = document.getElementById('ghToken').value.trim();
        ghConfig.repo = document.getElementById('ghRepo').value.trim();
        localStorage.setItem('habit_gh_v1', JSON.stringify(ghConfig));

        config = {
            wake: document.getElementById('setWake').value,
            sleep: document.getElementById('setSleep').value,
            study: parseFloat(document.getElementById('setStudy').value),
            expiredLimit: parseInt(document.getElementById('setExpiredLimit').value) || 5,
            timerLimit: parseInt(document.getElementById('setTimerLimit').value) || 5,
            historyLimit: parseInt(document.getElementById('setHistoryLimit').value) || 5,
            quickTasks: config.quickTasks || [],
            wakeW: document.getElementById('setWakeW').value,
            sleepW: document.getElementById('setSleepW').value,
            initialPage: document.getElementById('setInitialPage').value,
            reward: parseFloat(document.getElementById('rewardAmount').value) || 0,
            preventCost: parseFloat(document.getElementById('preventCost').value) || 0,
            exchangeRate: parseFloat(document.getElementById('exchangeRate').value) || 5,
            penalties: {
                wakeS: parseFloat(document.getElementById('pWakeS').value) || 0,
                wakeL: parseFloat(document.getElementById('pWakeL').value) || 0,
                sleepS: parseFloat(document.getElementById('pSleepS').value) || 0,
                sleepL: parseFloat(document.getElementById('pSleepL').value) || 0,
                studyS: parseFloat(document.getElementById('pStudyS').value) || 0,
                studyL: parseFloat(document.getElementById('pStudyL').value) || 0
            },
            weekend: config.weekend || [0, 6],
            todoTimeChips: config.todoTimeChips || [],
            interface: config.interface || DEFAULT_CONFIG.interface
        };
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        triggerAutoSave();
        alert("é…ç½®å·²ä¿å­˜");
    }

    function applySettingsToUI(){
        document.getElementById('setWake').value = config.wake;
        document.getElementById('setSleep').value = config.sleep;
        document.getElementById('setStudy').value = config.study;
        document.getElementById('setExpiredLimit').value = config.expiredLimit || 5;
        document.getElementById('setTimerLimit').value = config.timerLimit || 5;
        document.getElementById('setHistoryLimit').value = config.historyLimit || 5;
        document.getElementById('setWakeW').value = config.wakeW;
        document.getElementById('setSleepW').value = config.sleepW;
        document.getElementById('setInitialPage').value = config.initialPage || 'checkin';
        document.getElementById('rewardAmount').value = config.reward;
        document.getElementById('preventCost').value = config.preventCost || 10;
        document.getElementById('exchangeRate').value = config.exchangeRate || 5;

        if(config.penalties) {
            document.getElementById('pWakeS').value = config.penalties.wakeS;
            document.getElementById('pWakeL').value = config.penalties.wakeL;
            document.getElementById('pSleepS').value = config.penalties.sleepS;
            document.getElementById('pSleepL').value = config.penalties.sleepL;
            document.getElementById('pStudyS').value = config.penalties.studyS;
            document.getElementById('pStudyL').value = config.penalties.studyL;
        }

        const we = config.weekend || [0, 6];
        document.getElementById('btn_week_6').className = `week-btn ${we.includes(6)?'active':''}`;
        document.getElementById('btn_week_0').className = `week-btn ${we.includes(0)?'active':''}`;

        renderQuickTaskSettings();
        renderTodoTimeChipSettings();
        applyInterfaceSettings();

        // å¡«å……æ‰‹åŠ¨è°ƒèŠ‚æ•°å€¼
        document.getElementById('adjTimeBank').value = Number(timeBank).toFixed(1);
        document.getElementById('adjWallet').value = globalWallet;
        document.getElementById('adjDebt').value = globalDebt;
    }
    
    // æ¸²æŸ“å¾…åŠæ—¶é—´å¿«é€‰è®¾ç½®
    function renderTodoTimeChipSettings() {
        const list = document.getElementById('todoTimeChipsSettingsList');
        if (!list) return;
        
        const chips = config.todoTimeChips || [];
        if (chips.length === 0) {
            list.innerHTML = '';
            return;
        }
        
        list.innerHTML = chips.map((chip, idx) => {
            const label = chip.type === 'offset' ? `${chip.label} (+${chip.hours}h)` : chip.label;
            return `<div class="chip chip-removable" onclick="removeTodoTimeChip(${idx})">${label}</div>`;
        }).join('');
    }
    
    // æ·»åŠ å¾…åŠæ—¶é—´å¿«é€‰
    function addTodoTimeChip(type) {
        if (!config.todoTimeChips) config.todoTimeChips = [];
        
        if (type === 'offset') {
            showModal({
                title: 'æ·»åŠ åç§»æ—¶é—´',
                message: 'è®¾ç½®ç›¸å¯¹äºå½“å‰æ—¶é—´çš„åç§»å¿«é€‰',
                inputs: [
                    { id: 'chipLabel', label: 'æ ‡ç­¾åç§°', placeholder: 'ä¾‹å¦‚ï¼š1å°æ—¶å', type: 'text' },
                    { id: 'chipHours', label: 'å°æ—¶åç§»é‡', placeholder: 'ä¾‹å¦‚ï¼š1', type: 'number', value: '1' }
                ],
                buttons: [
                    { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                    { 
                        text: 'ç¡®å®š', 
                        primary: true, 
                        callback: (values) => {
                            const label = values.chipLabel ? values.chipLabel.trim() : '';
                            const hoursStr = values.chipHours ? values.chipHours.trim() : '';
                            
                            if (!label) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'è¯·å¡«å†™æ ‡ç­¾åç§°',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            const hours = parseFloat(hoursStr);
                            if (isNaN(hours) || hours <= 0) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'å°æ—¶åç§»é‡æ— æ•ˆï¼Œè¯·è¾“å…¥å¤§äº0çš„æ•°å­—',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            config.todoTimeChips.push({ type: 'offset', label: label, hours: hours });
                            localStorage.setItem('habit_config_v7', JSON.stringify(config));
                            renderTodoTimeChipSettings();
                            renderTodoTimeChips();
                            renderTimerTimeChips();
                            triggerAutoSave();
                        }
                    }
                ]
            });
        } else if (type === 'fixed') {
            showModal({
                title: 'æ·»åŠ å›ºå®šæ—¶é—´',
                message: 'è®¾ç½®å›ºå®šæ—¶é—´çš„å¿«é€‰',
                inputs: [
                    { id: 'chipLabel', label: 'æ ‡ç­¾åç§°', placeholder: 'ä¾‹å¦‚ï¼šä»Šæ™š23:59', type: 'text' },
                    { id: 'chipTime', label: 'å›ºå®šæ—¶é—´', placeholder: 'HH:MMï¼Œä¾‹å¦‚ï¼š23:59', type: 'text', value: '23:59' }
                ],
                buttons: [
                    { text: 'å–æ¶ˆ', primary: false, callback: () => {} },
                    { 
                        text: 'ç¡®å®š', 
                        primary: true, 
                        callback: (values) => {
                            const label = values.chipLabel ? values.chipLabel.trim() : '';
                            const time = values.chipTime ? values.chipTime.trim() : '';
                            
                            if (!label) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'è¯·å¡«å†™æ ‡ç­¾åç§°',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            if (!time || !/^\d{1,2}:\d{2}$/.test(time)) {
                                showModal({
                                    title: 'æç¤º',
                                    message: 'æ—¶é—´æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º HH:MMï¼ˆå¦‚ 23:59ï¼‰',
                                    buttons: [{ text: 'ç¡®å®š', primary: true, callback: () => {} }]
                                });
                                return;
                            }
                            
                            config.todoTimeChips.push({ type: 'fixed', label: label, time: time });
                            localStorage.setItem('habit_config_v7', JSON.stringify(config));
                            renderTodoTimeChipSettings();
                            renderTodoTimeChips();
                            renderTimerTimeChips();
                            triggerAutoSave();
                        }
                    }
                ]
            });
        }
    }
    
    // åˆ é™¤å¾…åŠæ—¶é—´å¿«é€‰
    function removeTodoTimeChip(idx) {
        if (!config.todoTimeChips) return;
        config.todoTimeChips.splice(idx, 1);
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderTodoTimeChipSettings();
        renderTodoTimeChips(); // åŒæ­¥æ›´æ–°å¾…åŠé¡µé¢
        renderTimerTimeChips(); // åŒæ­¥æ›´æ–°è®¡æ—¶é¡µé¢
        triggerAutoSave();
    }
    
    // é‡ç½®å¾…åŠæ—¶é—´å¿«é€‰ä¸ºé»˜è®¤
    function resetTodoTimeChips() {
        if (!confirm('ç¡®å®šè¦æ¢å¤ä¸ºé»˜è®¤çš„æ—¶é—´å¿«é€‰å—ï¼Ÿ')) return;
        config.todoTimeChips = [];
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderTodoTimeChipSettings();
        renderTodoTimeChips(); // åŒæ­¥æ›´æ–°å¾…åŠé¡µé¢
        renderTimerTimeChips(); // åŒæ­¥æ›´æ–°è®¡æ—¶é¡µé¢
        triggerAutoSave();
    }
    
    // ä¿å­˜ç•Œé¢æ˜¾ç¤ºè®¾ç½®
    // æ›´æ–°å•ä¸ªç•Œé¢é€‰é¡¹
    function updateInterfaceOption(id) {
        const checkbox = document.getElementById(id);
        if (!checkbox) return;
        
        const isChecked = checkbox.checked;
        
        // æ›´æ–°å¯¹åº”çš„labelæ ·å¼
        if (id === 'showTimer') {
            const label = document.getElementById('label-showTimer');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showStats') {
            const label = document.getElementById('label-showStats');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showShop') {
            const label = document.getElementById('label-showShop');
            if (label) label.classList.toggle('checked', isChecked);
        } else if (id === 'showQuickStudy') {
            const label = document.getElementById('label-showQuickStudy');
            if (label) label.classList.toggle('checked', isChecked);
        }
        
        // ä¿å­˜è®¾ç½®
        saveInterfaceSettings();
        // æ›´æ–°é€šçŸ¥æ æ˜¾ç¤º
        updateStickyNotif();
    }
    
    function saveInterfaceSettings() {
        const showTimer = document.getElementById('showTimer');
        const showStats = document.getElementById('showStats');
        const showShop = document.getElementById('showShop');
        
        if (!showTimer || !showStats || !showShop) return;
        
        const showQuickStudy = document.getElementById('showQuickStudy');
        config.interface = {
            showTimer: showTimer.checked,
            showStats: showStats.checked,
            showShop: showShop.checked,
            showQuickStudy: showQuickStudy ? showQuickStudy.checked : true
        };
        
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        applyInterfaceSettings();
        triggerAutoSave();
    }
    
    // åº”ç”¨ç•Œé¢æ˜¾ç¤ºè®¾ç½®
    function applyInterfaceSettings() {
        const interfaceConfig = config.interface || { showTimer: true, showStats: true, showShop: true, showQuickStudy: true };
        
        // è®¾ç½®å¤é€‰æ¡†çŠ¶æ€å’Œæ ·å¼
        const showTimerCheckbox = document.getElementById('showTimer');
        const showStatsCheckbox = document.getElementById('showStats');
        const showShopCheckbox = document.getElementById('showShop');
        const showQuickStudyCheckbox = document.getElementById('showQuickStudy');
        
        const labelTimer = document.getElementById('label-showTimer');
        const labelStats = document.getElementById('label-showStats');
        const labelShop = document.getElementById('label-showShop');
        const labelQuickStudy = document.getElementById('label-showQuickStudy');
        
        if (showTimerCheckbox) {
            showTimerCheckbox.checked = interfaceConfig.showTimer !== false;
            if (labelTimer) {
                labelTimer.classList.toggle('checked', interfaceConfig.showTimer !== false);
            }
        }
        if (showStatsCheckbox) {
            showStatsCheckbox.checked = interfaceConfig.showStats !== false;
            if (labelStats) {
                labelStats.classList.toggle('checked', interfaceConfig.showStats !== false);
            }
        }
        if (showShopCheckbox) {
            showShopCheckbox.checked = interfaceConfig.showShop !== false;
            if (labelShop) {
                labelShop.classList.toggle('checked', interfaceConfig.showShop !== false);
            }
        }
        if (showQuickStudyCheckbox) {
            showQuickStudyCheckbox.checked = interfaceConfig.showQuickStudy !== false;
            if (labelQuickStudy) {
                labelQuickStudy.classList.toggle('checked', interfaceConfig.showQuickStudy !== false);
            }
        }
        
        // æ˜¾ç¤º/éšè—å¯¹åº”çš„é€‰é¡¹å¡
        const tabs = document.querySelectorAll('.tab');
        const tabOrder = ['checkin', 'timer', 'stats', 'shop', 'settings'];
        
        tabs.forEach((tab, index) => {
            const tabId = tabOrder[index];
            if (tabId === 'timer' && interfaceConfig.showTimer === false) {
                tab.style.display = 'none';
            } else if (tabId === 'stats' && interfaceConfig.showStats === false) {
                tab.style.display = 'none';
            } else if (tabId === 'shop' && interfaceConfig.showShop === false) {
                tab.style.display = 'none';
            } else {
                tab.style.display = '';
            }
        });
    }

    function renderQuickTasks() {
        const container = document.getElementById('quickTasksContainer');
        if (!container) return;
        
        // è·å–é¢„è®¾å¿«æ·ä»»åŠ¡
        let tasks = config.quickTasks || [];
        
        // è·å–ä»Šæ—¥å¾…åŠäº‹é¡¹ï¼ˆä»…"å»åš"ç±»å‹ï¼Œæœªå®Œæˆçš„ï¼‰
        const todayStr = getLocalTodayStr();
        const todayTodos = todoList.filter(t => 
            t.type === 'do' && 
            t.status === 'pending' && 
            t.date === todayStr &&
            !t.archived
        );
        
        // åˆå¹¶ä»»åŠ¡åˆ—è¡¨ï¼ˆä¸å†åŒ…å«å¾…åŠï¼Œå¾…åŠé€šè¿‡å›ºå®šæŒ‰é’®é€‰æ‹©ï¼‰
        const allTasks = tasks.map(t => ({ name: t, isTodo: false }));
        
        // ä¸ºéå¾…åŠä»»åŠ¡æ·»åŠ ä½¿ç”¨é¢‘æ¬¡å¹¶æ’åº
        allTasks.forEach(task => {
            if (!task.isTodo) {
                task.count = taskUsageCount[task.name] || 0;
            }
        });
        
        allTasks.sort((a, b) => b.count - a.count);
        
        container.style.display = 'flex';
        container.style.flexWrap = 'wrap';
        container.style.gap = '8px';
        
        // é¦–å…ˆæ·»åŠ å›ºå®šçš„"å¾…åŠ"æŒ‰é’®
        let html = `<div class="chip" style="background:var(--success-bg);border-color:var(--success);color:var(--success);font-weight:700;cursor:pointer;" onclick="showTodoSelectModal()">ğŸ“‹ å¾…åŠ</div>`;
        
        // ç„¶åæ·»åŠ å…¶ä»–å¿«æ·ä»»åŠ¡
        if (allTasks.length > 0) {
            html += allTasks.map(task => {
                return `<div class="chip" onclick="quickSelectTask('${task.name.replace(/'/g, "\\'")}')">${task.name}</div>`;
            }).join('');
        } else {
            html += '<div style="text-align:center;color:var(--text-sub);font-size:11px;padding:8px;width:100%;">æš‚æ— å¿«é€‰é¡¹ï¼Œå»è®¾ç½®ä¸­æ·»åŠ å§</div>';
        }
        
        container.innerHTML = html;
    }
    
    function showTodoSelectModal() {
        const modal = document.getElementById('todoSelectModal');
        const list = document.getElementById('todoSelectList');
        if (!modal || !list) return;
        
        const todayStr = getLocalTodayStr();
        const now = new Date();
        const currentHm = now.toTimeString().slice(0, 5);
        
        // è·å–æ‰€æœ‰æœªå®Œæˆçš„å¾…åŠï¼ˆåŒ…æ‹¬ä»Šæ—¥å’Œæœªæ¥çš„ï¼‰
        const availableTodos = todoList.filter(t => {
            if (t.archived) return false;
            if (t.status !== 'pending') return false;
            if (t.date < todayStr) return false;
            if (t.date === todayStr && t.time && currentHm > t.time) return false;
            return true;
        });
        
        if (availableTodos.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">æš‚æ— å¯ç”¨å¾…åŠäº‹é¡¹</div>';
        } else {
            // æŒ‰æ—¥æœŸå’Œæ—¶é—´æ’åº
            availableTodos.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || '99:99').localeCompare(b.time || '99:99');
            });
            
            list.innerHTML = availableTodos.map(t => {
                const dateBadge = t.date > todayStr ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.date.slice(5)}</span>` : '';
                const timeBadge = t.time ? `<span style="font-size:10px;color:var(--text-sub);background:var(--border);padding:2px 6px;border-radius:4px;margin-left:6px;">${t.time}</span>` : '';
                const importance = t.importance || 1;
                const importanceColors = { 3: 'var(--danger)', 2: 'var(--warning)', 1: 'var(--success)' };
                const importanceDot = `<span style="width:10px; height:10px; border-radius:50%; background:${importanceColors[importance]}; display:inline-block; margin-right:4px;"></span>`;
                
                return `
                    <div class="list-item" style="cursor:pointer; margin-bottom:8px;" onclick="selectTodoFromModal('${String(t.id)}')">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:var(--text-main); display:flex; align-items:center;">
                                ${importanceDot}${t.title} ${timeBadge} ${dateBadge}
                            </div>
                            ${t.note ? `<div style="font-size:11px;color:var(--text-sub);margin-top:4px;">${t.note}</div>` : ''}
                            <div style="font-size:11px;color:var(--text-sub);margin-top:4px;">å¥–${t.reward || 0} / ç½š${t.penalty || 0}</div>
                        </div>
                        <div style="color:var(--success); font-size:20px;">âœ“</div>
                    </div>
                `;
            }).join('');
        }
        
        modal.style.display = 'flex';
    }
    
    function closeTodoSelectModal() {
        const modal = document.getElementById('todoSelectModal');
        if (modal) modal.style.display = 'none';
    }
    
    function selectTodoFromModal(todoId) {
        // ç¡®ä¿todoIdæ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—éƒ½èƒ½å¤„ç†
        const id = typeof todoId === 'string' ? todoId : String(todoId);
        selectTodoForTimer(id);
        closeTodoSelectModal();
    }

    function renderQuickTaskSettings() {
        const list = document.getElementById('setQuickTasksList');
        if (!list) return;
        
        // åˆ›å»ºä»»åŠ¡æ•°ç»„å¹¶é™„åŠ ä½¿ç”¨é¢‘æ¬¡ä¿¡æ¯
        let tasks = (config.quickTasks || []).map((t, idx) => ({
            name: t,
            index: idx,
            count: taskUsageCount[t] || 0
        }));
        
        // æŒ‰ä½¿ç”¨é¢‘æ¬¡æ’åº
        tasks.sort((a, b) => b.count - a.count);
        
        list.innerHTML = tasks.map(t => {
            return `<div class="chip chip-removable" onclick="removeQuickTask(${t.index})">${t.name}</div>`;
        }).join('');
    }

    function addQuickTask() {
        const input = document.getElementById('input_quicktask');
        const val = input.value.trim();
        if(!val) return;
        if(!config.quickTasks) config.quickTasks = [];
        config.quickTasks.push(val);
        input.value = '';
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        renderTodoTaskChips(); // åŒæ­¥æ›´æ–°å¾…åŠçš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
    }

    function removeQuickTask(idx) {
        if(!confirm(`åˆ é™¤æ­¤å¿«æ·é¡¹?`)) return;
        const removedTask = config.quickTasks[idx];
        config.quickTasks.splice(idx, 1);
        
        // åŒæ—¶åˆ é™¤è¯¥ä»»åŠ¡çš„ä½¿ç”¨é¢‘æ¬¡è®°å½•
        if (taskUsageCount[removedTask]) {
            delete taskUsageCount[removedTask];
            localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        }
        
        localStorage.setItem('habit_config_v7', JSON.stringify(config));
        renderQuickTaskSettings();
        renderQuickTasks();
        renderTodoTaskChips(); // åŒæ­¥æ›´æ–°å¾…åŠçš„å¿«é€‰èƒ¶å›Š
        triggerAutoSave();
    }

    function resetTaskUsage() {
        if(!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ä»»åŠ¡çš„ä½¿ç”¨é¢‘æ¬¡ç»Ÿè®¡å—ï¼Ÿ')) return;
        taskUsageCount = {};
        localStorage.setItem('habit_task_usage_v1', JSON.stringify(taskUsageCount));
        renderQuickTasks();
        renderQuickTaskSettings();
        alert('âœ… ä½¿ç”¨é¢‘æ¬¡å·²é‡ç½®');
        triggerAutoSave();
    }

    function applyManualAdjustment() {
        const newTimeBank = parseFloat(document.getElementById('adjTimeBank').value);
        const newWallet = parseFloat(document.getElementById('adjWallet').value);
        const newDebt = parseFloat(document.getElementById('adjDebt').value);
        const reason = document.getElementById('adjReason').value.trim();

        if (newTimeBank === undefined || newTimeBank === null || newWallet === undefined || newWallet === null || newDebt === undefined || newDebt === null) return alert("è¯·è¾“å…¥æœ‰æ•ˆæ•°å€¼");
        if (!reason) return alert("è¯·è¾“å…¥ä¿®æ”¹åŸå› ");

        const today = getLocalTodayStr();
        let changed = false;

        // 1. è°ƒæ•´æ—¶é—´é“¶è¡Œ
        const diffTB = newTimeBank - timeBank;
        if (Math.abs(diffTB) > 0.01) {
            timeBank = newTimeBank;
            localStorage.setItem('habit_time_bank_v1', timeBank);
            // è®°å½•æ—¶é—´é“¶è¡Œå˜åŠ¨
            historyData.unshift({
                id: Date.now() + 1,
                date: today,
                title: "â³ æ—¶é—´é“¶è¡Œæ‰‹åŠ¨è°ƒèŠ‚",
                fund: 0,
                theme: "theme-skip",
                details: { manual_edit_reason: reason, note: (diffTB > 0 ? "+" : "") + diffTB.toFixed(1) + "h" }
            });
            changed = true;
        }

        // 2. è°ƒæ•´æ„¿æœ›é‡‘ (Wallet)
        const diffW = newWallet - globalWallet;
        if (Math.abs(diffW) > 0.01) {
            historyData.unshift({
                id: Date.now() + 2,
                date: today,
                title: "ğŸ’° æ„¿æœ›é‡‘æ‰‹åŠ¨è°ƒèŠ‚",
                fund: diffW,
                theme: diffW > 0 ? "theme-success" : "theme-shop",
                details: { manual_edit_reason: reason }
            });
            changed = true;
        }

        // 3. è°ƒæ•´å¾…ç½šé‡‘ (Debt)
        const diffD = newDebt - globalDebt;
        if (Math.abs(diffD) > 0.01) {
            historyData.unshift({
                id: Date.now() + 3,
                date: today,
                title: "ğŸ’¸ å¾…ç½šé‡‘æ‰‹åŠ¨è°ƒèŠ‚",
                fund: diffD,
                theme: diffD > 0 ? "theme-repair" : "theme-pay",
                details: { manual_edit_reason: reason, note: diffD > 0 ? "æ‰‹åŠ¨å¢åŠ " : "æ‰‹åŠ¨å‡å°‘" }
            });
            changed = true;
        }

        if (changed) {
            localStorage.setItem('habit_data_v15', JSON.stringify(historyData));
            updateUI();
            triggerAutoSave();
            alert("æ•°æ®å·²æˆåŠŸä¿®æ­£ï¼Œè°ƒæ•´å·²è®°å½•è‡³å†å²æ¡£æ¡ˆã€‚");
            document.getElementById('adjReason').value = '';
        } else {
            alert("æ•°å€¼æœªå‘ç”Ÿå˜åŒ–ï¼Œæ— éœ€è°ƒæ•´ã€‚");
        }
    }

    async function syncGitHub(action, isAuto) {
        const token = ghConfig.token;
        const repo = ghConfig.repo;
        const path = ghConfig.path || 'habit_backup.json';
        if(!token || !repo) {
            if(!isAuto) alert("è¯·å…ˆé…ç½® GitHub");
            return;
        }

        setSyncBadgeStatus('status-syncing', action==='push'?'ä¸Šä¼ ...':'åŒæ­¥...');

        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };

            const getRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });

            let sha = null, cloudData = null;

            if(getRes.ok) {
                const d = await getRes.json();
                sha = d.sha || null;
                cloudData = JSON.parse(decodeURIComponent(escape(atob((d.content || '').replace(/\n/g,"")))));
            }

            if(action === 'pull') {
                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;

                let shouldApply = false;
                if (cloudData && cloudTs > localTs) {
                    shouldApply = true;
                } else if (cloudData && !isAuto) {
                    shouldApply = confirm(`äº‘ç«¯æ•°æ®æ—¶é—´æˆ³(${cloudTs})å¹¶ä¸æ¯”æœ¬åœ°æ–°(${localTs})ã€‚\nä»è¦ç”¨äº‘ç«¯è¦†ç›–æœ¬åœ°å—ï¼Ÿ`);
                }

                if(shouldApply) {
                    if(cloudData.data) historyData = stripImagesFromHistory(cloudData.data);
                    if(cloudData.config) config = cloudData.config;
                    if(cloudData.todos) todoList = cloudData.todos;
                    if(cloudData.strategies) userStrategies = cloudData.strategies;
                    if(cloudData.wishes) wishList = cloudData.wishes;
                    if(cloudData.timerRecords) timerRecords = cloudData.timerRecords;
                    if(cloudData.plannedTasks) plannedTasks = cloudData.plannedTasks;
                    if(cloudData.dailyReviews) dailyReviews = cloudData.dailyReviews;
                    if(cloudData.taskUsageCount) taskUsageCount = cloudData.taskUsageCount;
                    if(cloudData.pinnedTaskId) {
                        pinnedTaskId = cloudData.pinnedTaskId;
                        localStorage.setItem('habit_pinned_task_id', pinnedTaskId);
                    }
                    
                    // åŒæ­¥è®¡æ—¶å™¨çŠ¶æ€
                    const hadLocalTimer = localStorage.getItem('habit_timer_state_v1') !== null;
                    const hasCloudTimer = cloudData.timerState && cloudData.timerState.running;
                    
                    if(hasCloudTimer) {
                        // å¦‚æœäº‘ç«¯æœ‰æ­£åœ¨è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œä¿å­˜åˆ°æœ¬åœ°
                        localStorage.setItem('habit_timer_state_v1', JSON.stringify(cloudData.timerState));
                        console.log('ğŸ“¥ ä»äº‘ç«¯åŒæ­¥åˆ°è®¡æ—¶å™¨çŠ¶æ€:', cloudData.timerState.taskName);
                    } else {
                        // å¦‚æœäº‘ç«¯æ²¡æœ‰è¿è¡Œçš„è®¡æ—¶å™¨ï¼Œæ¸…é™¤æœ¬åœ°çš„
                        if (hadLocalTimer && timerRunning) {
                            console.log('â¹ï¸ æ£€æµ‹åˆ°è®¡æ—¶å™¨åœ¨å…¶ä»–è®¾å¤‡å·²ç»“æŸï¼ŒåŒæ­¥åœæ­¢æœ¬åœ°è®¡æ—¶å™¨');
                        }
                        localStorage.removeItem('habit_timer_state_v1');
                    }

                    if(cloudData.timeBank !== undefined) timeBank = cloudData.timeBank;

                    persistAllLocal();
                    localStorage.setItem('habit_last_save', String(cloudTs || Date.now()));

                    setSyncBadgeStatus('status-idle', 'å·²æ›´æ–°');
                    updateUI(); renderTodos(); checkDateChange(); applySettingsToUI(); renderStrategySettings();
                    if (typeof renderTimerHistory === 'function') renderTimerHistory();
                    if (typeof renderPlannedTasks === 'function') renderPlannedTasks();
                    
                    // æ¢å¤è®¡æ—¶å™¨çŠ¶æ€ï¼ˆä¼šè‡ªåŠ¨å¤„ç†æœ‰/æ— è®¡æ—¶å™¨çš„æƒ…å†µï¼‰
                    restoreTimerState();
                    updateStickyNotif();

                    if(!isAuto) alert("âœ… åŒæ­¥æˆåŠŸï¼šå·²ä»äº‘ç«¯åŒæ­¥æ‰€æœ‰æ•°æ®");
                } else {
                    setSyncBadgeStatus('status-idle', 'å·²æœ€æ–°');
                    if(!isAuto) alert("âœ… åŒæ­¥å®Œæˆï¼šæœ¬åœ°æ•°æ®å·²æ˜¯æœ€æ–°");
                }
            } else {
                // Push æ“ä½œï¼šå…ˆæ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°ï¼Œé¿å…è¦†ç›–å…¶ä»–è®¾å¤‡çš„æ›´æ”¹
                const localTs = parseInt(localStorage.getItem('habit_last_save') || '0');
                const cloudTs = cloudData ? (cloudData.timestamp || 0) : 0;
                
                // å¦‚æœäº‘ç«¯æ•°æ®æ›´æ–°ï¼Œå…ˆåˆå¹¶å†æ¨é€
                if (cloudData && cloudTs > localTs) {
                    console.log('âš ï¸ æ£€æµ‹åˆ°äº‘ç«¯æœ‰æ›´æ–°ï¼Œå…ˆåˆå¹¶æ•°æ®å†æ¨é€');
                    // åˆå¹¶æ•°æ®ï¼šä¿ç•™æœ¬åœ°å’Œäº‘ç«¯çš„æ–°å¢/ä¿®æ”¹
                    mergeData(cloudData, {
                        data: historyData || [],
                        todos: todoList || [],
                        wishes: wishList || [],
                        strategies: userStrategies || {},
                        timerRecords: timerRecords || [],
                        plannedTasks: plannedTasks || [],
                        dailyReviews: dailyReviews || {},
                        taskUsageCount: taskUsageCount || {}
                    });
                }
                
                // è·å–å½“å‰è®¡æ—¶å™¨çŠ¶æ€
                const timerStateStr = localStorage.getItem('habit_timer_state_v1');
                const timerState = timerStateStr ? JSON.parse(timerStateStr) : null;
                
                if (timerState && timerState.running) {
                    console.log('ğŸ“¤ æ­£åœ¨ä¸Šä¼ è®¡æ—¶å™¨çŠ¶æ€åˆ°äº‘ç«¯:', timerState.taskName, 'å·²è®¡æ—¶', Math.floor(timerState.seconds / 60), 'åˆ†é’Ÿ');
                }
                
                const content = {
                    timestamp: Date.now(),
                    data: stripImagesFromHistory(historyData),
                    config,
                    todos: todoList,
                    wishes: wishList,
                    strategies: userStrategies,
                    timeBank: timeBank,
                    timerRecords: timerRecords,
                    plannedTasks: plannedTasks,
                    dailyReviews: dailyReviews,
                    taskUsageCount: taskUsageCount,
                    pinnedTaskId: pinnedTaskId,
                    timerState: timerState // åŒ…å«è®¡æ—¶å™¨çŠ¶æ€
                };

                const body = {
                    message: "Sync",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(content))))
                };
                if (sha) body.sha = sha;

                try {
                    const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) });
                    
                    // å¤„ç†409å†²çªï¼ˆæ–‡ä»¶å·²è¢«å…¶ä»–è®¾å¤‡ä¿®æ”¹ï¼‰
                    if (putRes.status === 409) {
                        console.log('âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œé‡æ–°æ‹‰å–å¹¶åˆå¹¶åé‡è¯•');
                        // é‡æ–°è·å–æœ€æ–°æ•°æ®
                        const retryGetRes = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
                        if (retryGetRes.ok) {
                            const retryData = await retryGetRes.json();
                            const retryCloudData = JSON.parse(decodeURIComponent(escape(atob((retryData.content || '').replace(/\n/g,"")))));
                            const retrySha = retryData.sha;
                            
                            // åˆå¹¶æ•°æ®
                            mergeData(retryCloudData, {
                                data: historyData || [],
                                todos: todoList || [],
                                wishes: wishList || [],
                                strategies: userStrategies || {},
                                timerRecords: timerRecords || [],
                                plannedTasks: plannedTasks || [],
                                dailyReviews: dailyReviews || {},
                                taskUsageCount: taskUsageCount || {}
                            });
                            
                            // ä½¿ç”¨åˆå¹¶åçš„æ•°æ®é‡æ–°æ¨é€
                            content.data = stripImagesFromHistory(historyData);
                            content.todos = todoList;
                            content.wishes = wishList;
                            content.strategies = userStrategies;
                            content.timerRecords = timerRecords;
                            content.plannedTasks = plannedTasks;
                            content.dailyReviews = dailyReviews;
                            content.taskUsageCount = taskUsageCount;
                            content.timestamp = Date.now();
                            
                            body.content = btoa(unescape(encodeURIComponent(JSON.stringify(content))));
                            body.sha = retrySha;
                            
                            await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers, body: JSON.stringify(body) });
                        }
                    } else if (!putRes.ok) {
                        throw new Error(`Push failed with status ${putRes.status}`);
                    }
                } catch (fetchError) {
                    if (fetchError.message && fetchError.message.includes('409')) {
                        // å¦‚æœè¿˜æ˜¯409ï¼Œè¯´æ˜åœ¨é‡è¯•æœŸé—´åˆæœ‰æ›´æ–°ï¼Œæç¤ºç”¨æˆ·æ‰‹åŠ¨åŒæ­¥
                        setSyncBadgeStatus('status-error', 'å†²çª');
                        if(!isAuto) alert("âš ï¸ åŒæ­¥å†²çªï¼šå…¶ä»–è®¾å¤‡æ­£åœ¨åŒæ­¥ï¼Œè¯·ç¨åé‡è¯•");
                        return;
                    }
                    throw fetchError;
                }

                setSyncBadgeStatus('status-idle', 'å·²åŒæ­¥');
                localStorage.setItem('habit_last_save', String(content.timestamp));
                persistAllLocal(); // ç¡®ä¿æœ¬åœ°æ•°æ®å·²ä¿å­˜
                if(!isAuto) alert("âœ… åŒæ­¥æˆåŠŸï¼šæ•°æ®å·²ä¸Šä¼ è‡³äº‘ç«¯");
            }
        } catch(e) {
            console.error(e);
            setSyncBadgeStatus('status-error', 'å¤±è´¥');
            if(!isAuto) alert("âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–Token");
        }

        setTimeout(()=>setSyncBadgeStatus('status-idle', document.getElementById('syncText').innerText || 'æœ¬åœ°æ¨¡å¼'), 2000);
    }

    async function archiveToGitHub() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("è¯·å…ˆé…ç½® GitHub Token");
        if(!confirm("ç¡®å®šè¦åˆ›å»ºä¸€ä¸ªæ°¸ä¹…å­˜æ¡£å—ï¼Ÿ")) return;

        setSyncBadgeStatus('status-syncing', 'ä¸Šä¼ ...');

        const timestamp = getTimestampStr();
        const path = `backups/habit_archive_${timestamp}.json`;

        try {
            const content = {
                timestamp: Date.now(),
                data: stripImagesFromHistory(historyData),
                config,
                todos: todoList,
                wishes: wishList,
                strategies: userStrategies,
                timeBank: timeBank,
                timerRecords: timerRecords,
                plannedTasks: plannedTasks,
                dailyReviews: dailyReviews,
                taskUsageCount: taskUsageCount,
                pinnedTaskId: pinnedTaskId
            };
            const body = { message: `Archive ${timestamp}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(content)))) };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { method:'PUT', headers: { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" }, body: JSON.stringify(body) });
            if(res.ok) alert(`âœ… å­˜æ¡£æˆåŠŸï¼\næ–‡ä»¶å: ${path}`);
            else alert("âŒ å­˜æ¡£å¤±è´¥");
        } catch(e) { alert("âŒ å‘ç”Ÿé”™è¯¯"); }

        setSyncBadgeStatus('status-idle', 'æœ¬åœ°æ¨¡å¼');
    }

    async function listCloudBackups() {
        const token = ghConfig.token; const repo = ghConfig.repo;
        if(!token || !repo) return alert("è¯·å…ˆé…ç½® GitHub Token");

        const listEl = document.getElementById('cloudBackupList');
        listEl.style.display = 'block';
        listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">âŒ› æ­£åœ¨åŠ è½½åˆ—è¡¨...</div>';

        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/backups`, { headers });
            if(!res.ok) throw new Error("Fetch failed");

            const files = await res.json();
            if(!Array.isArray(files) || files.length === 0) {
                listEl.innerHTML = '<div style="padding:12px;color:var(--text-sub);">ğŸ“‚ æ— äº‘ç«¯å­˜æ¡£ã€‚</div>';
                return;
            }
            files.sort((a,b) => b.name.localeCompare(a.name));
            listEl.innerHTML = files.map(f => `<div class="backup-file-item" onclick="restoreCloudBackup('${f.path}')"><span>ğŸ“„ ${f.name}</span><span style="font-size:10px; color:var(--info);">æ¢å¤æ­¤ç‰ˆ</span></div>`).join('');
        } catch(e) { listEl.innerHTML = '<div style="padding:12px;color:var(--danger);">âŒ è·å–å¤±è´¥ã€‚</div>'; }
    }

    async function restoreCloudBackup(path) {
        if(!confirm("âš ï¸ ç¡®å®šè¦ä»äº‘ç«¯æ–‡ä»¶ [" + path + "] æ¢å¤æ•°æ®å—ï¼Ÿ")) return;
        const token = ghConfig.token; const repo = ghConfig.repo;
        try {
            const headers = { "Authorization": `Bearer ${token}`, "Accept": "application/vnd.github.v3+json" };
            const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, { headers });
            const d = await res.json();
            const content = JSON.parse(decodeURIComponent(escape(atob(d.content.replace(/\n/g,"")))));
            restoreData(content);
        } catch(e) { alert("âŒ æ¢å¤å¤±è´¥ã€‚"); }
    }

    function renderStrategies() {
        const container = document.getElementById('strategyArea');
        if (!container) return;
        container.innerHTML = '';
        if (!historyData || historyData.length === 0) return;
        const lastRecord = historyData[0];
        if (!lastRecord || !lastRecord.details || !lastRecord.details.penalty_rule) return;
        
        let failedTypes = [];
        if (lastRecord.details.penalty_rule.includes('å°‘å­¦')) failedTypes.push('study');
        if (lastRecord.details.penalty_rule.includes('æ™šèµ·')) failedTypes.push('wake');
        if (lastRecord.details.penalty_rule.includes('æ™šç¡')) failedTypes.push('sleep');

        if (failedTypes.length === 0) return;

        let suggestions = [];
        failedTypes.forEach(type => {
            if (userStrategies[type] && Array.isArray(userStrategies[type])) {
                suggestions = suggestions.concat(userStrategies[type]);
            }
        });

        if (suggestions.length === 0) return;

        const html = `
            <div style="width:100%; font-size:11px; color:var(--text-sub); margin:8px 0 4px 0; font-weight:600;">ğŸ’¡ ç‚¹å‡»å¼•ç”¨è¡¥æ•‘ç­–ç•¥:</div>
            ${suggestions.map(s => `<div class="chip" onclick="fillStrategy('${s}')" style="background:var(--input-bg);border-color:var(--primary);color:var(--primary)">${s}</div>`).join('')}
        `;
        container.innerHTML = html;
    }

    function fillStrategy(txt) {
        const targetIds = ['r_fix', 'f_plan'];
        let target = null;
        for(let id of targetIds) {
            if(document.getElementById(id)) { target = document.getElementById(id); break; }
        }
        if(target) {
            const oldVal = target.value;
            target.value = oldVal ? (oldVal + " + " + txt) : txt;
            target.style.borderColor = 'var(--primary)';
            setTimeout(()=>target.style.borderColor='var(--border)', 300);
        }
    }

    function toggleExpiredFullView() {
        expiredFullView = !expiredFullView;
        renderTodos();
    }

    function toggleTimerFullView() {
        timerFullView = !timerFullView;
        renderTimerHistory();
    }

    function toggleHistoryFullView() {
        historyFullView = !historyFullView;
        updateUI();
    }

    init();
</script>
</body>
</html>
